!function(){"use strict";console.log("[Admin] Build: 2026-02-27T16:51:06.299Z");var e=null,t=null,n=null,a=[],o=null,i=!1,r=[],s=[],d={},c=[],l=[],u=[],m=[],p=[],f=[],h=[],v=[],g=[],b=null,y=[],E={pending:{label:"Pending",description:"Awaiting confirmation",order:1},confirmed:{label:"Confirmed",description:"Appointment scheduled",order:2},brewing:{label:"Brewing",description:"Fermentation in progress",order:3},ready:{label:"Ready",description:"Ready for bottling pickup",order:4},completed:{label:"Completed",description:"Customer has bottled and picked up",order:5},cancelled:{label:"Cancelled",description:"Reservation was cancelled",order:6},archived:{label:"Archived",description:"Hidden from active view",order:7}},k={pending:["confirmed","cancelled"],confirmed:["brewing","cancelled"],brewing:["ready","cancelled"],ready:["completed","cancelled"],completed:["archived"],cancelled:["archived"],archived:["completed"]},_={offset:0,limit:50,total:0,filtered:0,currentFilter:"pending"};function S(e,t,n){t||(t="info"),n||(n={});var a=document.getElementById("admin-toast-container");if(a){var o=document.createElement("div");o.className="admin-toast admin-toast--"+t;var i=document.createElement("span");if(i.className="admin-toast-msg",i.textContent=e,o.appendChild(i),n.undo){var r=document.createElement("button");r.className="admin-toast-undo",r.textContent="Undo",r.addEventListener("click",function(){n.undo(),I(o)}),o.appendChild(r)}var s=document.createElement("button");s.className="admin-toast-close",s.innerHTML="&times;",s.addEventListener("click",function(){I(o)}),o.appendChild(s),a.appendChild(o);var d=n.duration||("error"===t?6e3:3500),c=setTimeout(function(){I(o)},d);o._timer=c}}function I(e){e._removed||(e._removed=!0,clearTimeout(e._timer),e.classList.add("removing"),setTimeout(function(){e.parentNode&&e.parentNode.removeChild(e)},150))}function w(e,t,n){var a=document.createElement("div");a.className="admin-confirm-overlay";var o=document.createElement("div");o.className="admin-confirm-box";var i=document.createElement("div");i.className="admin-confirm-msg",i.textContent=e,o.appendChild(i);var r=document.createElement("div");r.className="admin-confirm-actions";var s=document.createElement("button");s.type="button",s.className="btn-secondary",s.textContent="Cancel",s.addEventListener("click",function(){document.body.removeChild(a),n&&n()});var d=document.createElement("button");d.type="button",d.className="btn",d.textContent="Confirm",d.addEventListener("click",function(){document.body.removeChild(a),t&&t()}),r.appendChild(s),r.appendChild(d),o.appendChild(r),a.appendChild(o),a.addEventListener("click",function(e){e.target===a&&(document.body.removeChild(a),n&&n())}),document.body.appendChild(a),d.focus()}function x(e){var t={pending:0,confirmed:0,brewing:0,ready:0,completed:0};(e||m).forEach(function(e){var n=(e.status||"").toLowerCase().trim()||"pending";t.hasOwnProperty(n)&&t[n]++});var n=document.getElementById("pipeline-stages");if(n){var a=t.pending+t.confirmed+t.brewing+t.ready+t.completed;if(0!==a){var o="",i={pending:"Pending",confirmed:"Confirmed",brewing:"Brewing",ready:"Ready",completed:"Done"};["pending","confirmed","brewing","ready","completed"].forEach(function(e){if(t[e]>0){Math.max(t[e]/a*100,12);o+='<div class="pipeline-stage pipeline-stage--'+e+'" style="flex:'+t[e]+';" data-filter="'+e+'">',o+='<span class="pipeline-stage-count">'+t[e]+"</span>",o+='<span class="pipeline-stage-name">'+i[e]+"</span>",o+="</div>"}}),n.innerHTML=o,n.querySelectorAll(".pipeline-stage").forEach(function(e){e.addEventListener("click",function(){var t=e.getAttribute("data-filter"),n=document.getElementById("res-status-filter");n&&(n.value=t,n.dispatchEvent(new Event("change"))),document.querySelector('[data-tab="reservations"]').click()})})}else n.innerHTML='<div class="pipeline-empty">No active batches</div>'}}function C(e){var t=document.getElementById("attention-list");if(t){var n=[],a=e&&e.pendingReservations||0;e||m.forEach(function(e){"pending"!==(e.status||"").toLowerCase().trim()&&e.status||a++}),a>0&&n.push({text:a+" reservation"+(1!==a?"s":"")+" to confirm",dot:"warning",tab:"reservations",filter:"pending"});var o=e&&e.readyReservations||0;e||m.forEach(function(e){"ready"===(e.status||"").toLowerCase().trim()&&o++}),o>0&&n.push({text:o+" ready for pickup",dot:"success",tab:"reservations",filter:"ready"});var i=e?(e.lowStockKits||[]).length:0;e||r.forEach(function(e){var t=e.sku&&d.hasOwnProperty(e.sku)?d[e.sku]:null,n=t&&null!==t.stock?t.stock:parseInt(e.stock,10)||0,a=parseInt(e.on_hold,10)||0;"true"!==e.hide&&"TRUE"!==e.hide&&n-a<=3&&i++}),i>0&&n.push({text:i+" kit"+(1!==i?"s":"")+" low stock",dot:"danger",tab:"kits"});var s=e?(e.upcomingAppointments||[]).length:0;if(s>0){var c=e.upcomingAppointments[0],l=s+" upcoming appointment"+(1!==s?"s":"");0===c.daysAway?l="Appointment today":1===c.daysAway&&(l="Appointment tomorrow + "+(s-1)+" more"),n.push({text:l,dot:"info",tab:"scheduling"})}var u=e&&e.pendingHolds||0;if(e||f.forEach(function(e){"pending"===(e.status||"").toLowerCase().trim()&&u++}),u>0&&n.push({text:u+" hold"+(1!==u?"s":"")+" to confirm",dot:"warning",tab:"reservations",filter:"pending"}),0!==n.length){var p="";n.forEach(function(e){p+='<div class="attention-item" data-tab="'+e.tab+'"'+(e.filter?' data-filter="'+e.filter+'"':"")+">",p+='<span class="attention-dot attention-dot--'+e.dot+'"></span>',p+=e.text,p+="</div>"}),t.innerHTML=p,t.querySelectorAll(".attention-item").forEach(function(e){e.addEventListener("click",function(){var t=e.getAttribute("data-tab"),n=e.getAttribute("data-filter");if(t&&document.querySelector('[data-tab="'+t+'"]').click(),n){var a=document.getElementById("res-status-filter");a&&(a.value=n,a.dispatchEvent(new Event("change")))}})})}else t.innerHTML='<div class="attention-item"><span class="attention-dot attention-dot--success"></span>All clear — nothing needs attention</div>'}}function L(){"undefined"!=typeof google&&google.accounts&&google.accounts.oauth2?function(){n=google.accounts.oauth2.initTokenClient({client_id:SHEETS_CONFIG.CLIENT_ID,scope:SHEETS_CONFIG.SCOPES+" https://www.googleapis.com/auth/userinfo.email",callback:B}),document.getElementById("admin-signout").addEventListener("click",D),document.getElementById("admin-signout-denied").addEventListener("click",D);var e=function(){try{var e=localStorage.getItem(O);if(!e)return null;var t=JSON.parse(e);return t.expires_at<Date.now()+3e5?null:t}catch(e){return null}}();if(e){console.log("[Admin] Attempting silent token refresh for",e.email);try{n.requestAccessToken({prompt:"",login_hint:e.email})}catch(e){console.warn("[Admin] Silent refresh failed:",e.message),H(),T()}return}T()}():setTimeout(L,100)}function T(){var e=document.getElementById("google-signin-btn");if(e&&!e.querySelector("button")){var t=document.createElement("button");t.type="button",t.className="btn",t.textContent="Sign in with Google",t.addEventListener("click",function(){n.requestAccessToken()}),e.appendChild(t)}}function B(n){if(i=!1,n.error)return console.warn("[Admin] Token response error:",n.error),H(),void T();e=n.access_token;var o=n.expires_in||3600;fetch("https://www.googleapis.com/oauth2/v3/userinfo",{headers:{Authorization:"Bearer "+e}}).then(function(e){return e.json()}).then(function(n){t=n.email,function(e,t,n){var a={token:e,expires_at:Date.now()+1e3*t,email:n};localStorage.setItem(O,JSON.stringify(a))}(e,o,t),function(){if(console.log("[Admin] Checking authorization for:",t),SHEETS_CONFIG.ADMIN_API_URL)return console.log("[Admin] Using server-side auth validation"),void P("check_auth").then(function(e){console.log("[Admin] Server auth result:",e),e.authorized?A():N()}).catch(function(e){console.error("[Admin] Server auth failed:",e.message),N()});console.warn("[Admin] Using client-side auth (ADMIN_API_URL not configured)"),U(SHEETS_CONFIG.SHEET_NAMES.CONFIG+"!A:B").then(function(e){var n=e.values||[];console.log("[Admin] Config sheet rows:",JSON.stringify(n));for(var o=0;o<n.length;o++)if("staff_emails"===n[o][0]){a=(n[o][1]||"").split(",").map(function(e){return e.trim().toLowerCase()});break}console.log("[Admin] Parsed staff emails:",a),console.log("[Admin] User email match:",-1!==a.indexOf(t.toLowerCase())),-1!==a.indexOf(t.toLowerCase())?A():N()}).catch(function(e){console.error("[Admin] Failed to read Config sheet:",e),N()})}()}).catch(function(){N()})}function A(){document.getElementById("admin-signin").style.display="none",document.getElementById("admin-denied").style.display="none",document.getElementById("admin-dashboard").style.display="",document.getElementById("admin-user-email").textContent=t;var e=document.getElementById("admin-signout");e&&(e.style.display=""),localStorage.setItem("sv-admin-email",t),z(),fetch("content/email-templates.json").then(function(e){return e.json()}).then(function(e){se=e}).catch(function(){se=null}),function(){var e=new URLSearchParams(window.location.search).get("tab");if(e){var t=document.querySelector('.admin-tab-btn[data-tab="'+e+'"]');t&&t.click()}}(),o&&clearInterval(o),o=setInterval(function(){n.requestAccessToken({prompt:""})},3e6)}function N(){document.getElementById("admin-signin").style.display="none",document.getElementById("admin-denied").style.display="",document.getElementById("admin-dashboard").style.display="none"}document.addEventListener("DOMContentLoaded",function(){var e=document.querySelector(".nav-toggle"),t=document.querySelector(".nav-list");e&&t&&e.addEventListener("click",function(){t.classList.toggle("open")});var n,a=document.body.getAttribute("data-page");a&&fetch("content/"+a+".json").then(function(e){return e.json()}).then(function(e){document.querySelectorAll("[data-content]").forEach(function(t){var n=t.getAttribute("data-content");void 0!==e[n]&&(t.textContent=e[n])})}).catch(function(){}),J(),function(){var e=document.getElementById("admin-modal"),t=document.getElementById("admin-modal-overlay"),n=document.getElementById("admin-modal-close");function a(){e.style.display="none"}t&&t.addEventListener("click",a);n&&n.addEventListener("click",a)}(),document.addEventListener("DOMContentLoaded",function(){var e=document.getElementById("export-kits-btn");e&&e.addEventListener("click",et);var t=document.getElementById("export-ingredients-btn");t&&t.addEventListener("click",tt);var n=document.getElementById("export-ws-btn");n&&n.addEventListener("click",nt)}),document.addEventListener("DOMContentLoaded",function(){var e=document.getElementById("import-csv-input");e&&e.addEventListener("change",it);var t=document.getElementById("import-apply-btn");t&&t.addEventListener("click",rt);var n=document.getElementById("import-cancel-btn");n&&n.addEventListener("click",st)}),function(){var e=document.getElementById("res-status-filter");e&&e.addEventListener("change",function(){_.offset=0,_.currentFilter=this.value,SHEETS_CONFIG.ADMIN_API_URL?V().then(function(){ne()}).catch(function(e){console.error("Failed to load filtered reservations:",e)}):ne()});var t,n=document.getElementById("kit-search");n&&n.addEventListener("input",function(){clearTimeout(t),t=setTimeout(pe,300)});var a=document.getElementById("kit-brand-filter");a&&a.addEventListener("change",pe);var o=document.getElementById("kit-stock-filter");o&&o.addEventListener("change",pe);!function(){var e=document.querySelector("#kits-table thead tr");if(!e)return;e.querySelectorAll("th").forEach(function(e){var t=e.textContent.trim(),n=me[t];n&&(e.className="sortable",e.setAttribute("data-sort-key",n),n===le&&e.classList.add("asc"===ue?"sort-asc":"sort-desc"),e.addEventListener("click",function(){le===n?ue="asc"===ue?"desc":"asc":(le=n,ue="asc"),pe()}))})}();var i=document.getElementById("ing-type-filter");i&&i.addEventListener("change",ye);!function(){var e,t=document.getElementById("order-search");t&&t.addEventListener("input",function(){clearTimeout(e),e=setTimeout(Ne,300)});var n=document.getElementById("order-brand-filter");n&&n.addEventListener("change",Ne);!function(){var e=document.querySelector("#order-table thead tr");if(!e)return;e.querySelectorAll("th").forEach(function(e){var t=e.textContent.trim(),n=_e[t];n&&(e.className="sortable",e.setAttribute("data-sort-key",n),n===Ee&&e.classList.add("asc"===ke?"sort-asc":"sort-desc"),e.addEventListener("click",function(){Ee===n?ke="asc"===ke?"desc":"asc":(Ee=n,ke="asc"),Ne()}))})}()}()}(),function(){var e=document.getElementById("admin-save-btn"),t=document.getElementById("admin-discard-btn");e&&e.addEventListener("click",ge);t&&t.addEventListener("click",be)}(),function(){!function(){var e=document.getElementById("order-kit-search"),t=document.getElementById("order-kit-dropdown"),n=document.getElementById("order-kit-select");if(!e||!t||!n)return;var a=-1;function o(e){console.log("[Order] renderDropdown called, query:",e,"options count:",qe.length);var n=(e||"").toLowerCase(),o=qe.filter(function(e){return!n||-1!==e.label.toLowerCase().indexOf(n)});console.log("[Order] matches:",o.length),t.innerHTML="",a=-1,0!==o.length?(o.forEach(function(e,n){var a=document.createElement("div");a.className="admin-kit-search-option",a.textContent=e.label,a.setAttribute("data-index",n),a.addEventListener("mousedown",function(t){t.preventDefault(),i(e)}),t.appendChild(a)}),t.style.display="block"):t.style.display="none"}function i(a){e.value=a.label,n.value=a.sku,n.setAttribute("data-brand",a.brand),n.setAttribute("data-name",a.name),t.style.display="none";var o=document.getElementById("order-kit-qty");o&&Le(a.brand)?(o.value="2",o.step="2",o.min="2"):o&&(o.value="1",o.step="1",o.min="1")}function r(e){var n=t.querySelectorAll(".admin-kit-search-option");n.forEach(function(e){e.classList.remove("active")}),e>=0&&e<n.length&&(n[e].classList.add("active"),n[e].scrollIntoView({block:"nearest"}))}e.addEventListener("focus",function(){n.value="",o(e.value)}),e.addEventListener("input",function(){n.value="",o(e.value)}),e.addEventListener("blur",function(){setTimeout(function(){t.style.display="none"},150)}),e.addEventListener("keydown",function(n){var o=t.querySelectorAll(".admin-kit-search-option");if("ArrowDown"===n.key)n.preventDefault(),r(a=Math.min(a+1,o.length-1));else if("ArrowUp"===n.key)n.preventDefault(),r(a=Math.max(a-1,0));else if("Enter"===n.key){if(n.preventDefault(),a>=0&&a<o.length){var s=(e.value||"").toLowerCase(),d=qe.filter(function(e){return!s||-1!==e.label.toLowerCase().indexOf(s)});d[a]&&i(d[a])}}else"Escape"===n.key&&(t.style.display="none",e.blur())})}();var e=document.getElementById("order-add-btn");e&&e.addEventListener("click",function(){var e=document.getElementById("order-kit-select"),t=document.getElementById("order-kit-search"),n=document.getElementById("order-kit-qty"),a=e.value;if(a){var o=parseInt(n.value,10)||1;Be(a,e.getAttribute("data-brand")||"",e.getAttribute("data-name")||"",o),e.value="",t.value="",n.value="1"}else S("Type and select a kit first.","warning")});var t=document.getElementById("order-copy-btn");t&&t.addEventListener("click",Fe);var n=document.getElementById("order-create-po-btn");n&&n.addEventListener("click",Me);var a=document.getElementById("po-refresh-btn");a&&a.addEventListener("click",De);var o=document.getElementById("order-accept-btn");o&&o.addEventListener("click",Pe);var i=document.getElementById("order-clear-btn");i&&i.addEventListener("click",Re);var s=document.getElementById("order-import-btn"),d=document.getElementById("order-import-file");s&&d&&(s.addEventListener("click",function(){d.click()}),d.addEventListener("change",function(){var e,t;d.files.length>0&&(e=d.files[0],(t=new FileReader).onload=function(e){var t=e.target.result.split(/\r?\n/).filter(function(e){return""!==e.trim()});if(t.length<2)S("CSV must have a header row and at least one data row.","warning");else{var n=dt(t[0]).map(function(e){return e.trim().toLowerCase()}),a=n.indexOf("sku"),o=n.indexOf("qty");if(-1!==a&&-1!==o){for(var i=0,s=[],d=1;d<t.length;d++){var c=dt(t[d]),l=(c[a]||"").trim(),u=parseInt(c[o],10);if(!(!l||isNaN(u)||u<=0)){var m=r.find(function(e){return e.sku===l});m?(Be(l,m.brand,m.name,u),i++):s.push(l)}}var p=i+" item(s) added to order.";s.length>0&&(p+="\n"+s.length+" skipped (unrecognized SKUs: "+s.join(", ")+")"),S(p,"success")}else S('CSV must have "SKU" and "Qty" columns.',"warning")}},t.readAsText(e)),d.value=""}))}(),(n=document.getElementById("schedule-save-defaults-btn"))&&n.addEventListener("click",function(){je(function(){var e=document.getElementById("schedule-defaults-tbody");if(!e)return Ge();var t=Ge();return e.querySelectorAll("select").forEach(function(e){var n=parseInt(e.dataset.idx,10),a=e.dataset.field;t[n][a]=e.value,t[n].start&&t[n].end&&(t[n].open=!0)}),t}()),S("Default schedule saved.","success")}),L(),Ne()});var O="sv-admin-session";function H(){localStorage.removeItem(O),localStorage.removeItem("sv-admin-email")}function D(){o&&(clearInterval(o),o=null),e&&google.accounts.oauth2.revoke(e),e=null,t=null,H(),document.getElementById("admin-signin").style.display="",document.getElementById("admin-denied").style.display="none",document.getElementById("admin-dashboard").style.display="none";var n=document.getElementById("admin-signout");n&&(n.style.display="none"),document.getElementById("admin-user-email").textContent=""}function M(e,t,n){return void 0===n&&(n=1),fetch(e,t).catch(function(a){if(n>0)return new Promise(function(e){setTimeout(e,1e3)}).then(function(){return M(e,t,n-1)});throw a})}function q(e){var t=((e.message||e.error||"")+"").toLowerCase();return-1!==t.indexOf("unauthorized")||-1!==t.indexOf("not authorized")}function F(){if(!i){i=!0,o&&(clearInterval(o),o=null),H(),e=null,t=null,document.getElementById("admin-signin").style.display="",document.getElementById("admin-dashboard").style.display="none",document.getElementById("admin-denied").style.display="none";var n=document.getElementById("admin-signout");n&&(n.style.display="none"),document.getElementById("admin-user-email").textContent="",T()}}function P(t,n){if(!SHEETS_CONFIG.ADMIN_API_URL)return Promise.reject(new Error("Admin API not configured"));var a=SHEETS_CONFIG.ADMIN_API_URL+"?action="+encodeURIComponent(t)+"&token="+encodeURIComponent(e);return n&&Object.keys(n).forEach(function(e){a+="&"+encodeURIComponent(e)+"="+encodeURIComponent(n[e])}),M(a,{method:"GET"}).then(function(e){return e.json()}).then(function(e){if(!e.ok)throw q(e)&&F(),new Error(e.message||e.error||"API error");return e})}function R(t,n){return SHEETS_CONFIG.ADMIN_API_URL?(n.action=t,n.token=e,M(SHEETS_CONFIG.ADMIN_API_URL,{method:"POST",headers:{"Content-Type":"text/plain"},body:JSON.stringify(n)}).then(function(e){return e.json()}).then(function(e){if(!e.ok)throw q(e)&&F(),new Error(e.message||e.error||"API error");return e})):Promise.reject(new Error("Admin API not configured"))}function U(t){return M("https://sheets.googleapis.com/v4/spreadsheets/"+SHEETS_CONFIG.SPREADSHEET_ID+"/values/"+encodeURIComponent(t),{headers:{Authorization:"Bearer "+e}}).then(function(e){if(!e.ok)throw new Error("Sheets API error: "+e.status);return e.json()})}function G(t,n){return(SHEETS_CONFIG.ADMIN_API_URL?P("check_auth").then(function(e){if(!e.authorized)throw new Error("Not authorized to make changes")}):Promise.resolve()).then(function(){return M("https://sheets.googleapis.com/v4/spreadsheets/"+SHEETS_CONFIG.SPREADSHEET_ID+"/values/"+encodeURIComponent(t)+"?valueInputOption=USER_ENTERED",{method:"PUT",headers:{Authorization:"Bearer "+e,"Content-Type":"application/json"},body:JSON.stringify({values:n})}).then(function(e){if(!e.ok)throw new Error("Sheets API error: "+e.status);return e.json()})})}function j(t,n){return(SHEETS_CONFIG.ADMIN_API_URL?P("check_auth").then(function(e){if(!e.authorized)throw new Error("Not authorized to make changes")}):Promise.resolve()).then(function(){return M("https://sheets.googleapis.com/v4/spreadsheets/"+SHEETS_CONFIG.SPREADSHEET_ID+"/values/"+encodeURIComponent(t)+":append?valueInputOption=USER_ENTERED&insertDataOption=INSERT_ROWS",{method:"POST",headers:{Authorization:"Bearer "+e,"Content-Type":"application/json"},body:JSON.stringify({values:n})}).then(function(e){if(!e.ok)throw new Error("Sheets API error: "+e.status);return e.json()})})}function z(){_.offset=0,_.currentFilter=document.getElementById("res-status-filter")?.value||"pending",SHEETS_CONFIG.ADMIN_API_URL?Promise.all([P("get_kits"),V(),P("get_holds"),P("get_schedule"),P("get_dashboard_summary")]).then(function(e){return Z(e[0].data,"kits"),Z(e[2].data,"holds"),Z(e[3].data,"schedule"),b=e[4].data||null,U(SHEETS_CONFIG.SHEET_NAMES.INGREDIENTS+"!A:Z")}).then(function(e){Z(e,"ingredients"),W()}).catch(function(e){console.error("Failed to load data via Admin API:",e),S("Failed to load data: "+e.message,"error")}):Promise.all([U(SHEETS_CONFIG.SHEET_NAMES.KITS+"!A:Z"),U(SHEETS_CONFIG.SHEET_NAMES.INGREDIENTS+"!A:Z"),U(SHEETS_CONFIG.SHEET_NAMES.RESERVATIONS+"!A:Z"),U(SHEETS_CONFIG.SHEET_NAMES.HOLDS+"!A:Z"),U(SHEETS_CONFIG.SHEET_NAMES.SCHEDULE+"!A:Z")]).then(function(e){Z(e[0],"kits"),Z(e[1],"ingredients"),Z(e[2],"reservations"),Z(e[3],"holds"),Z(e[4],"schedule"),_.total=m.length,_.filtered=m.length,W()}).catch(function(e){console.error("Failed to load data:",e)})}function V(){return SHEETS_CONFIG.ADMIN_API_URL?P("get_reservations",{limit:_.limit,offset:_.offset,status:_.currentFilter}).then(function(e){return Z(e.data,"reservations"),_.total=e.data.total||0,_.filtered=e.data.filtered||0,e}):Promise.resolve({data:{values:[]}})}function K(e){var t=_.offset+e*_.limit;t<0&&(t=0),t>=_.filtered||(_.offset=t,V().then(function(){ne()}).catch(function(e){console.error("Failed to load reservations page:",e)}))}function W(){var e="undefined"!=typeof SHEETS_CONFIG&&SHEETS_CONFIG.MIDDLEWARE_URL?SHEETS_CONFIG.MIDDLEWARE_URL:"";function t(){$(),ne(),pe(),ye(),function(){ze(),Ze||(Ze=new Date).setDate(1);Qe()}(),function(){var e=document.getElementById("kit-brand-filter");if(!e)return;var t=[];r.forEach(function(e){e.brand&&-1===t.indexOf(e.brand)&&t.push(e.brand)}),t.sort();for(;e.options.length>1;)e.remove(1);t.forEach(function(t){var n=document.createElement("option");n.value=t,n.textContent=t,e.appendChild(n)})}(),qe=r.map(function(e){return{sku:e.sku||"",brand:e.brand||"",name:e.name||"",label:(e.brand||"")+" — "+(e.name||"")+" ("+(e.sku||"")+")"}}),function(){if(0===r.length)return;var e=[];r.forEach(function(t){var n=parseInt(t.on_order,10)||0;n>0&&t.sku&&e.push({sku:t.sku,brand:t.brand||"",name:t.name||"",qty:n})}),e.length>0&&(xe(e),Se(),Ne(),console.log("[Admin] Loaded "+e.length+" item(s) from sheet on_order column"))}(),Se(),Ne(),U(SHEETS_CONFIG.SHEET_NAMES.HOMEPAGE+"!A:E").then(function(e){var t=e.values||[];t.length>0&&t[0],ct["promo-news"]=[],ct["promo-featured-skus"]=[],ct["social-instagram"]="",ct["social-facebook"]="",ct.faq=[];for(var n=1;n<t.length;n++){var a=t[n],o=(a[0]||"").toLowerCase();if("news"===o)ct["promo-news"].push({date:a[1]||"",title:a[2]||"",text:a[3]||""});else if("featured"===o){var i=a[4]||"",r=a[3]||"";i&&ct["promo-featured-skus"].push({sku:i,description:r})}else if("instafeed"===o)ct["instafeed-url"]=a[3]||"";else if("social"===o){var s=(a[2]||"").toLowerCase().trim(),d=a[4]||"";"instagram"===s?ct["social-instagram"]=d:"facebook"===s&&(ct["social-facebook"]=d)}else"faq"===o&&ct.faq.push({question:a[2]||"",answer:a[3]||""})}mt(),pt(),ft();var c=document.getElementById("homepage-instafeed-url");c&&(c.value=ct["instafeed-url"]||"");var l=document.getElementById("homepage-social-instagram");l&&(l.value=ct["social-instagram"]||"");var u=document.getElementById("homepage-social-facebook");u&&(u.value=ct["social-facebook"]||"")}).catch(function(e){console.error("[Homepage] Error loading from sheet:",e)})}e?fetch(e+"/api/products").then(function(e){return e.ok?e.json():{items:[]}}).then(function(e){var t={};(e.items||[]).forEach(function(e){e.sku&&(t[e.sku]={stock:null!=e.stock_on_hand?parseInt(e.stock_on_hand,10):null,rate:null!=e.rate?parseFloat(e.rate):null,item_id:e.item_id||"",vendor_id:e.vendor_id||"",vendor_name:e.vendor_name||""})}),d=t}).catch(function(){d={};var e=document.getElementById("zoho-sync-banner");e&&(e.style.display="")}).then(t):t()}function $(){b?function(e){document.getElementById("dash-reservations-today").textContent=e.reservationsToday||0,document.getElementById("dash-reservations-week").textContent=e.totalActiveReservations+" active total";var t=e.pendingReservations||0,n=e.readyReservations||0,a=e.pendingHolds||0,o=t+n+a;document.getElementById("dash-pending-actions").textContent=o;var i=[];t>0&&i.push(t+" to confirm");n>0&&i.push(n+" ready for pickup");a>0&&i.push(a+" hold"+(1!==a?"s":""));document.getElementById("dash-pending-detail").textContent=i.join(", ")||"No pending actions";var r=e.lowStockKits||[];document.getElementById("dash-low-stock").textContent=r.length;var s=document.querySelector(".dashboard-card--stock .dashboard-card-value");if(0===r.length)document.getElementById("dash-low-stock-detail").textContent="All items well stocked",s&&(s.style.color="#388e3c");else{s&&(s.style.color="");var d=r.slice(0,2).map(function(e){return e.name+" ("+e.stock+")"}).join(", ");r.length>2&&(d+=" +"+(r.length-2)+" more"),document.getElementById("dash-low-stock-detail").innerHTML=d+' <a id="dash-low-stock-link">View all</a>',document.getElementById("dash-low-stock-link").addEventListener("click",function(){document.querySelector('[data-tab="kits"]').click()})}var c=e.upcomingAppointments||[];if(document.getElementById("dash-upcoming-appts").textContent=c.length,c.length>0){var l=c[0],u="Next: "+l.date;0===l.daysAway?u="Today: "+l.name:1===l.daysAway&&(u="Tomorrow: "+l.name),document.getElementById("dash-upcoming-detail").textContent=u}else document.getElementById("dash-upcoming-detail").textContent="None in next 7 days";x(null),C(e)}(b):function(){var e=new Date,t=kt(),n=new Date(e);n.setDate(n.getDate()-7);var a=new Date(e);a.setDate(a.getDate()+7);var o=0,i=0;m.forEach(function(e){var a=e.submitted_at||"";a.split("T")[0]===t&&o++,a&&new Date(a)>=n&&i++}),document.getElementById("dash-reservations-today").textContent=o,document.getElementById("dash-reservations-week").textContent=i+" this week";var s=0,c=0,l=0;m.forEach(function(e){var t=(e.status||"").toLowerCase().trim()||"pending";"pending"===t&&s++,"ready"===t&&c++}),f.forEach(function(e){"pending"===((e.status||"").toLowerCase().trim()||"pending")&&l++});var u=s+c+l;document.getElementById("dash-pending-actions").textContent=u;var p=[];s>0&&p.push(s+" to confirm");c>0&&p.push(c+" ready for pickup");l>0&&p.push(l+" hold"+(1!==l?"s":""));document.getElementById("dash-pending-detail").textContent=p.join(", ")||"No pending actions";var h=3,v=[];if(r.forEach(function(e){var t=e.sku&&d.hasOwnProperty(e.sku)?d[e.sku]:null,n=t&&null!==t.stock?t.stock:parseInt(e.stock,10)||0,a=parseInt(e.on_hold,10)||0,o=n-a;"true"!==e.hide&&"TRUE"!==e.hide&&o<=h&&v.push({name:e.name,brand:e.brand,available:o,stock:n,onHold:a})}),document.getElementById("dash-low-stock").textContent=v.length,0===v.length)document.getElementById("dash-low-stock-detail").textContent="All items well stocked",document.querySelector(".dashboard-card--stock .dashboard-card-value").style.color="#388e3c";else{var g=v.slice(0,2).map(function(e){return(e.brand?e.brand+" ":"")+e.name+" ("+e.available+")"}).join(", ");v.length>2&&(g+=" +"+(v.length-2)+" more"),document.getElementById("dash-low-stock-detail").innerHTML=g+' <a id="dash-low-stock-link">View all</a>',document.getElementById("dash-low-stock-link").addEventListener("click",function(){document.querySelector('[data-tab="kits"]').click()})}var b=0,y=null,E=["pending","confirmed","brewing"];if(m.forEach(function(t){var n=(t.status||"").toLowerCase().trim()||"pending";if(-1!==E.indexOf(n)){var o=function(e){if(!e)return null;var t=e.match(/(\w+)\s+(\w+)\s+(\d+)/);if(t){var n=["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"],a=t[2].toLowerCase().substring(0,3),o=n.indexOf(a),i=parseInt(t[3],10);if(-1!==o&&i){var r=(new Date).getFullYear(),s=new Date(r,o,i);return s<new Date&&s.setFullYear(r+1),s}}var d=e.match(/(\d{4})-(\d{2})-(\d{2})/);if(d)return new Date(d[1],parseInt(d[2],10)-1,d[3]);var c=new Date(e);if(!isNaN(c.getTime()))return c;return null}(t.timeslot||"");o&&o>=e&&o<=a&&(b++,(!y||o<y)&&(y=o))}}),document.getElementById("dash-upcoming-appts").textContent=b,b>0&&y){var k=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][y.getDay()],_=y.toLocaleDateString("en-US",{month:"short",day:"numeric"});document.getElementById("dash-upcoming-detail").textContent="Next: "+k+" "+_}else document.getElementById("dash-upcoming-detail").textContent="None in next 7 days";x(null),C(null)}()}function Z(e,t){var n=e.values||[];if(0!==n.length){for(var a=n[0],o=[],i=1;i<n.length;i++){for(var d={},c=0;c<a.length;c++)d[a[c]]=n[i][c]||"";d._rowIndex=i+1,o.push(d)}switch(t){case"kits":s=a,r=o;break;case"ingredients":u=a,l=o;break;case"reservations":p=a,m=o;break;case"holds":h=a,f=o;break;case"schedule":g=a,v=o}}}function J(){var e=document.querySelectorAll(".admin-tab-btn");e.forEach(function(t){t.addEventListener("click",function(){e.forEach(function(e){e.classList.remove("active")}),t.classList.add("active"),document.querySelectorAll(".admin-tab-panel").forEach(function(e){e.classList.remove("active")});var n=document.getElementById("tab-"+t.getAttribute("data-tab"));n&&n.classList.add("active"),"orders"===t.getAttribute("data-tab")&&De()})})}var Q=[];function Y(e,t){ee(),document.getElementById("admin-modal-title").textContent=e,document.getElementById("admin-modal-body").innerHTML=t,document.getElementById("admin-modal").style.display=""}function X(){document.getElementById("admin-modal").style.display="none",ee()}function ee(){for(var e=0;e<Q.length;e++)try{Q[e]()}catch(e){}Q=[]}function te(e,t){document.addEventListener(e,t),Q.push(function(){document.removeEventListener(e,t)})}function ne(){var e=document.getElementById("reservations-tbody"),n=document.getElementById("reservations-empty");if(e){var a=document.getElementById("res-status-filter").value,o=m;if(SHEETS_CONFIG.ADMIN_API_URL||((o="all"===a?m:"active"===a?m.filter(function(e){var t=(e.status||"").toLowerCase().trim();return t||(t="pending"),"archived"!==t}):m.filter(function(e){var t=(e.status||"").toLowerCase().trim();return t||(t="pending"),t===a})).sort(function(e,t){return(t.submitted_at||"").localeCompare(e.submitted_at||"")}),_.filtered=o.length),e.innerHTML="",0===o.length)return n.style.display="",document.getElementById("reservations-table").style.display="none",void ae();n.style.display="none",document.getElementById("reservations-table").style.display="",o.forEach(function(n){var a=f.filter(function(e){return e.reservation_id===n.reservation_id}),o=document.createElement("tr");o.className="admin-res-row";var i=document.createElement("td"),d=document.createElement("button");d.type="button",d.className="admin-expand-btn",d.textContent=a.length>0?"+":"",d.setAttribute("aria-expanded","false"),i.appendChild(d),o.appendChild(i),oe(o,n.reservation_id);var c=document.createElement("td"),l=document.createElement("span");if(l.className="res-cell-primary",l.textContent=n.customer_name||"",c.appendChild(l),n.customer_email){var u=document.createElement("span");u.className="res-cell-secondary",u.textContent=n.customer_email,c.appendChild(u)}if(n.customer_phone){var m=document.createElement("span");m.className="res-cell-secondary",m.textContent=n.customer_phone,c.appendChild(m)}o.appendChild(c);var v=document.createElement("td");(n.products||"").split(",").forEach(function(e,t){var n=e.trim();if(n){var a=document.createElement("span");a.className="res-cell-line",a.textContent=n,v.appendChild(a)}}),o.appendChild(v);var g=document.createElement("td"),b=(n.timeslot||"").trim(),y=b.indexOf(" ");if(y>0){var _=document.createElement("span");_.className="res-cell-primary",_.textContent=b.substring(0,y),g.appendChild(_);var I=document.createElement("span");I.className="res-cell-secondary",I.textContent=b.substring(y+1),g.appendChild(I)}else g.textContent=b;o.appendChild(g);var w=document.createElement("td"),x=document.createElement("span"),C=(n.status||"").trim().toLowerCase()||"pending";E[C]||(C="pending"),x.className="hold-badge hold-badge--"+C,x.textContent=E[C].label,x.title=E[C].description,w.appendChild(x),o.appendChild(w),oe(o,n.submitted_at||"");var L,T=document.createElement("td");if(T.className="res-actions",n.customer_email){var B=document.createElement("button");B.type="button",B.className="btn admin-btn-sm",B.textContent="Email",B.addEventListener("click",(L=n,function(){ce(L)})),T.appendChild(B)}var A=k[C]||[];if(A.length>0){var N=document.createElement("select");N.className="admin-select admin-status-select";var O=document.createElement("option");O.value="",O.textContent="Change status...",N.appendChild(O),A.forEach(function(e){var t=document.createElement("option");t.value=e,t.textContent="→ "+E[e].label,N.appendChild(t)}),N.addEventListener("change",function(e,t,n){return function(){var a=this.value;if(a){var o='Change status to "'+E[a].label+'"';o+="cancelled"===a?"? This will cancel the reservation.":"archived"===a?"? It will be hidden from the active list.":"?",confirm(o)?(function(e,t){var n=p.indexOf("status");if(-1===n)return void S("Cannot find status column.","warning");if(SHEETS_CONFIG.ADMIN_API_URL)return void R("update_reservation",{reservationId:e.reservation_id,expectedVersion:e.last_updated||null,updates:{status:t}}).then(function(n){e.status=t,n.newVersion&&(e.last_updated=n.newVersion),ne(),$()}).catch(function(e){e.message&&-1!==e.message.indexOf("modified by another user")?confirm(e.message+"\n\nWould you like to refresh the data now?")&&z():S("Failed to update reservation: "+e.message,"error")});var a=SHEETS_CONFIG.SHEET_NAMES.RESERVATIONS+"!"+ht(n)+e._rowIndex;G(a,[[t]]).then(function(){e.status=t;var n=p.indexOf("last_updated");if(-1!==n){var a=(new Date).toISOString();G(SHEETS_CONFIG.SHEET_NAMES.RESERVATIONS+"!"+ht(n)+e._rowIndex,[[a]]),e.last_updated=a}ne(),$()}).catch(function(e){S("Failed to update reservation: "+e.message,"error")})}(e,a),"confirmed"===a&&"pending"===n&&t.length>0&&function(e,t){var n=t.filter(function(e){return"pending"===(e.status||"").toLowerCase()});if(0===n.length)return;var a=Promise.resolve();n.forEach(function(t){a=a.then(function(){return new Promise(function(n){ie(t,e),setTimeout(n,200)})})})}(e,t)):this.value=""}}}(n,a,C)),T.appendChild(N)}o.appendChild(T),e.appendChild(o);var H,D,M=[];a.forEach(function(a){var o=document.createElement("tr");o.className="admin-hold-row",o.style.display="none",oe(o,""),oe(o,a.hold_id||"");var i=document.createElement("td"),d=document.createElement("span");if(d.className="res-cell-primary",d.textContent=a.product_name||"",i.appendChild(d),a.sku){var c=document.createElement("span");c.className="res-cell-secondary",c.textContent="SKU: "+a.sku,i.appendChild(c)}o.appendChild(i),oe(o,"Qty: "+(a.qty||"")),oe(o,"");var l=document.createElement("td"),u=document.createElement("span");u.className="hold-badge hold-badge--"+(a.status||"pending").toLowerCase(),u.textContent=a.status||"pending",l.appendChild(u),o.appendChild(l),oe(o,a.created_at||"");var m,p,f=document.createElement("td");if("pending"===(a.status||"").toLowerCase()){var v=document.createElement("button");v.type="button",v.className="btn admin-btn-sm",v.textContent="Confirm",v.addEventListener("click",(m=a,p=n,function(){ie(m,p)})),f.appendChild(v);var g=document.createElement("button");g.type="button",g.className="btn-secondary admin-btn-sm",g.textContent="Release",g.addEventListener("click",function(e,n){return function(){!function(e,n){var a=parseInt(e.qty,10)||0,o=e._rowIndex,i=r.find(function(t){return t.sku===e.sku});if(SHEETS_CONFIG.ADMIN_API_URL){var d=(new Date).toISOString();return void R("update_hold",{holdId:e.hold_id,expectedVersion:e.last_updated||null,updates:{status:"released",resolved_at:d,resolved_by:t}}).then(function(n){if(e.status="released",e.resolved_at=d,e.resolved_by=t,n.newVersion&&(e.last_updated=n.newVersion),i)return function(e,t){var n=s.indexOf("on_hold");if(-1!==n){var a=Math.max(0,(parseInt(e.on_hold,10)||0)-t),o=SHEETS_CONFIG.SHEET_NAMES.KITS+"!"+ht(n)+e._rowIndex;return e.on_hold=String(a),G(o,[[a]])}return Promise.resolve()}(i,a)}).then(function(){re(n),ne(),pe(),$()}).catch(function(e){e.message&&-1!==e.message.indexOf("modified by another user")?confirm(e.message+"\n\nWould you like to refresh the data now?")&&z():S("Failed to release hold: "+e.message,"error")})}var c=[],l=h.indexOf("status"),u=h.indexOf("resolved_at"),m=h.indexOf("resolved_by"),p=h.indexOf("last_updated");-1!==l&&c.push(G(SHEETS_CONFIG.SHEET_NAMES.HOLDS+"!"+ht(l)+o,[["released"]]));-1!==u&&c.push(G(SHEETS_CONFIG.SHEET_NAMES.HOLDS+"!"+ht(u)+o,[[(new Date).toISOString()]]));-1!==m&&c.push(G(SHEETS_CONFIG.SHEET_NAMES.HOLDS+"!"+ht(m)+o,[[t]]));-1!==p&&c.push(G(SHEETS_CONFIG.SHEET_NAMES.HOLDS+"!"+ht(p)+o,[[(new Date).toISOString()]]));if(i){var f=s.indexOf("on_hold");if(-1!==f){var v=Math.max(0,(parseInt(i.on_hold,10)||0)-a);c.push(G(SHEETS_CONFIG.SHEET_NAMES.KITS+"!"+ht(f)+i._rowIndex,[[v]])),i.on_hold=String(v)}}Promise.all(c).then(function(){e.status="released",e.resolved_at=(new Date).toISOString(),e.resolved_by=t,e.last_updated=(new Date).toISOString(),re(n),ne(),pe(),$()}).catch(function(e){S("Failed to release hold: "+e.message,"error")})}(e,n)}}(a,n)),f.appendChild(g)}o.appendChild(f),M.push(o),e.appendChild(o)}),d.addEventListener("click",(H=M,D=d,function(){var e="true"===D.getAttribute("aria-expanded");D.setAttribute("aria-expanded",String(!e)),D.textContent=e?"+":"−",H.forEach(function(t){t.style.display=e?"none":""})}))}),ae()}}function ae(){var e=document.getElementById("reservations-pagination");if(e){var t=_.filtered,n=_.limit,a=_.offset,o=Math.ceil(t/n),i=Math.floor(a/n)+1;if(o<=1)e.innerHTML=t>0?'<span class="pagination-info">'+t+" reservation"+(1!==t?"s":"")+"</span>":"";else{var r='<div class="pagination-controls">';r+='<button type="button" class="btn-secondary pagination-btn" '+(i<=1?"disabled":"")+' data-page="prev">&larr; Previous</button>',r+='<span class="pagination-info">'+(a+1)+"–"+Math.min(a+n,t)+" of "+t+"</span>",r+='<button type="button" class="btn-secondary pagination-btn" '+(i>=o?"disabled":"")+' data-page="next">Next &rarr;</button>',r+="</div>",e.innerHTML=r,e.querySelectorAll(".pagination-btn").forEach(function(e){e.addEventListener("click",function(){var e=this.getAttribute("data-page");"prev"===e?K(-1):"next"===e&&K(1)})})}}}function oe(e,t){var n=document.createElement("td");n.textContent=t,e.appendChild(n)}function ie(e,n){var a=parseInt(e.qty,10)||0,o=e._rowIndex,i=r.find(function(t){return t.sku===e.sku});if(SHEETS_CONFIG.ADMIN_API_URL){var d=(new Date).toISOString();R("update_hold",{holdId:e.hold_id,expectedVersion:e.last_updated||null,updates:{status:"confirmed",resolved_at:d,resolved_by:t}}).then(function(n){if(e.status="confirmed",e.resolved_at=d,e.resolved_by=t,n.newVersion&&(e.last_updated=n.newVersion),i)return function(e,t){var n=[],a=s.indexOf("stock"),o=s.indexOf("on_hold");if(-1!==a){var i=Math.max(0,(parseInt(e.stock,10)||0)-t),r=SHEETS_CONFIG.SHEET_NAMES.KITS+"!"+ht(a)+e._rowIndex;n.push(G(r,[[i]])),e.stock=String(i)}if(-1!==o){var d=Math.max(0,(parseInt(e.on_hold,10)||0)-t),c=SHEETS_CONFIG.SHEET_NAMES.KITS+"!"+ht(o)+e._rowIndex;n.push(G(c,[[d]])),e.on_hold=String(d)}return Promise.all(n)}(i,a)}).then(function(){re(n),ne(),pe(),$()}).catch(function(e){e.message&&-1!==e.message.indexOf("modified by another user")?confirm(e.message+"\n\nWould you like to refresh the data now?")&&z():S("Failed to confirm hold: "+e.message,"error")})}else{var c=[],l=h.indexOf("status"),u=h.indexOf("resolved_at"),m=h.indexOf("resolved_by"),p=h.indexOf("last_updated");if(-1!==l){var f=SHEETS_CONFIG.SHEET_NAMES.HOLDS+"!"+ht(l)+o;c.push(G(f,[["confirmed"]]))}if(-1!==u){var v=SHEETS_CONFIG.SHEET_NAMES.HOLDS+"!"+ht(u)+o;c.push(G(v,[[(new Date).toISOString()]]))}if(-1!==m){var g=SHEETS_CONFIG.SHEET_NAMES.HOLDS+"!"+ht(m)+o;c.push(G(g,[[t]]))}if(-1!==p){var b=SHEETS_CONFIG.SHEET_NAMES.HOLDS+"!"+ht(p)+o;c.push(G(b,[[(new Date).toISOString()]]))}if(i){var y=s.indexOf("stock"),E=s.indexOf("on_hold");if(-1!==y){var k=Math.max(0,(parseInt(i.stock,10)||0)-a),_=SHEETS_CONFIG.SHEET_NAMES.KITS+"!"+ht(y)+i._rowIndex;c.push(G(_,[[k]])),i.stock=String(k)}if(-1!==E){var I=Math.max(0,(parseInt(i.on_hold,10)||0)-a),w=SHEETS_CONFIG.SHEET_NAMES.KITS+"!"+ht(E)+i._rowIndex;c.push(G(w,[[I]])),i.on_hold=String(I)}}Promise.all(c).then(function(){e.status="confirmed",e.resolved_at=(new Date).toISOString(),e.resolved_by=t,e.last_updated=(new Date).toISOString(),re(n),ne(),pe(),$()}).catch(function(e){S("Failed to confirm hold: "+e.message,"error")})}}function re(e){var t=f.filter(function(t){return t.reservation_id===e.reservation_id});if(0!==t.length){var n=t.every(function(e){return"confirmed"===e.status}),a=t.every(function(e){return"released"===e.status}),o=t.every(function(e){return"confirmed"===e.status||"released"===e.status}),i=null;if(n?i="confirmed":a?i="cancelled":o&&(i="confirmed"),i&&e.status!==i){var r="confirmed"!==e.status;if(e.status=i,SHEETS_CONFIG.ADMIN_API_URL)R("update_reservation",{reservationId:e.reservation_id,expectedVersion:null,updates:{status:i}}).then(function(t){t.newVersion&&(e.last_updated=t.newVersion)}).catch(function(e){console.error("Failed to auto-update reservation status:",e)});else{var s=p.indexOf("status");if(-1!==s){G(SHEETS_CONFIG.SHEET_NAMES.RESERVATIONS+"!"+ht(s)+e._rowIndex,[[i]]);var d=p.indexOf("last_updated");if(-1!==d){var c=(new Date).toISOString();G(SHEETS_CONFIG.SHEET_NAMES.RESERVATIONS+"!"+ht(d)+e._rowIndex,[[c]]),e.last_updated=c}}}"confirmed"===i&&r&&e.customer_email&&ce(e)}}}var se=null;function de(e,t){var n=e;return Object.keys(t).forEach(function(e){n=n.replace(new RegExp("\\{\\{"+e+"\\}\\}","g"),t[e])}),n}function ce(e){var t={customer:e.customer_name||"Customer",email:e.customer_email||"",products:e.products||"",timeslot:e.timeslot||""};function n(e,n){window.open("mailto:"+encodeURIComponent(t.email)+"?subject="+encodeURIComponent(e)+"&body="+encodeURIComponent(n),"_blank")}if(se&&se.confirmation){var a=se.confirmation;n(de(a.subject,t),de(a.body,t))}else n("Your Steins & Vines Reservation is Confirmed","Hi "+t.customer+",\n\nGreat news! Your reservation has been confirmed.\n\nReserved items: "+t.products+"\nAppointment: "+t.timeslot+"\n\nYour appointment is to start fermentation in store — it takes about 15 minutes. We'll contact you when it's time to come back and bottle.\n\nIf you need to reschedule, please reply to this email or give us a call.\n\nSee you soon!\nSteins & Vines")}var le="name",ue="asc",me={SKU:"sku",Brand:"brand",Name:"name",Type:"type",Tint:"tint",Stock:"stock","On Hold":"on_hold","On Order":"on_order",Available:"_available","In-Store":"retail_instore",Kit:"retail_kit"};function pe(){var e=document.getElementById("kits-tbody"),t=document.getElementById("kits-empty");if(e){var n=document.getElementById("kit-brand-filter").value,a=document.getElementById("kit-stock-filter").value,o=document.getElementById("kit-search"),i=o?o.value.toLowerCase():"",c=r.filter(function(e){if("all"!==n&&e.brand!==n)return!1;var t=e.sku&&d.hasOwnProperty(e.sku)?d[e.sku]:null,o=(t&&null!==t.stock?t.stock:parseInt(e.stock,10)||0)-(parseInt(e.on_hold,10)||0);if("in"===a&&o<=0)return!1;if("low"===a&&(o<=0||o>5))return!1;if("out"===a&&o>0)return!1;if(i&&-1===((e.name||"")+" "+(e.brand||"")+" "+(e.sku||"")+" "+(e.type||"")+" "+(e.subcategory||"")).toLowerCase().indexOf(i))return!1;return!0});if(c.sort(function(e,t){var n,a;if("_available"===le){var o=e.sku&&d.hasOwnProperty(e.sku)?d[e.sku]:null,i=t.sku&&d.hasOwnProperty(t.sku)?d[t.sku]:null;n=(o&&null!==o.stock?o.stock:parseInt(e.stock,10)||0)-(parseInt(e.on_hold,10)||0),a=(i&&null!==i.stock?i.stock:parseInt(t.stock,10)||0)-(parseInt(t.on_hold,10)||0)}else n=e[le]||"",a=t[le]||"";var r,s=parseFloat(String(n).replace(/[^0-9.\-]/g,"")),c=parseFloat(String(a).replace(/[^0-9.\-]/g,""));return r=isNaN(s)||isNaN(c)?String(n).localeCompare(String(a)):s-c,"asc"===ue?r:-r}),document.querySelectorAll("#kits-table thead th.sortable").forEach(function(e){e.classList.remove("sort-asc","sort-desc"),e.getAttribute("data-sort-key")===le&&e.classList.add("asc"===ue?"sort-asc":"sort-desc")}),e.innerHTML="",0===c.length)return t.style.display="",void(document.getElementById("kits-table").style.display="none");t.style.display="none",document.getElementById("kits-table").style.display="",c.forEach(function(t){var n=document.createElement("tr");oe(n,t.sku||""),oe(n,t.brand||""),oe(n,t.name||""),oe(n,t.type||""),oe(n,t.tint||"");var a,o,i=t.sku&&d.hasOwnProperty(t.sku)?d[t.sku]:null,r=document.createElement("td"),c=i?i.stock:null,l=null!==c?c:parseInt(t.stock,10)||0;r.textContent=l,null===c?(r.className="admin-editable",r.addEventListener("click",(a=r,o=t,function(){he(a,o,"stock")}))):(r.className="admin-cell-readonly",r.title="Stock synced from Zoho Inventory"),n.appendChild(r);var u=document.createElement("td");u.className="admin-editable",u.textContent=t.on_hold||"0",u.addEventListener("click",function(e,t){return function(){he(e,t,"on_hold")}}(u,t)),n.appendChild(u);var m=document.createElement("td");m.className="admin-editable",m.textContent=t.on_order||"0",m.addEventListener("click",function(e,t){return function(){he(e,t,"on_order")}}(m,t)),n.appendChild(m);var p=l-(parseInt(t.on_hold,10)||0),f=document.createElement("td");f.setAttribute("data-avail-sku",t.sku||t.name);var h=document.createElement("span");fe(h,p),f.appendChild(h),n.appendChild(f);var v=i?i.rate:null;if(null!==v){var g=document.createElement("td");g.textContent="$"+(v+50).toFixed(2),g.className="admin-cell-readonly",g.title="Price synced from Zoho Inventory",n.appendChild(g);var b=document.createElement("td");b.textContent="$"+v.toFixed(2),b.className="admin-cell-readonly",b.title="Price synced from Zoho Inventory",n.appendChild(b)}else oe(n,t.retail_instore?"$"+String(t.retail_instore).replace("$",""):""),oe(n,t.retail_kit?"$"+String(t.retail_kit).replace("$",""):"");var y=document.createElement("td"),E=document.createElement("button");E.type="button",E.className="btn-secondary admin-btn-sm",E.textContent="Hold",E.addEventListener("click",function(e){return function(){!function(e){var t='<form id="manual-hold-form" class="admin-modal-form">';t+='<div class="form-group"><label>Product</label><input type="text" value="'+vt((e.brand||"")+" "+(e.name||""))+'" disabled></div>',t+='<div class="form-group"><label for="hold-qty">Quantity</label><input type="number" id="hold-qty" value="1" min="1" required></div>',t+='<div class="form-group"><label for="hold-notes">Notes</label><input type="text" id="hold-notes" placeholder="e.g. Phone order for John"></div>',t+='<button type="submit" class="btn">Place Hold</button>',t+="</form>",Y("Hold — "+(e.name||""),t),document.getElementById("manual-hold-form").addEventListener("submit",function(t){t.preventDefault();var n=parseInt(document.getElementById("hold-qty").value,10)||1,a=gt(document.getElementById("hold-notes").value.trim()),o=new Date,i=["H-"+o.toISOString().slice(0,10).replace(/-/g,"")+"-M"+String(Math.floor(900*Math.random())+100),"",e.sku||"",(e.brand||"")+" "+(e.name||""),n,"pending",o.toISOString(),"","",a];j(SHEETS_CONFIG.SHEET_NAMES.HOLDS+"!A:A",[i]).then(function(){var t=s.indexOf("on_hold");if(-1!==t){var a=(parseInt(e.on_hold,10)||0)+n;return G(SHEETS_CONFIG.SHEET_NAMES.KITS+"!"+ht(t)+e._rowIndex,[[a]]).then(function(){e.on_hold=String(a)})}}).then(function(){X(),z()}).catch(function(e){S("Failed to place hold: "+e.message,"error")})})}(e)}}(t)),y.appendChild(E);var k=document.createElement("button");k.type="button",k.className="btn-secondary admin-btn-sm",k.textContent="+Order",k.addEventListener("click",function(e){return function(){Be(e.sku||"",e.brand||"",e.name||"",1)}}(t)),y.appendChild(k),n.appendChild(y),e.appendChild(n)})}}function fe(e,t){e.className=t<=0?"stock-badge stock-badge--out":t<=5?"stock-badge stock-badge--low":"stock-badge stock-badge--in",e.textContent=t}function he(e,t,n){if(!e.querySelector("input")){var a=t[n]||"0",o=document.createElement("input");o.type="number",o.className="admin-inline-input",o.value=a,o.min="0",e.textContent="",e.appendChild(o),o.focus(),o.select(),o.addEventListener("blur",function(){var i=o.value.trim();(""===i||isNaN(i))&&(i=a),e.textContent=i,i!==a&&(t[n]=i,e.classList.add("admin-cell-changed"),function(e,t,n){for(var a=0;a<y.length;a++)if(y[a].item===e&&y[a].field===t)return y[a].value=n,void ve();y.push({item:e,field:t,value:n}),ve()}(t,n,i),"stock"!==n&&"on_hold"!==n||function(e){var t=e.sku||e.name,n=document.querySelector('[data-avail-sku="'+t+'"]');if(n){var a=(parseInt(e.stock,10)||0)-(parseInt(e.on_hold,10)||0),o=n.querySelector(".stock-badge");o&&fe(o,a)}}(t))}),o.addEventListener("keydown",function(t){"Enter"===t.key&&(t.preventDefault(),o.blur()),"Escape"===t.key&&(e.textContent=a)})}}function ve(){var e=document.getElementById("admin-save-bar");if(e)if(y.length>0){e.style.display="";var t=y.length;document.getElementById("admin-save-count").textContent=t+" unsaved change"+(1===t?"":"s")}else e.style.display="none"}function ge(){if(0!==y.length){var e=document.getElementById("admin-save-btn");e&&(e.disabled=!0,e.textContent="Saving...");var t=[];y.forEach(function(e){var n,a;-1!==r.indexOf(e.item)?(n=s,a=SHEETS_CONFIG.SHEET_NAMES.KITS):(n=u,a=SHEETS_CONFIG.SHEET_NAMES.INGREDIENTS);var o=n.indexOf(e.field);if(-1!==o){var i=a+"!"+ht(o)+e.item._rowIndex;t.push(G(i,[[e.value]]));var d=n.indexOf("last_updated");if(-1!==d){var c=a+"!"+ht(d)+e.item._rowIndex;t.push(G(c,[[(new Date).toISOString()]])),e.item.last_updated=(new Date).toISOString()}}}),Promise.all(t).then(function(){y=[],ve(),document.querySelectorAll(".admin-cell-changed").forEach(function(e){e.classList.remove("admin-cell-changed")}),e&&(e.disabled=!1,e.textContent="Save All Changes")}).catch(function(t){S("Failed to save changes: "+t.message,"error"),e&&(e.disabled=!1,e.textContent="Save All Changes")})}}function be(){y=[],ve(),z()}function ye(){var e=document.getElementById("ingredients-tbody"),t=document.getElementById("ingredients-empty");if(e){var n=document.getElementById("ing-type-filter").value,a=l;if("all"!==n&&(a=l.filter(function(e){return e.type===n})),e.innerHTML="",0===a.length)return t.style.display="",void(document.getElementById("ingredients-table").style.display="none");t.style.display="none",document.getElementById("ingredients-table").style.display="",a.forEach(function(t){var n=document.createElement("tr");oe(n,t.sku||""),oe(n,t.type||""),oe(n,t.name||""),oe(n,t.supplier||"");var a=(t.cost||"").replace(/\$/g,"").trim();oe(n,a?"$"+a:"");var o,i=document.createElement("td"),r=document.createElement("button");r.type="button",r.className="btn-secondary admin-btn-sm admin-btn-danger",r.textContent="Delete",r.addEventListener("click",(o=t,function(){!function(e){if(confirm('Delete ingredient "'+e.name+'"? This cannot be undone.')){var t=SHEETS_CONFIG.SHEET_NAMES.INGREDIENTS+"!A"+e._rowIndex+":"+ht(u.length-1)+e._rowIndex,n=u.map(function(){return""});G(t,[n]).then(function(){var t=l.indexOf(e);-1!==t&&l.splice(t,1),ye()}).catch(function(e){S("Failed to delete: "+e.message,"error")})}}(o)})),i.appendChild(r),n.appendChild(i),e.appendChild(n)})}}document.addEventListener("DOMContentLoaded",function(){var e=document.getElementById("add-kit-btn");e&&e.addEventListener("click",function(){var e;e='<form id="add-kit-form" class="admin-modal-form">',[{key:"type",label:"Type",type:"text",value:"Wine"},{key:"brand",label:"Brand",type:"text"},{key:"name",label:"Name",type:"text"},{key:"subcategory",label:"Subcategory",type:"text"},{key:"sku",label:"SKU",type:"text"},{key:"retail_instore",label:"Retail In-Store",type:"text",placeholder:"$0.00"},{key:"retail_kit",label:"Retail Kit",type:"text",placeholder:"$0.00"},{key:"time",label:"Time",type:"text",placeholder:"8 weeks"},{key:"wholesale",label:"Wholesale",type:"text",placeholder:"$0.00"},{key:"tasting_notes",label:"Tasting Notes",type:"text"},{key:"abv",label:"ABV",type:"text",placeholder:"13%"},{key:"tint",label:"Tint Color",type:"select",options:["","red","white","rose","fruit","specialty","pilsner","amber","wheat","ipa","pale","session","saison","lager","stout","porter","redale","brown"]},{key:"stock",label:"Stock",type:"number",value:"0"},{key:"on_order",label:"On Order",type:"number",value:"0"},{key:"favorite",label:"Favorite",type:"select",options:["FALSE","TRUE"]}].forEach(function(t){e+='<div class="form-group">',e+='<label for="kit-'+t.key+'">'+t.label+"</label>","select"===t.type?(e+='<select id="kit-'+t.key+'" class="admin-select">',t.options.forEach(function(t){e+='<option value="'+t+'">'+t+"</option>"}),e+="</select>"):e+='<input type="'+t.type+'" id="kit-'+t.key+'"'+(t.value?' value="'+t.value+'"':"")+(t.placeholder?' placeholder="'+t.placeholder+'"':"")+">",e+="</div>"}),e+='<button type="submit" class="btn">Add Kit</button>',Y("Add Kit",e+="</form>"),document.getElementById("add-kit-form").addEventListener("submit",function(e){e.preventDefault();var t=s.map(function(e){var t=document.getElementById("kit-"+e);return t?"text"===t.type||"TEXTAREA"===t.tagName?gt(t.value):t.value:"on_hold"===e?"0":"available"===e?"":"last_updated"===e?(new Date).toISOString():""});j(SHEETS_CONFIG.SHEET_NAMES.KITS+"!A:A",[t]).then(function(){X(),z()}).catch(function(e){S("Failed to add kit: "+e.message,"error")})})})}),document.addEventListener("DOMContentLoaded",function(){var e=document.getElementById("add-ingredient-btn");e&&e.addEventListener("click",function(){var e,t,n,a;e=["Hops","Yeast","Additives","Finings","Sugar","Other"],t=["g","kg","packet","ml","L"],n="ING-"+String(l.length+1).padStart(3,"0"),a='<form id="add-ing-form" class="admin-modal-form">',a+='<div class="form-group"><label for="ing-sku">SKU</label><input type="text" id="ing-sku" value="'+n+'"></div>',a+='<div class="form-group"><label for="ing-type">Category</label><select id="ing-type" class="admin-select">',e.forEach(function(e){a+='<option value="'+e+'">'+e+"</option>"}),a+="</select></div>",a+='<div class="form-group"><label for="ing-name">Name</label><input type="text" id="ing-name" required></div>',a+='<div class="form-group"><label for="ing-unit">Unit</label><select id="ing-unit" class="admin-select">',t.forEach(function(e){a+='<option value="'+e+'">'+e+"</option>"}),a+="</select></div>",a+='<div class="form-group"><label for="ing-stock_qty">Stock Qty</label><input type="number" id="ing-stock_qty" value="0" min="0"></div>',a+='<div class="form-group"><label for="ing-reorder_level">Reorder Level</label><input type="number" id="ing-reorder_level" value="0" min="0"></div>',a+='<div class="form-group"><label for="ing-supplier">Supplier</label><input type="text" id="ing-supplier"></div>',a+='<div class="form-group"><label for="ing-cost">Cost</label><input type="text" id="ing-cost" placeholder="$0.00"></div>',a+='<div class="form-group"><label for="ing-notes">Notes</label><input type="text" id="ing-notes"></div>',a+='<button type="submit" class="btn">Add Ingredient</button>',Y("Add Ingredient",a+="</form>"),document.getElementById("add-ing-form").addEventListener("submit",function(e){e.preventDefault();var t=u.map(function(e){var t=document.getElementById("ing-"+e);return t?"text"===t.type||"TEXTAREA"===t.tagName?gt(t.value):t.value:"last_updated"===e?(new Date).toISOString():""});j(SHEETS_CONFIG.SHEET_NAMES.INGREDIENTS+"!A:A",[t]).then(function(){X(),z()}).catch(function(e){S("Failed to add ingredient: "+e.message,"error")})})})});var Ee="brand",ke="asc",_e={SKU:"sku",Brand:"brand",Name:"name",Qty:"qty",Cost:"_cost","Line Total":"_total"};function Se(){var e=document.getElementById("order-brand-filter");if(e){var t=we(),n=[];for(t.forEach(function(e){e.brand&&-1===n.indexOf(e.brand)&&n.push(e.brand)}),n.sort();e.options.length>1;)e.remove(1);n.forEach(function(t){var n=document.createElement("option");n.value=t,n.textContent=t,e.appendChild(n)})}}var Ie="sv-admin-order";function we(){try{return JSON.parse(localStorage.getItem(Ie))||[]}catch(e){return[]}}function xe(e){localStorage.setItem(Ie,JSON.stringify(e))}var Ce=["Heritage Estates","Orchard Breezin'"];function Le(e){return-1!==Ce.indexOf(e)}function Te(t){if(e&&0!==r.length){var n=s.indexOf("on_order");if(-1!==n){var a=we(),o=[];t.forEach(function(e){var t=r.find(function(t){return t.sku===e});if(t){var i=a.find(function(t){return t.sku===e}),s=i?i.qty:0,d=SHEETS_CONFIG.SHEET_NAMES.KITS+"!"+ht(n)+t._rowIndex;o.push(G(d,[[s]])),t.on_order=String(s)}}),o.length>0&&Promise.all(o).then(function(){pe()}).catch(function(e){console.error("Failed to sync on_order:",e)})}}}function Be(e,t,n,a){var o=Le(t)?2:1;2===o&&a%2!=0&&(a=2*Math.ceil(a/2));for(var i=we(),r=0;r<i.length;r++)if(i[r].sku===e)return i[r].qty+=a,2===o&&i[r].qty%2!=0&&(i[r].qty=2*Math.ceil(i[r].qty/2)),xe(i),Te([e]),void Ne();i.push({sku:e,brand:t,name:n,qty:a}),xe(i),Te([e]),Se(),Ne()}function Ae(e,t){for(var n=we(),a=0;a<n.length;a++)if(n[a].sku===e){var o=Le(n[a].brand)?2:1;t<=0?n.splice(a,1):(2===o&&t%2!=0&&(t=2*Math.ceil(t/2)),n[a].qty=t);break}xe(n),Te([e]),Se(),Ne()}function Ne(){var e=document.getElementById("order-tbody"),t=document.getElementById("order-empty"),n=document.getElementById("order-table");if(e){var a=we();e.innerHTML="";var o=document.getElementById("order-search"),i=o?o.value.toLowerCase():"",s=document.getElementById("order-brand-filter"),c=s?s.value:"all",l=a.filter(function(e){if("all"!==c&&e.brand!==c)return!1;if(i&&-1===((e.name||"")+" "+(e.brand||"")+" "+(e.sku||"")).toLowerCase().indexOf(i))return!1;return!0});if(l.sort(function(e,t){var n,a;if("_cost"===Ee||"_total"===Ee){var o=r.find(function(t){return t.sku===e.sku}),i=r.find(function(e){return e.sku===t.sku}),s=o&&o.wholesale&&parseFloat(String(o.wholesale).replace(/[^0-9.\-]/g,""))||0,d=i&&i.wholesale&&parseFloat(String(i.wholesale).replace(/[^0-9.\-]/g,""))||0;"_total"===Ee?(n=s*e.qty,a=d*t.qty):(n=s,a=d)}else"qty"===Ee?(n=e.qty||0,a=t.qty||0):(n=e[Ee]||"",a=t[Ee]||"");var c,l=parseFloat(String(n).replace(/[^0-9.\-]/g,"")),u=parseFloat(String(a).replace(/[^0-9.\-]/g,""));return c=isNaN(l)||isNaN(u)?String(n).localeCompare(String(a)):l-u,"asc"===ke?c:-c}),document.querySelectorAll("#order-table thead th.sortable").forEach(function(e){e.classList.remove("sort-asc","sort-desc"),e.getAttribute("data-sort-key")===Ee&&e.classList.add("asc"===ke?"sort-asc":"sort-desc")}),0===l.length)return t&&(t.style.display=""),void(n&&(n.style.display="none"));t&&(t.style.display="none"),n&&(n.style.display="");var u=document.getElementById("order-select-all");u&&(u.checked=!0,u.onchange=function(){for(var t=e.querySelectorAll(".order-item-cb"),n=0;n<t.length;n++)t[n].checked=u.checked});var m=0;l.forEach(function(t){var n=document.createElement("tr"),a=document.createElement("td"),o=document.createElement("input");o.type="checkbox",o.checked=!0,o.className="order-item-cb",o.setAttribute("data-sku",t.sku),o.addEventListener("change",function(){!o.checked&&u&&(u.checked=!1)}),a.appendChild(o),n.appendChild(a),oe(n,t.sku||""),oe(n,t.brand||"");var i=document.createElement("td");if(i.textContent=t.name||"",Le(t.brand)){var s=document.createElement("span");s.textContent=" (2-pack)",s.style.color="#888",s.style.fontSize="0.85em",i.appendChild(s)}n.appendChild(i);var c=t.sku&&d.hasOwnProperty(t.sku)?d[t.sku]:null;oe(n,c&&c.vendor_name?c.vendor_name:"");var l=document.createElement("td");if(t.po_number){var p=document.createElement("span");p.textContent=t.po_number,p.style.color="var(--accent)",l.appendChild(p)}n.appendChild(l);var f=document.createElement("td"),h=document.createElement("div");h.className="product-qty-controls";var v,g,b,y=Le(t.brand)?2:1,E=document.createElement("button");E.type="button",E.className="qty-btn",E.textContent="−",E.addEventListener("click",(v=t.sku,g=t.qty,b=y,function(){Ae(v,g-b)}));var k=document.createElement("span");k.className="qty-value",k.textContent=t.qty;var _=document.createElement("button");_.type="button",_.className="qty-btn",_.textContent="+",_.addEventListener("click",function(e,t,n){return function(){Ae(e,t+n)}}(t.sku,t.qty,y)),h.appendChild(E),h.appendChild(k),h.appendChild(_),f.appendChild(h),n.appendChild(f);var S=r.find(function(e){return e.sku===t.sku}),I=0;S&&S.wholesale&&(String(S.wholesale),I=parseFloat(String(S.wholesale).replace(/[^0-9.\-]/g,""))||0);var w=I*t.qty;m+=w,oe(n,I?"$"+I.toFixed(2):""),oe(n,I?"$"+w.toFixed(2):"");var x=document.createElement("td"),C=document.createElement("button");C.type="button",C.className="btn-secondary admin-btn-sm admin-btn-danger",C.textContent="Remove",C.addEventListener("click",function(e){return function(){var t;t=e,xe(we().filter(function(e){return e.sku!==t})),Te([t]),Se(),Ne()}}(t.sku)),x.appendChild(C),n.appendChild(x),e.appendChild(n)});var p=document.createElement("tr");p.style.fontWeight="700";var f=document.createElement("td");f.colSpan=8,f.style.textAlign="right",f.textContent="Order Total:",p.appendChild(f);var h=document.createElement("td");h.textContent="$"+m.toFixed(2),p.appendChild(h);var v=document.createElement("td");p.appendChild(v),e.appendChild(p)}}function Oe(){return"undefined"!=typeof SHEETS_CONFIG&&SHEETS_CONFIG.MIDDLEWARE_URL?SHEETS_CONFIG.MIDDLEWARE_URL:""}function He(e){var t={"Content-Type":"application/json"};return e&&"undefined"!=typeof SHEETS_CONFIG&&SHEETS_CONFIG.MW_API_KEY&&(t["X-API-Key"]=SHEETS_CONFIG.MW_API_KEY),t}function De(){var e=Oe(),t=document.getElementById("po-list");e?(t&&(t.innerHTML='<p class="admin-note">Loading purchase orders from Zoho...</p>'),fetch(e+"/api/purchase-orders?status=open").then(function(e){return e.ok?e.json():{purchaseorders:[]}}).then(function(e){c=e.purchaseorders||[],function(){var e=document.getElementById("po-list");if(!e)return;if(0===c.length)return void(e.innerHTML='<p class="admin-note">No open purchase orders in Zoho.</p>');var t='<table class="admin-table po-table">';t+="<thead><tr><th>PO #</th><th>Vendor</th><th>Date</th><th>Items</th><th>Total</th><th>Status</th><th></th></tr></thead>",t+="<tbody>",c.forEach(function(e){var n=(e.line_items||[]).length,a=null!=e.total?"$"+parseFloat(e.total).toFixed(2):"",o=e.status?e.status.charAt(0).toUpperCase()+e.status.slice(1):"";t+="<tr>",t+="<td><strong>"+(e.purchaseorder_number||e.purchaseorder_id)+"</strong></td>",t+="<td>"+(e.vendor_name||"")+"</td>",t+="<td>"+(e.date||"")+"</td>",t+="<td>"+n+"</td>",t+="<td>"+a+"</td>",t+="<td>"+o+"</td>",t+='<td><button type="button" class="btn-secondary admin-btn-sm po-add-items-btn" data-po-id="'+e.purchaseorder_id+'">Add Items</button></td>',t+="</tr>"}),t+="</tbody></table>",e.innerHTML=t,e.querySelectorAll(".po-add-items-btn").forEach(function(e){e.addEventListener("click",function(){var t=e.getAttribute("data-po-id"),n=c.find(function(e){return String(e.purchaseorder_id)===String(t)});n&&function(e){var t=e.purchaseorder_number||e.purchaseorder_id,n='<div class="admin-modal-form">';n+='<p style="margin-bottom:12px;">Adding to PO <strong>'+t+"</strong>"+(e.vendor_name?" &mdash; "+e.vendor_name:"")+"</p>",n+='<div class="form-group"><label>Kit</label>',n+='<div class="admin-kit-search-wrap" id="po-kit-wrap">',n+='<input type="text" id="po-kit-search" class="admin-kit-search-input" placeholder="Type to search kits..." autocomplete="off">',n+='<div class="admin-kit-search-dropdown" id="po-kit-dropdown" style="display:none;"></div>',n+='<input type="hidden" id="po-kit-item-id" value="">',n+='<input type="hidden" id="po-kit-sku" value="">',n+="</div></div>",n+='<div class="form-group"><label>Quantity</label>',n+='<input type="number" id="po-item-qty" class="admin-inline-input" value="1" min="1" style="width:80px;">',n+="</div>",n+='<button type="button" class="btn" id="po-add-item-submit">Add to PO</button>',n+="</div>",Y("Add Items to PO "+t,n);var a=document.getElementById("po-kit-search"),o=document.getElementById("po-kit-dropdown"),i=document.getElementById("po-kit-item-id"),r=document.getElementById("po-kit-sku");a.addEventListener("input",function(){var e=a.value.toLowerCase();if(e.length<2)o.style.display="none";else{var t=qe.filter(function(t){return-1!==t.label.toLowerCase().indexOf(e)}).slice(0,10);0!==t.length?(o.innerHTML="",t.forEach(function(e){var t=document.createElement("div");t.className="admin-kit-search-option",t.textContent=e.label,t.addEventListener("mousedown",function(t){t.preventDefault(),a.value=e.label;var n=d[e.sku];i.value=n?n.item_id:"",r.value=e.sku,o.style.display="none"}),o.appendChild(t)}),o.style.display=""):o.style.display="none"}}),document.getElementById("po-add-item-submit").addEventListener("click",function(){var n=i.value,a=r.value,o=parseInt(document.getElementById("po-item-qty").value,10)||1;if(n){var s=Oe();if(s){var c=document.getElementById("po-add-item-submit");c.disabled=!0,c.textContent="Adding...";var l=d[a];fetch(s+"/api/purchase-orders/"+e.purchaseorder_id+"/add-item",{method:"POST",headers:He(!0),body:JSON.stringify({item_id:n,quantity:o,rate:l&&l.rate||0})}).then(function(e){return e.json()}).then(function(e){if(!e.purchaseorder&&0!==e.code)throw new Error(e.error||e.message||"Failed");S("Added to PO "+t,"success"),X(),De()}).catch(function(e){S("Failed: "+e.message,"error"),c.disabled=!1,c.textContent="Add to PO"})}}else S("Please select a kit","warning")})}(n)})})}()}).catch(function(){t&&(t.innerHTML='<p class="admin-note">Could not load purchase orders from Zoho.</p>')})):t&&(t.innerHTML='<p class="admin-note">Middleware not configured.</p>')}function Me(){var e=Oe();if(e){var t=document.getElementById("order-tbody"),n={};t&&t.querySelectorAll(".order-item-cb:checked").forEach(function(e){n[e.getAttribute("data-sku")]=!0});var a=we().filter(function(e){return n[e.sku]});if(0!==a.length){var o={},i=[];a.forEach(function(e){var t=d[e.sku];if(t&&t.vendor_id&&t.item_id){var n=t.vendor_id;o[n]||(o[n]={vendor_id:t.vendor_id,vendor_name:t.vendor_name,items:[]}),o[n].items.push({item:e,z:t})}else i.push(e.sku)});var r=Object.keys(o).map(function(e){return o[e]});if(0!==r.length){var s=(new Date).toISOString().slice(0,10),c="Create "+r.length+" purchase order"+(r.length>1?"s":"")+" in Zoho?\n\n";if(r.forEach(function(e){c+="• "+e.vendor_name+": "+e.items.length+" item(s)\n"}),i.length>0&&(c+="\nSkipping "+i.length+" item(s) with no vendor/item ID in Zoho."),confirm(c)){var l=document.getElementById("order-create-po-btn");l&&(l.disabled=!0,l.textContent="Creating...");var u=r.map(function(t){var n={vendor_id:t.vendor_id,date:s,line_items:t.items.map(function(e){return{item_id:e.z.item_id,quantity:e.item.qty,rate:e.z.rate||0}})};return fetch(e+"/api/purchase-orders",{method:"POST",headers:He(!0),body:JSON.stringify(n)}).then(function(e){return e.json()}).then(function(e){if(e.error)throw new Error(e.error);var n=e.purchaseorder||{};return t.items.forEach(function(e){e._po_number=n.purchaseorder_number||n.purchaseorder_id||"",e._po_id=n.purchaseorder_id||""}),{status:"fulfilled",vendor:t.vendor_name,po:n}}).catch(function(e){return{status:"rejected",vendor:t.vendor_name,reason:e.message}})});Promise.all(u).then(function(e){var t=e.filter(function(e){return"fulfilled"===e.status}),n=e.filter(function(e){return"rejected"===e.status}),a=we();r.forEach(function(e){e.items[0]&&e.items[0]._po_number&&e.items.forEach(function(e){var t=a.find(function(t){return t.sku===e.item.sku});t&&(t.po_number=e._po_number,t.po_id=e._po_id)})}),xe(a),Ne(),t.length>0&&De(),0===n.length?S("Created "+t.length+" PO"+(t.length>1?"s":"")+" in Zoho","success"):0===t.length?S("All PO creation failed. Check Zoho and retry.","error"):S(t.length+" PO(s) created. Failed: "+n.map(function(e){return e.vendor}).join(", "),"warning"),l&&(l.disabled=!1,l.textContent="Create Zoho PO(s)")})}}else S("No items have a vendor configured in Zoho. Set a preferred vendor on each item in Zoho Inventory.","warning")}else S("No items selected","warning")}else S("Middleware not configured","error")}var qe=[];function Fe(){var e=we();if(0!==e.length){var t=e.map(function(e){return e.qty+"x  "+e.brand+" — "+e.name+"  (SKU: "+e.sku+")"}),n="Supplier Order — "+(new Date).toLocaleDateString()+"\n—————————————————————\n"+t.join("\n")+"\n—————————————————————\nTotal items: "+e.reduce(function(e,t){return e+t.qty},0);navigator.clipboard.writeText(n).then(function(){var e=document.getElementById("order-copy-btn");e.textContent="Copied!",setTimeout(function(){e.textContent="Copy Order List"},2e3)}).catch(function(){prompt("Copy this order:",n)})}else S("Order is empty.","warning")}function Pe(){var e=we();if(0!==e.length){for(var t={},n=document.querySelectorAll(".order-item-cb:checked"),a=0;a<n.length;a++)t[n[a].getAttribute("data-sku")]=!0;var o=e.filter(function(e){return t[e.sku]}),i=e.filter(function(e){return!t[e.sku]});if(0!==o.length){var d="Accept delivery for "+o.length+" of "+e.length+" item(s)? This will add ordered quantities to stock and subtract from on_order for the selected kits.";if(confirm(d)){var c=document.getElementById("order-accept-btn");c&&(c.disabled=!0,c.textContent="Processing...");var l=[];o.forEach(function(e){var t=r.find(function(t){return t.sku===e.sku});if(t){var n=s.indexOf("stock");if(-1!==n){var a=(parseInt(t.stock,10)||0)+e.qty,o=SHEETS_CONFIG.SHEET_NAMES.KITS+"!"+ht(n)+t._rowIndex;l.push(G(o,[[a]])),t.stock=String(a)}var i=s.indexOf("on_order");if(-1!==i){var d=SHEETS_CONFIG.SHEET_NAMES.KITS+"!"+ht(i)+t._rowIndex;l.push(G(d,[[0]])),t.on_order="0"}var c=s.indexOf("last_updated");if(-1!==c){var u=SHEETS_CONFIG.SHEET_NAMES.KITS+"!"+ht(c)+t._rowIndex;l.push(G(u,[[(new Date).toISOString()]]))}}}),Promise.all(l).then(function(){xe(i),Ne(),pe(),c&&(c.disabled=!1,c.textContent="Accept Delivery"),S("Delivery accepted. Stock updated for "+o.length+" item(s)."+(i.length>0?" "+i.length+" item(s) remain in the order.":""),"success")}).catch(function(e){c&&(c.disabled=!1,c.textContent="Accept Delivery"),S("Failed to update stock: "+e.message,"error")})}}else S("No items selected.","warning")}else S("Order is empty.","warning")}function Re(){if(confirm("Clear the entire order? This cannot be undone.")){var e=we().map(function(e){return e.sku});xe([]),Te(e),Ne()}}var Ue=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];function Ge(){var e=localStorage.getItem("sv_schedule_defaults");if(e)try{var t=JSON.parse(e);return t.forEach(function(e){e.blockedSlots||(e.blockedSlots=[])}),t}catch(e){}return[{day:"Sun",start:"",end:"",open:!1,blockedSlots:[]},{day:"Mon",start:"",end:"",open:!1,blockedSlots:[]},{day:"Tue",start:"10:00 AM",end:"4:00 PM",open:!0,blockedSlots:[]},{day:"Wed",start:"10:00 AM",end:"4:00 PM",open:!0,blockedSlots:[]},{day:"Thu",start:"12:00 PM",end:"7:00 PM",open:!0,blockedSlots:[]},{day:"Fri",start:"10:00 AM",end:"4:00 PM",open:!0,blockedSlots:[]},{day:"Sat",start:"10:00 AM",end:"4:00 PM",open:!0,blockedSlots:[]}]}function je(e){localStorage.setItem("sv_schedule_defaults",JSON.stringify(e))}function ze(){var e=document.getElementById("schedule-defaults-tbody");if(e){e.innerHTML="";var t=Ge(),n=function(){for(var e=[""],t=6;t<=21;t++)for(var n=0;n<60;n+=30){var a=t>12?t-12:0===t?12:t,o=t>=12?"PM":"AM",i=n<10?"0"+n:""+n;e.push(a+":"+i+" "+o)}return e}();t.forEach(function(t,a){var o=document.createElement("tr"),i=document.createElement("td");i.textContent=t.day,o.appendChild(i);var r=document.createElement("td"),s=document.createElement("select");s.className="admin-select",s.dataset.idx=a,s.dataset.field="start",n.forEach(function(e){var n=document.createElement("option");n.value=e,n.textContent=e||"—",e===t.start&&(n.selected=!0),s.appendChild(n)}),r.appendChild(s),o.appendChild(r);var d=document.createElement("td"),c=document.createElement("select");c.className="admin-select",c.dataset.idx=a,c.dataset.field="end",n.forEach(function(e){var n=document.createElement("option");n.value=e,n.textContent=e||"—",e===t.end&&(n.selected=!0),c.appendChild(n)}),d.appendChild(c),o.appendChild(d);var l=document.createElement("td"),u=document.createElement("button");if(u.type="button",u.className="btn-secondary admin-btn-sm"+(t.open?" schedule-open":" schedule-closed"),u.textContent=t.open?"Open":"Closed",u.dataset.idx=a,u.addEventListener("click",function(){var e=parseInt(this.dataset.idx,10),t=Ge();t[e].open=!t[e].open,t[e].open||(t[e].start="",t[e].end=""),je(t),ze()}),l.appendChild(u),o.appendChild(l),e.appendChild(o),t.open&&t.start&&t.end){var m=document.createElement("tr"),p=document.createElement("td");p.colSpan=4,p.className="schedule-default-slots";var f=t.blockedSlots||[];Ve(t.start,t.end).forEach(function(e){var t=document.createElement("button");t.type="button";var n=-1!==f.indexOf(e);t.className="schedule-default-slot"+(n?" blocked":""),t.textContent=e,t.addEventListener("click",function(){var t=Ge();t[a].blockedSlots||(t[a].blockedSlots=[]);var n=t[a].blockedSlots.indexOf(e);-1!==n?t[a].blockedSlots.splice(n,1):t[a].blockedSlots.push(e),je(t),ze()}),p.appendChild(t)}),m.appendChild(p),e.appendChild(m)}})}}function Ve(e,t){var n=[];if(!e||!t)return n;for(var a=Ke(e),o=Ke(t),i=a;i<o;i+=30)n.push(We(i));return n}function Ke(e){var t=e.match(/(\d+):(\d+)\s*(AM|PM)/i);if(!t)return 0;var n=parseInt(t[1],10),a=parseInt(t[2],10),o=t[3].toUpperCase();return"PM"===o&&12!==n&&(n+=12),"AM"===o&&12===n&&(n=0),60*n+a}function We(e){var t=Math.floor(e/60),n=e%60;return(t>12?t-12:0===t?12:t)+":"+(n<10?"0"+n:""+n)+" "+(t>=12?"PM":"AM")}function $e(e){var t=e.getFullYear(),n=e.getMonth()+1,a=e.getDate();return t+"-"+(n<10?"0"+n:n)+"-"+(a<10?"0"+a:a)}var Ze=null,Je=null;function Qe(){var e=document.getElementById("schedule-cal");if(e){var t=Ze.getFullYear(),n=Ze.getMonth(),a=Ze.toLocaleString("default",{month:"long",year:"numeric"}),o={};v.forEach(function(e){o[e.date]||(o[e.date]=[]),o[e.date].push(e)});var i='<div class="schedule-cal-header">';i+='<button type="button" class="btn-secondary admin-btn-sm schedule-cal-prev">&laquo;</button>',i+='<span class="schedule-cal-title">'+vt(a)+"</span>",i+='<button type="button" class="btn-secondary admin-btn-sm schedule-cal-next">&raquo;</button>',i+="</div>",i+='<div class="schedule-cal-actions">',i+='<button type="button" class="btn admin-btn-sm" id="schedule-generate-month-btn">Generate Slots</button>',i+='<button type="button" class="btn-secondary admin-btn-sm" id="schedule-reset-month-btn">Reset to Defaults</button>',i+="</div>",i+='<div class="schedule-cal-grid">',Ue.forEach(function(e){i+='<div class="schedule-cal-dayheader">'+e+"</div>"});for(var r=new Date(t,n,1).getDay(),s=0;s<r;s++)i+='<div class="schedule-cal-cell empty"></div>';for(var d=Ge(),c=new Date(t,n+1,0).getDate(),l=1;l<=c;l++){var u=new Date(t,n,l),m=$e(u),p=!d[u.getDay()].open,f=o[m]||[],h=f.filter(function(e){return"available"===e.status}).length,b=f.filter(function(e){return"booked"===e.status}).length,y=f.filter(function(e){return"blocked"===e.status}).length,E="";0===f.length?E="":h>0?E="dot-available":b>0&&0===h?E="dot-booked":y>0&&0===h&&0===b&&(E="dot-blocked"),i+='<div class="schedule-cal-cell'+(m===Je?" selected":"")+(p?" closed":"")+'" data-date="'+m+'">',i+='<span class="schedule-cal-day">'+l+"</span>",p?i+='<span class="schedule-cal-closed">Closed</span>':E&&(i+='<span class="schedule-cal-dot '+E+'"></span>'),f.length>0&&!p&&(i+='<span class="schedule-cal-counts">',i+='<span class="cal-count-open">'+h+"</span>",i+='<span class="cal-count-booked">'+b+"</span>",i+="</span>"),i+="</div>"}i+="</div>",e.innerHTML=i,e.querySelector(".schedule-cal-prev").addEventListener("click",function(){Ze.setMonth(Ze.getMonth()-1),Qe()}),e.querySelector(".schedule-cal-next").addEventListener("click",function(){Ze.setMonth(Ze.getMonth()+1),Qe()}),e.querySelectorAll(".schedule-cal-cell[data-date]").forEach(function(e){e.addEventListener("click",function(){Je=this.dataset.date,Qe(),Ye(Je)})});var k=e.querySelector("#schedule-generate-month-btn");k&&k.addEventListener("click",function(){!function(){if(Ze){var e=Ge(),t=Ze.getFullYear(),n=Ze.getMonth(),a=new Date(t,n+1,0).getDate(),o=Ze.toLocaleString("default",{month:"long",year:"numeric"}),i=new Date;i.setHours(0,0,0,0);var r={};v.forEach(function(e){r[e.date+"|"+e.time]=!0});for(var s=[],d=1;d<=a;d++){var c=new Date(t,n,d);if(!(c<i)){var l=e[c.getDay()];if(l.open&&l.start&&l.end){var u=$e(c),m=l.blockedSlots||[];Ve(l.start,l.end).forEach(function(e){-1===m.indexOf(e)&&(r[u+"|"+e]||s.push([u,e,"available"]))})}}}0!==s.length?confirm("Generate "+s.length+" new slot(s) for "+o+"?")&&j(SHEETS_CONFIG.SHEET_NAMES.SCHEDULE+"!A:C",s).then(function(){S(s.length+" slots generated for "+o+".","success"),z()}).catch(function(e){S("Failed to generate slots: "+e.message,"error")}):S("No new slots to generate for "+o+" (all slots already exist).","warning")}}()});var _=e.querySelector("#schedule-reset-month-btn");_&&_.addEventListener("click",function(){!function(){if(!Ze)return;var e=Ge(),t=Ze.getFullYear(),n=Ze.getMonth(),a=new Date(t,n+1,0).getDate(),o=g.indexOf("status");if(-1===o)return void S("Cannot find status column.","warning");var i=new Date;i.setHours(0,0,0,0);for(var r={},s=1;s<=a;s++){var d=new Date(t,n,s);if(!(d<i)){var c=$e(d),l=e[d.getDay()];if(l.open&&l.start&&l.end){var u=l.blockedSlots||[];Ve(l.start,l.end).forEach(function(e){-1===u.indexOf(e)&&(r[c+"|"+e]=!0)})}}}var m=function(){var e=Ze.getFullYear(),t=Ze.getMonth()+1;return e+"-"+(t<10?"0"+t:t)}(),p=v.filter(function(e){return e.date&&e.date.substring(0,7)===m}),f=[];if(p.forEach(function(e){if("booked"!==e.status){var t=e.date+"|"+e.time,n=!!r[t];n&&"available"!==e.status?f.push({slot:e,newStatus:"available"}):n||"blocked"===e.status||f.push({slot:e,newStatus:"blocked"})}}),0===f.length)return void S("All slots already match defaults.","warning");if(!confirm("This will update "+f.length+" slot(s) in "+Ze.toLocaleString("default",{month:"long",year:"numeric"})+" to match your default schedule. Booked slots will not be changed. Continue?"))return;var h=f.map(function(e){return G(SHEETS_CONFIG.SHEET_NAMES.SCHEDULE+"!"+ht(o)+e.slot._rowIndex,[[e.newStatus]]).then(function(){e.slot.status=e.newStatus})});Promise.all(h).then(function(){S(f.length+" slot(s) updated to match defaults.","success"),Qe()}).catch(function(e){S("Failed to reset slots: "+e.message,"error"),z()})}()}),Je&&Ye(Je)}}function Ye(e){var t=document.getElementById("schedule-day-slots");if(t){var n=v.filter(function(t){return t.date===e});if(n.sort(function(e,t){return Ke(e.time)-Ke(t.time)}),0!==n.length){var a='<div class="schedule-day-header">';a+="<h4>"+vt(e)+"</h4>",a+='<button type="button" class="btn-secondary admin-btn-sm" id="schedule-block-day">Block Entire Day</button>',a+='<button type="button" class="btn-secondary admin-btn-sm" id="schedule-open-day">Open Entire Day</button>',a+='<button type="button" class="btn-secondary admin-btn-sm" id="schedule-reset-day">Reset to Default</button>',a+="</div>",a+='<div class="schedule-slots">',n.forEach(function(e){var t="schedule-slot slot-"+e.status,n="booked"===e.status?" disabled":"";a+='<button type="button" class="'+t+'" data-date="'+vt(e.date)+'" data-time="'+vt(e.time)+'" data-row="'+e._rowIndex+'"'+n+">",a+=vt(e.time),"booked"===e.status&&(a+=" <small>(booked)</small>"),a+="</button>"}),a+="</div>",t.innerHTML=a,t.querySelectorAll(".schedule-slot:not([disabled])").forEach(function(e){e.addEventListener("click",function(){!function(e,t,n){var a=v.find(function(n){return n.date===e&&n.time===t});if(!a||"booked"===a.status)return;var o="available"===a.status?"blocked":"available",i=g.indexOf("status");if(-1===i)return;G(SHEETS_CONFIG.SHEET_NAMES.SCHEDULE+"!"+ht(i)+n,[[o]]).then(function(){a.status=o,Qe()}).catch(function(e){S("Failed to update slot: "+e.message,"error")})}(this.dataset.date,this.dataset.time,parseInt(this.dataset.row,10))})});var o=document.getElementById("schedule-block-day");o&&o.addEventListener("click",function(){Xe(e,"blocked")});var i=document.getElementById("schedule-open-day");i&&i.addEventListener("click",function(){Xe(e,"available")});var r=document.getElementById("schedule-reset-day");r&&r.addEventListener("click",function(){!function(e){var t=Ge(),n=new Date(e+"T00:00:00"),a=n.getDay(),o=t[a],i=g.indexOf("status");if(-1===i)return;var r={};if(o.open&&o.start&&o.end){var s=o.blockedSlots||[];Ve(o.start,o.end).forEach(function(e){-1===s.indexOf(e)&&(r[e]=!0)})}var d=v.filter(function(t){return t.date===e}),c=[];if(d.forEach(function(e){if("booked"!==e.status){var t=!!r[e.time];t&&"available"!==e.status?c.push({slot:e,newStatus:"available"}):t||"blocked"===e.status||c.push({slot:e,newStatus:"blocked"})}}),0===c.length)return void S("Day already matches defaults.","warning");var l=c.map(function(e){return G(SHEETS_CONFIG.SHEET_NAMES.SCHEDULE+"!"+ht(i)+e.slot._rowIndex,[[e.newStatus]]).then(function(){e.slot.status=e.newStatus})});Promise.all(l).then(function(){Qe()}).catch(function(e){S("Failed to reset day: "+e.message,"error")})}(e)})}else t.innerHTML='<p class="admin-empty">No slots for '+vt(e)+"</p>"}}function Xe(e,t){var n=v.filter(function(t){return t.date===e&&"booked"!==t.status});if(0!==n.length){var a=g.indexOf("status");if(-1!==a){var o=n.map(function(e){return G(SHEETS_CONFIG.SHEET_NAMES.SCHEDULE+"!"+ht(a)+e._rowIndex,[[t]]).then(function(){e.status=t})});Promise.all(o).then(function(){Qe()}).catch(function(e){S("Failed to update day: "+e.message,"error")})}}}function et(){var e=[["Product Name","SKU","Category","Subcategory","Price","Kit Price","Cost","Stock On Hand","On Order","Notes"]];r.forEach(function(t){e.push([((t.brand||"")+" "+(t.name||"")).trim(),t.sku||"",t.type||"",t.subcategory||"",(t.retail_instore||"").replace("$",""),(t.retail_kit||"").replace("$",""),(t.wholesale||"").replace("$",""),t.stock||"0",t.on_order||"0",t.tasting_notes||""])});var t=kt();at(e,"sv-kits-export-"+t+".csv")}function tt(){var e=[u.slice()];l.forEach(function(t){var n=u.map(function(e){return t[e]||""});e.push(n)});var t=kt();at(e,"sv-ingredients-export-"+t+".csv")}function nt(){var e=[["Stock Code/SKU","Name","Retail Price","Wholesale Price","Qty"]];r.forEach(function(t){e.push([t.sku||"",((t.brand||"")+" "+(t.name||"")).trim(),(t.retail_instore||"").replace("$",""),(t.wholesale||"").replace("$",""),t.stock||"0"])}),l.forEach(function(t){e.push([t.sku||"",t.name||"",(t.cost||"").replace("$",""),(t.cost||"").replace("$",""),t.stock_qty||"0"])});var t=kt();at(e,"sv-winescheduler-export-"+t+".csv")}function at(e,t){var n=e.map(function(e){return e.map(function(e){var t=String(e);return-1!==t.indexOf(",")||-1!==t.indexOf('"')||-1!==t.indexOf("\n")?'"'+t.replace(/"/g,'""')+'"':t}).join(",")}).join("\n"),a=new Blob([n],{type:"text/csv;charset=utf-8;"}),o=document.createElement("a");o.href=URL.createObjectURL(a),o.download=t,o.style.display="none",document.body.appendChild(o),o.click(),document.body.removeChild(o)}var ot=null;function it(e){var t=e.target.files[0];if(t){var n=new FileReader;n.onload=function(e){var t=e.target.result.trim().split("\n");if(t.length<2)S("CSV file is empty or has no data rows.","warning");else{for(var n=dt(t[0]).map(function(e){return e.trim()}),a=[],o=1;o<t.length;o++){var i=dt(t[o]);if(!(i.length<n.length)){for(var s={},d=0;d<n.length;d++)s[n[d]]=i[d].trim();a.push(s)}}ot={headers:n,rows:a},function(){if(!ot)return;var e=document.getElementById("import-preview"),t=document.getElementById("import-preview-head"),n=document.getElementById("import-preview-body"),a="<tr>";a+="<th>Change</th>",ot.headers.forEach(function(e){a+="<th>"+vt(e)+"</th>"}),a+="</tr>",t.innerHTML=a,n.innerHTML="";var o=-1!==ot.headers.indexOf("sku")?"sku":"SKU";ot.rows.forEach(function(e){var t=e[o]||e.sku||e.SKU||"",a=r.find(function(e){return e.sku===t}),i=document.createElement("tr"),s=document.createElement("td");if(a){var d=!1;ot.headers.forEach(function(t){var n=t.toLowerCase().replace(/ /g,"_");void 0!==a[n]&&a[n]!==(e[t]||"")&&(d=!0)}),s.textContent=d?"MODIFIED":"UNCHANGED",s.className=d?"admin-diff-mod":""}else s.textContent="NEW",s.className="admin-diff-new";i.appendChild(s),ot.headers.forEach(function(t){oe(i,e[t]||"")}),n.appendChild(i)}),e.style.display=""}()}},n.readAsText(t)}}function rt(){if(ot&&0!==ot.rows.length){var e=[s];ot.rows.forEach(function(t){var n=s.map(function(e){if(void 0!==t[e])return t[e];var n={type:"Category",subcategory:"Subcategory",name:"Product Name",retail_instore:"Price",retail_kit:"Kit Price",wholesale:"Cost",stock:"Stock On Hand",tasting_notes:"Notes"};return n[e]&&void 0!==t[n[e]]?t[n[e]]:""});e.push(n)}),G(SHEETS_CONFIG.SHEET_NAMES.KITS+"!A1:"+ht(s.length-1)+e.length,e).then(function(){S("Import applied successfully.","success"),st(),z()}).catch(function(e){S("Import failed: "+e.message,"error")})}}function st(){ot=null,document.getElementById("import-preview").style.display="none",document.getElementById("import-csv-input").value=""}function dt(e){for(var t=[],n="",a=!1,o=0;o<e.length;o++){var i=e[o];a?'"'===i?o+1<e.length&&'"'===e[o+1]?(n+='"',o++):a=!1:n+=i:'"'===i?a=!0:","===i?(t.push(n),n=""):n+=i}return t.push(n),t}var ct={"promo-news":[],"instafeed-url":"","promo-featured-skus":[],"social-instagram":"","social-facebook":"",faq:[]},lt=null;function ut(){var e=[],t=document.getElementById("homepage-news-list");t&&t.querySelectorAll(".homepage-news-item").forEach(function(t){var n=t.querySelector(".news-date"),a=t.querySelector(".news-title"),o=t.querySelector(".news-text");n&&a&&o&&e.push({date:n.value||"",title:gt(a.value||""),text:gt(o.value||"")})});ct["promo-news"]=e;var n=document.getElementById("homepage-instafeed-url");n&&(ct["instafeed-url"]=gt(n.value||""));var a=document.querySelectorAll(".homepage-featured-item"),o=[];a.forEach(function(e,t){var n=e.querySelector(".featured-desc"),a=ct["promo-featured-skus"][t];a&&o.push({sku:a.sku,description:gt(n?n.value:"")})}),ct["promo-featured-skus"]=o;var i=document.getElementById("homepage-social-instagram");i&&(ct["social-instagram"]=gt(i.value||""));var r=document.getElementById("homepage-social-facebook");r&&(ct["social-facebook"]=gt(r.value||""));var s=[],d=document.getElementById("homepage-faq-list");d&&d.querySelectorAll(".homepage-faq-item").forEach(function(e){var t=e.querySelector(".faq-question"),n=e.querySelector(".faq-answer");t&&n&&s.push({question:gt(t.value||""),answer:gt(n.value||"")})});ct.faq=s}function mt(){var e=document.getElementById("homepage-news-list");e&&(e.innerHTML="",ct["promo-news"].forEach(function(t,n){var a=document.createElement("div");a.className="homepage-news-item",a.innerHTML='<div class="homepage-news-item-fields"><input type="text" class="news-date" placeholder="Date (e.g., Jan 15, 2026)" value="'+vt(t.date||"")+'"><input type="text" class="news-title" placeholder="Title" value="'+vt(t.title||"")+'"><textarea class="news-text" placeholder="News text...">'+vt(t.text||"")+'</textarea></div><div class="homepage-news-item-actions"><button type="button" class="btn-secondary admin-btn-sm admin-btn-danger news-remove-btn" data-idx="'+n+'">Remove</button></div>',e.appendChild(a)}),e.querySelectorAll(".news-remove-btn").forEach(function(e){e.addEventListener("click",function(){ut();var e=parseInt(this.dataset.idx,10);ct["promo-news"].splice(e,1),mt()})}))}function pt(){var e=document.getElementById("homepage-faq-list");e&&(e.innerHTML="",ct.faq.forEach(function(t,n){var a=document.createElement("div");a.className="homepage-faq-item",a.innerHTML='<div class="homepage-faq-item-fields"><input type="text" class="faq-question" placeholder="Question" value="'+vt(t.question||"")+'"><textarea class="faq-answer" placeholder="Answer...">'+vt(t.answer||"")+'</textarea></div><div class="homepage-faq-item-actions"><button type="button" class="btn-secondary admin-btn-sm admin-btn-danger faq-remove-btn" data-idx="'+n+'">Remove</button></div>',e.appendChild(a)}),e.querySelectorAll(".faq-remove-btn").forEach(function(e){e.addEventListener("click",function(){ut();var e=parseInt(this.dataset.idx,10);ct.faq.splice(e,1),pt()})}))}function ft(){var e=document.getElementById("homepage-featured-list");e&&(e.innerHTML="",ct["promo-featured-skus"].forEach(function(t,n){var a=r.find(function(e){return e.sku===t.sku}),o=a?((a.brand||"")+" "+(a.name||"")).trim():"Unknown",i=document.createElement("div");i.className="homepage-featured-item",i.innerHTML='<div class="homepage-featured-item-info"><span class="homepage-featured-item-name">'+vt(o)+'</span><span class="homepage-featured-item-sku">SKU: '+vt(t.sku)+'</span></div><textarea class="admin-textarea featured-desc" rows="2" placeholder="Description for this product...">'+vt(t.description||"")+'</textarea><button type="button" class="btn-secondary admin-btn-sm admin-btn-danger featured-remove-btn" data-idx="'+n+'">Remove</button>',e.appendChild(i)}),e.querySelectorAll(".featured-remove-btn").forEach(function(e){e.addEventListener("click",function(){var e=parseInt(this.dataset.idx,10);ct["promo-featured-skus"].splice(e,1),ft()})}))}function ht(e){for(var t="";e>=0;)t=String.fromCharCode(65+e%26)+t,e=Math.floor(e/26)-1;return t}function vt(e){var t=document.createElement("div");return t.textContent=e,t.innerHTML}function gt(e){if(null==e)return"";if("string"!=typeof e)return String(e);var t=e;return t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=t.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"")).replace(/<\/?script[^>]*>/gi,"")).replace(/\s*on\w+\s*=\s*["'][^"']*["']/gi,"")).replace(/\s*on\w+\s*=\s*[^\s>]+/gi,"")).replace(/javascript\s*:/gi,"")).replace(/data\s*:\s*text\/html/gi,"")).replace(/<\/?iframe[^>]*>/gi,"")).replace(/<\/?object[^>]*>/gi,"")).replace(/<\/?embed[^>]*>/gi,"")).replace(/<style\b[^<]*(?:(?!<\/style>)<[^<]*)*<\/style>/gi,"")).replace(/<\/?style[^>]*>/gi,"")}document.addEventListener("DOMContentLoaded",function(){var t=document.getElementById("homepage-add-news");t&&t.addEventListener("click",function(){ut(),ct["promo-news"].unshift({date:"",title:"",text:""}),mt()});var n=document.getElementById("homepage-add-faq");n&&n.addEventListener("click",function(){ut(),ct.faq.push({question:"",answer:""}),pt()});var a,o=document.getElementById("homepage-kit-search"),i=document.getElementById("homepage-kit-dropdown");o&&i&&(o.addEventListener("input",function(){var e=this;clearTimeout(a),a=setTimeout(function(){var t=e.value.toLowerCase().trim();if(t.length<2)i.style.display="none";else{var n=r.filter(function(e){return-1!==(e.name||"").toLowerCase().indexOf(t)||-1!==(e.brand||"").toLowerCase().indexOf(t)||-1!==(e.sku||"").toLowerCase().indexOf(t)}).slice(0,10);0!==n.length?(i.innerHTML="",n.forEach(function(e){var t=document.createElement("div");t.className="admin-kit-search-option",t.innerHTML="<strong>"+vt(e.brand||"")+"</strong> "+vt(e.name||"")+' <span style="opacity:0.6">('+vt(e.sku||"")+")</span>",t.addEventListener("click",function(){lt=e,o.value=(e.brand||"")+" "+(e.name||""),i.style.display="none"}),i.appendChild(t)}),i.style.display="block"):i.style.display="none"}},300)}),o.addEventListener("blur",function(){setTimeout(function(){i.style.display="none"},200)}));var s=document.getElementById("homepage-add-product");s&&s.addEventListener("click",function(){lt&&lt.sku?(ct["promo-featured-skus"].some(function(e){return e.sku===lt.sku})||(ct["promo-featured-skus"].push({sku:lt.sku,description:""}),ft()),lt=null,o.value=""):S("Please select a product from the search dropdown.","warning")});var d=document.getElementById("homepage-save-btn");d&&d.addEventListener("click",function(){ut(),function(){var t,n=[["Type","Date","Title","Text","SKU"]];ct["promo-news"].forEach(function(e){n.push(["news",e.date||"",e.title||"",e.text||"",""])}),ct["instafeed-url"]&&n.push(["instafeed","","",ct["instafeed-url"],""]),ct["promo-featured-skus"].forEach(function(e){n.push(["featured","","",e.description||"",e.sku])}),ct["social-instagram"]&&n.push(["social","","instagram","",ct["social-instagram"]]),ct["social-facebook"]&&n.push(["social","","facebook","",ct["social-facebook"]]),ct.faq.forEach(function(e){n.push(["faq","",e.question||"",e.answer||"",""])}),t=SHEETS_CONFIG.ADMIN_API_URL?P("check_auth").then(function(e){if(!e.authorized)throw new Error("Not authorized to make changes")}):Promise.resolve();var a="https://sheets.googleapis.com/v4/spreadsheets/"+SHEETS_CONFIG.SPREADSHEET_ID+"/values/"+encodeURIComponent(SHEETS_CONFIG.SHEET_NAMES.HOMEPAGE+"!A:E")+":clear";t.then(function(){return fetch(a,{method:"POST",headers:{Authorization:"Bearer "+e}})}).then(function(e){return e.ok?e.json():e.json().then(function(e){throw new Error(e.error?e.error.message:"Failed to clear sheet")})}).then(function(){return G(SHEETS_CONFIG.SHEET_NAMES.HOMEPAGE+"!A1",n)}).then(function(){S("Homepage settings saved to Google Sheets!","success")}).catch(function(e){console.error("[Homepage] Error saving:",e),S("Error saving homepage settings: "+e.message,"error")})}()})});var bt=null;function yt(){var e="undefined"!=typeof SHEETS_CONFIG&&SHEETS_CONFIG.MIDDLEWARE_URL?SHEETS_CONFIG.MIDDLEWARE_URL:"";if(e)fetch(e+"/api/orders/recent?limit=20").then(function(e){return e.json()}).then(function(e){!function(e){var t=document.getElementById("kiosk-orders-list");if(!t)return;if(0===e.length)return void(t.innerHTML='<p class="admin-order-info">No recent orders.</p>');var n='<table class="catalog-table kiosk-orders-table">';n+="<thead><tr><th>Order</th><th>Customer</th><th>Items</th><th>Total</th><th>Timeslot</th><th>Status</th><th>Payment</th></tr></thead>",n+="<tbody>",e.forEach(function(e){var t=e.items.map(function(e){return e.name+(e.quantity>1?" x"+e.quantity:"")}).join(", "),a="",o=e.status||"Walk-in";"walk-in"===o.toLowerCase()?a="kiosk-status--walkin":"pending"===o.toLowerCase()&&(a="kiosk-status--pending");var i="";i=e.transaction_id?'<span class="kiosk-payment-badge kiosk-payment--paid">Paid</span>':parseFloat(e.deposit)>0?'<span class="kiosk-payment-badge kiosk-payment--deposit">Deposit</span>':'<span class="kiosk-payment-badge kiosk-payment--pending">Pending</span>',n+="<tr>",n+='<td data-label="Order">'+e.salesorder_number+"</td>",n+='<td data-label="Customer">'+(e.customer_name||"—")+"</td>",n+='<td data-label="Items">'+t+"</td>",n+='<td data-label="Total">$'+Number(e.total).toFixed(2)+"</td>",n+='<td data-label="Timeslot">'+(e.timeslot||"—")+"</td>",n+='<td data-label="Status"><span class="kiosk-status '+a+'">'+o+"</span></td>",n+='<td data-label="Payment">'+i+"</td>",n+="</tr>"}),n+="</tbody></table>",t.innerHTML=n}(e.orders||[])}).catch(function(e){var t=document.getElementById("kiosk-orders-list");t&&(t.innerHTML='<p class="admin-order-info">Failed to load orders: '+e.message+"</p>")});else{var t=document.getElementById("kiosk-orders-list");t&&(t.innerHTML='<p class="admin-order-info">Middleware URL not configured.</p>')}}var Et=A;function kt(e){return(e?new Date(Date.now()+864e5*e):new Date).toLocaleDateString("en-CA",{timeZone:"America/Vancouver"})}A=function(){var e;Et(),(e=document.getElementById("kiosk-orders-refresh"))&&e.addEventListener("click",yt),yt(),bt&&clearInterval(bt),bt=setInterval(yt,15e3)};var _t,St,It=[],wt="start_date",xt="desc",Ct=[],Lt=null,Tt=[],Bt={primary:{label:"Primary",color:"blue"},secondary:{label:"Secondary",color:"amber"},complete:{label:"Complete",color:"green"},disabled:{label:"Disabled",color:"gray"}},At=0,Nt=0;function Ot(e){P("get_batches",{status:document.getElementById("batch-status-filter")?document.getElementById("batch-status-filter").value:"active"}).then(function(t){It=t.data&&t.data.batches||[],Mt(),e&&e()}).catch(function(e){S("Failed to load batches: "+e.message,"error")})}function Ht(e){P("get_ferm_schedules").then(function(t){Ct=t.data&&t.data.schedules||[],rn(),e&&e()}).catch(function(e){S("Failed to load schedules: "+e.message,"error")})}function Dt(){P("get_batch_dashboard_summary").then(function(e){Lt=e.data||null,vn(),gn(Lt)}).catch(function(){})}function Mt(){var e=document.getElementById("batches-tbody"),t=document.getElementById("batches-empty");if(e){var n=(document.getElementById("batch-search")?document.getElementById("batch-search").value:"").toLowerCase(),a=It;if(n&&(a=a.filter(function(e){return-1!==(String(e.batch_id)+" "+String(e.product_name)+" "+String(e.customer_name)+" "+String(e.vessel_id)).toLowerCase().indexOf(n)})),0===a.length)return e.innerHTML="",t&&(t.style.display=""),void qt();t&&(t.style.display="none"),a=a.slice().sort(function(e,t){var n,a,o;return"location"===wt?(n=[e.shelf_id,e.bin_id,e.vessel_id].filter(Boolean).join(" ").toLowerCase(),a=[t.shelf_id,t.bin_id,t.vessel_id].filter(Boolean).join(" ").toLowerCase()):"progress"===wt?(n=e.tasks_total>0?e.tasks_done/e.tasks_total:0,a=t.tasks_total>0?t.tasks_done/t.tasks_total:0):(n=String(e[wt]||"").toLowerCase(),a=String(t[wt]||"").toLowerCase()),o="number"==typeof n&&"number"==typeof a?n-a:n<a?-1:n>a?1:0,"desc"===xt?-o:o}),qt();var o="";a.forEach(function(e){var t=Bt[String(e.status).toLowerCase()]||{label:e.status,color:"gray"},n=[e.shelf_id,e.bin_id,e.vessel_id].filter(Boolean).join(" - ")||"—",a=e.tasks_total||0,i=e.tasks_done||0,r=a>0?Math.round(i/a*100):0,s=e.start_date?String(e.start_date).substring(0,10):"—";o+='<tr data-batch-id="'+e.batch_id+'">',o+='<td class="batch-id-cell">'+vt(e.batch_id)+"</td>",o+="<td>"+vt(e.product_name||e.product_sku||"—")+"</td>",o+="<td>"+vt(e.customer_name||"—")+"</td>",o+='<td><span class="batch-status batch-status--'+t.color+'">'+t.label+"</span></td>",o+="<td>"+s+"</td>",o+="<td>"+n+"</td>",o+='<td><div class="batch-progress"><div class="batch-progress-bar" style="width:'+r+'%"></div></div><span class="batch-progress-text">'+i+"/"+a+"</span></td>",o+='<td><button type="button" class="btn-secondary admin-btn-sm batch-qr-btn" data-batch-id="'+e.batch_id+'">QR</button></td>',o+="</tr>"}),e.innerHTML=o,e.querySelectorAll("tr").forEach(function(e){e.addEventListener("click",function(t){t.target.classList.contains("batch-qr-btn")||Ft(e.getAttribute("data-batch-id"))})}),e.querySelectorAll(".batch-qr-btn").forEach(function(e){e.addEventListener("click",function(t){t.stopPropagation();var n=e.getAttribute("data-batch-id");e.disabled=!0,e.textContent="...",P("get_batch",{batch_id:n}).then(function(e){var t=e.data&&e.data.batch||{};!function(e,t,n){if("undefined"==typeof qrcode)return void S("QR library not loaded","error");var a=un(e,t),o=a.createSvgTag(6),i=window.location.origin+"/batch.html?id="+encodeURIComponent(e)+"&token="+encodeURIComponent(t),r='<div style="text-align:center;">';r+='<div style="margin:10px auto;">'+o+"</div>",r+="<p><strong>"+e+"</strong></p>",r+="<p>"+vt(n.product_name||"")+"</p>",r+="<p>"+vt(n.customer_name||"")+"</p>",r+='<p style="font-size:0.8rem;word-break:break-all;color:#666;">'+i+"</p>",r+='<button type="button" class="btn" id="qr-print-btn">Print Label</button>',r+='<button type="button" class="btn-secondary" id="qr-copy-url-btn" style="margin-left:8px;">Copy URL</button>',Y("Batch QR Code",r+="</div>"),document.getElementById("qr-print-btn").addEventListener("click",function(){mn(e,t,n)}),document.getElementById("qr-copy-url-btn").addEventListener("click",function(){navigator.clipboard.writeText(i).then(function(){S("URL copied to clipboard","success")})})}(n,t.access_token||"",t)}).catch(function(e){S("Failed: "+e.message,"error")}).finally(function(){e.disabled=!1,e.textContent="QR"})})})}}function qt(){var e=document.getElementById("batches-table");e&&e.querySelectorAll("th.sortable").forEach(function(e){e.classList.remove("sort-asc","sort-desc"),e.getAttribute("data-sort-key")===wt&&e.classList.add("asc"===xt?"sort-asc":"sort-desc")})}function Ft(e){Y("Loading...","<p>Loading batch details...</p>");var t=P("get_batch",{batch_id:e}),n=Zt?Promise.resolve():new Promise(function(e){Qt(e)});Promise.all([t,n]).then(function(e){!function(e){var t=e.batch,n=e.tasks||[],a=e.plato_readings||[],o=e.vessel_history||[],i=Bt[String(t.status).toLowerCase()]||{label:t.status,color:"gray"},r='<div class="batch-detail">';r+='<div class="batch-detail-header">',r+='<span class="batch-status batch-status--'+i.color+'">'+i.label+"</span>",r+='<span class="batch-detail-id">'+t.batch_id+"</span>",r+="</div>",r+='<div class="batch-detail-grid">',r+='<div class="batch-detail-col"><strong>Product:</strong> '+vt(t.product_name||t.product_sku)+"</div>",r+='<div class="batch-detail-col"><strong>Customer:</strong> '+vt(t.customer_name||"—")+"</div>",r+='<div class="batch-detail-col"><strong>Start Date:</strong> '+(t.start_date?String(t.start_date).substring(0,10):"—")+"</div>",r+='<div class="batch-detail-col"><strong>Shelf:</strong> '+vt(t.shelf_id||"—")+" &nbsp;<strong>Bin:</strong> "+vt(t.bin_id||"—")+" &nbsp;<strong>Vessel:</strong> "+vt(t.vessel_id||"—")+"</div>",r+="</div>";var s="";if(t.vessel_id&&Zt){var d=Zt.find(function(e){return String(e.vessel_id)===String(t.vessel_id)});s=d?Yt(d):t.vessel_id}r+='<details class="batch-detail-section"><summary>Edit Location</summary>',r+='<div class="batch-detail-location-edit">',r+='<div class="admin-kit-search-wrap" style="flex:2;">',r+='<input type="text" id="batch-edit-vessel-search" class="admin-inline-input" value="'+s+'" placeholder="Search vessels..." autocomplete="off">',r+='<div class="admin-kit-search-dropdown" id="batch-edit-vessel-dropdown" style="display:none;"></div>',r+='<input type="hidden" id="batch-edit-vessel" value="'+(t.vessel_id||"")+'">',r+="</div>",r+='<input type="text" id="batch-edit-shelf" value="'+(t.shelf_id||"")+'" placeholder="A" class="admin-inline-input">',r+='<input type="text" id="batch-edit-bin" value="'+(t.bin_id||"")+'" placeholder="01" class="admin-inline-input">',r+='<button type="button" class="btn admin-btn-sm" id="batch-save-location">Save</button>',r+="</div></details>",r+='<div id="tasks-section">'+function(e,t){var n='<div class="batch-detail-tasks-header"><h4>Tasks</h4>';return n+='<button type="button" class="btn admin-btn-sm" id="batch-save-tasks-btn" style="display:none;">Save Tasks</button>',n+='<button type="button" class="btn-secondary admin-btn-sm" id="batch-add-task-btn">+ Add Task</button></div>',n+='<div class="batch-detail-tasks">',e.forEach(function(e){var a="TRUE"===String(e.completed).toUpperCase(),o="TRUE"===String(e.is_packaging).toUpperCase(),i="TRUE"===String(e.is_transfer).toUpperCase(),r=e.due_date?String(e.due_date).substring(0,10):o?"TBD":"—",s="batch-task-row";a&&(s+=" batch-task-row--done"),!a&&e.due_date&&String(e.due_date).substring(0,10)<kt()&&(s+=" batch-task-row--overdue"),n+='<div class="'+s+'">',n+='<label class="batch-task-check"><input type="checkbox" '+(a?"checked":"")+' data-task-id="'+e.task_id+'" data-batch-id="'+t+'" data-is-transfer="'+(i?"1":"")+'"> ',n+='<span class="batch-task-title">'+vt(e.title||"Step "+e.step_number)+"</span>",i&&(n+='<span class="batch-task-badge batch-task-badge--transfer">Transfer</span>'),o&&(n+='<span class="batch-task-badge batch-task-badge--pkg">Packaging</span>'),n+="</label>",n+='<span class="batch-task-due">'+r+"</span>",a&&e.completed_at&&(n+='<span class="batch-task-meta">Done '+String(e.completed_at).substring(0,10)+"</span>"),n+="</div>"}),n+="</div>"}(n,t.batch_id)+"</div>",Rt=a.slice(),Ut=t.start_date,Gt=t.batch_id,r+='<div id="plato-section">'+jt(Rt,Ut)+"</div>",r+="<h4>Notes</h4>",r+='<textarea id="batch-notes-edit" class="admin-input" rows="3">'+vt(t.notes||"")+"</textarea>",r+='<button type="button" class="btn admin-btn-sm" id="batch-save-notes" style="margin-top:4px;">Save Notes</button>',o.length>0&&(r+="<h4>Location History</h4>",r+='<div class="batch-vessel-history">',o.forEach(function(e){r+='<div class="batch-vh-entry">',r+="<strong>"+String(e.transferred_at||"").substring(0,10)+"</strong> ",r+="S:"+vt(e.shelf_id||"?")+" B:"+vt(e.bin_id||"?")+" V:"+vt(e.vessel_id||"?"),e.notes&&(r+=" — "+vt(e.notes)),r+="</div>"}),r+="</div>");r+='<div class="batch-detail-actions">',r+='<select id="batch-status-change" class="admin-select"><option value="">Change Status...</option>',["primary","secondary","complete","disabled"].forEach(function(e){r+='<option value="'+e+'"'+(e===String(t.status).toLowerCase()?" selected disabled":"")+">"+(Bt[e]||{}).label+"</option>"}),r+="</select>",r+='<button type="button" class="btn-secondary admin-btn-sm" id="batch-view-url">Open Batch URL</button>',r+='<button type="button" class="btn-secondary admin-btn-sm" id="batch-print-label">Print Label</button>',r+='<button type="button" class="btn-secondary admin-btn-sm" id="batch-print-qr">Print QR</button>',r+='<button type="button" class="btn-secondary admin-btn-sm" id="batch-regen-token">Regenerate URL</button>',r+='<button type="button" class="btn-secondary admin-btn-sm admin-btn-danger" id="batch-delete-btn">Delete Batch</button>',r+="</div>",r+="</div>",Y("Batch "+t.batch_id,r);var c=t.batch_id,l=t.last_updated,u=t.access_token;!function(e){var t={};function n(){var e=document.getElementById("batch-save-tasks-btn"),n=Object.keys(t).length;e&&(e.style.display=n>0?"":"none",e.textContent="Save Tasks ("+n+")")}function a(){document.querySelectorAll('.batch-task-check input[type="checkbox"]').forEach(function(a){var o=a.checked;a.addEventListener("change",function(){var i=a.getAttribute("data-task-id"),r="1"===a.getAttribute("data-is-transfer");if(a.checked&&r)!function(e,t){var n='<div class="batch-transfer-prompt">';n+="<p>This is a transfer step. Enter the new location:</p>",n+='<div class="form-group form-group-row">',n+='<div style="flex:2;"><label>Vessel</label>',n+='<div class="admin-kit-search-wrap" id="transfer-vessel-search-wrap">',n+='<input type="text" id="transfer-vessel-search" class="admin-inline-input" placeholder="Search vessels..." autocomplete="off">',n+='<div class="admin-kit-search-dropdown" id="transfer-vessel-dropdown" style="display:none;"></div>',n+='<input type="hidden" id="transfer-vessel" value="">',n+="</div></div>",n+='<div><label>Shelf</label><input type="text" id="transfer-shelf" class="admin-inline-input" placeholder="A"></div>',n+='<div><label>Bin</label><input type="text" id="transfer-bin" class="admin-inline-input" placeholder="01"></div>',n+="</div>",n+='<div style="margin-top:8px;display:flex;gap:8px;">',n+='<button type="button" class="btn" id="transfer-confirm">Complete Transfer</button>',n+='<button type="button" class="btn-secondary" id="transfer-skip">Complete Without Transfer</button>',n+="</div>",n+="</div>",Y("Transfer Step",n);var a=document.getElementById("transfer-vessel-search"),o=document.getElementById("transfer-vessel-dropdown"),i=document.getElementById("transfer-vessel");a&&o&&i&&Xt(a,o,i,"");var r=document.getElementById("transfer-shelf"),s=document.getElementById("transfer-bin");r&&tn(r);s&&nn(s);var d=document.getElementById("transfer-confirm"),c=document.getElementById("transfer-skip");d.addEventListener("click",function(){var n=document.getElementById("transfer-vessel").value,a=document.getElementById("transfer-shelf").value,o=document.getElementById("transfer-bin").value;n?(d.disabled=!0,c.disabled=!0,d.textContent="Saving...",R("update_batch_task",{task_id:t,updates:{completed:!0},transfer_location:{vessel_id:n,shelf_id:a,bin_id:o}}).then(function(){S("Transfer completed","success"),Zt=null,Ft(e)}).catch(function(e){d.disabled=!1,c.disabled=!1,d.textContent="Complete Transfer",S("Failed: "+e.message,"error")})):S("Select a vessel","error")}),c.addEventListener("click",function(){d.disabled=!0,c.disabled=!0,c.textContent="Saving...",R("update_batch_task",{task_id:t,updates:{completed:!0}}).then(function(){S("Task completed","success"),Ft(e)}).catch(function(e){d.disabled=!1,c.disabled=!1,c.textContent="Complete Without Transfer",S("Failed: "+e.message,"error")})})}(e,i);else{a.checked===o?delete t[i]:t[i]=a.checked;var s=a.closest(".batch-task-row");s&&s.classList.toggle("batch-task-row--done",a.checked),n()}})})}a();var o=document.getElementById("batch-save-tasks-btn");o&&o.addEventListener("click",function(){var e=Object.keys(t).map(function(e){return{task_id:e,updates:{completed:t[e]}}});o.disabled=!0,o.textContent="Saving...",R("bulk_update_batch_tasks",{tasks:e}).then(function(){S(e.length+" task"+(1!==e.length?"s":"")+" updated","success");var i=kt();Object.keys(t).forEach(function(e){var n=document.querySelector('.batch-task-check input[data-task-id="'+e+'"]');if(n){var a=n.closest(".batch-task-row");if(a){var o=a.querySelector(".batch-task-meta");if(t[e]){if(!o){var r=document.createElement("span");r.className="batch-task-meta",r.textContent="Done "+i,a.appendChild(r)}}else o&&o.remove()}}}),t={},n(),o.disabled=!1,document.querySelectorAll('.batch-task-check input[type="checkbox"]').forEach(function(e){var t=e.cloneNode(!0);e.parentNode.replaceChild(t,e)}),a()}).catch(function(e){S("Failed: "+e.message,"error"),o.disabled=!1,n()})});var i=document.getElementById("batch-add-task-btn");i&&i.addEventListener("click",function(){!function(e){var t='<div class="batch-add-task-form">';t+='<div class="form-group"><label>Title</label><input type="text" id="add-task-title" class="admin-input" placeholder="Task title"></div>',t+='<div class="form-group"><label>Description</label><input type="text" id="add-task-desc" class="admin-input" placeholder="Optional description"></div>',t+='<div class="form-group"><label>Due Date</label><input type="date" id="add-task-date" class="admin-input"></div>',t+='<div class="form-group"><label><input type="checkbox" id="add-task-transfer"> This is a transfer step (vessel change)</label></div>',t+='<button type="button" class="btn" id="add-task-submit">Add Task</button>',t+="</div>",Y("Add Task to Batch",t),document.getElementById("add-task-submit").addEventListener("click",function(){var t=document.getElementById("add-task-title").value;if(t){var n=document.getElementById("add-task-submit");n.disabled=!0,n.textContent="Adding...",R("add_batch_task",{batch_id:e,title:t,description:document.getElementById("add-task-desc").value,due_date:document.getElementById("add-task-date").value||"",is_transfer:document.getElementById("add-task-transfer").checked}).then(function(){S("Task added","success"),Ft(e)}).catch(function(e){n.disabled=!1,n.textContent="Add Task",S("Failed: "+e.message,"error")})}else S("Enter a task title","error")})}(e)})}(c);var m=document.getElementById("batch-edit-vessel-search"),p=document.getElementById("batch-edit-vessel-dropdown"),f=document.getElementById("batch-edit-vessel");m&&p&&f&&(Xt(m,p,f,t.vessel_id||""),te("click",function(e){p.contains(e.target)||e.target===m||(p.style.display="none")}));var h=document.getElementById("batch-edit-shelf"),v=document.getElementById("batch-edit-bin");h&&tn(h);v&&nn(v);var g=document.getElementById("batch-save-location");g&&g.addEventListener("click",function(){R("update_batch",{batch_id:c,expectedVersion:l,updates:{vessel_id:document.getElementById("batch-edit-vessel").value,shelf_id:document.getElementById("batch-edit-shelf").value,bin_id:document.getElementById("batch-edit-bin").value}}).then(function(){S("Location updated","success"),Zt=null,Ft(c)}).catch(function(e){S("Failed: "+e.message,"error")})});Kt(c);var b=document.getElementById("batch-save-notes");b&&b.addEventListener("click",function(){R("update_batch",{batch_id:c,expectedVersion:l,updates:{notes:document.getElementById("batch-notes-edit").value}}).then(function(e){e&&e.newVersion&&(l=e.newVersion),S("Notes saved","success")}).catch(function(e){S("Failed: "+e.message,"error")})});var y=document.getElementById("batch-status-change");y&&y.addEventListener("change",function(){var e=y.value;e&&R("update_batch",{batch_id:c,expectedVersion:l,updates:{status:e}}).then(function(){S("Status changed to "+e,"success"),Ft(c),Ot()}).catch(function(e){S("Failed: "+e.message,"error")})});var E=document.getElementById("batch-view-url");E&&E.addEventListener("click",function(){var e=window.location.origin+"/batch.html?id="+encodeURIComponent(c)+"&token="+encodeURIComponent(u);window.open(e,"_blank")});var k=document.getElementById("batch-print-label");k&&k.addEventListener("click",function(){!function(e,t,n){var a="";if("undefined"!=typeof qrcode&&e.batch_id&&n){a=un(e.batch_id,n).createSvgTag(4)}var o=hn({batch:e,tasks:t,qrSvg:a}),i=window.open("","_blank");i.document.write(o),i.document.close();var r=i.document.querySelectorAll("img"),s=0,d=r.length;function c(){++s>=d&&setTimeout(function(){i.print()},100)}if(0===d)return void setTimeout(function(){i.print()},250);r.forEach(function(e){e.complete?c():(e.onload=c,e.onerror=c)})}(t,n,u)});var _=document.getElementById("batch-print-qr");_&&_.addEventListener("click",function(){mn(c,u,t)});var I=document.getElementById("batch-regen-token");I&&I.addEventListener("click",function(){w("Regenerate batch URL? This will invalidate the current QR code.",function(){R("regenerate_batch_token",{batch_id:c}).then(function(e){S("Batch URL regenerated. Print a new QR code.","success"),Ft(c)}).catch(function(e){S("Failed: "+e.message,"error")})})});var x=document.getElementById("batch-delete-btn");x&&x.addEventListener("click",function(){w("Delete batch "+c+"? This will remove all tasks, readings, and history. This cannot be undone.",function(){x.disabled=!0,x.textContent="Deleting...",R("delete_batch",{batch_id:c}).then(function(){S("Batch "+c+" deleted","success"),X(),Zt=null,Ot(),Dt()}).catch(function(e){x.disabled=!1,x.textContent="Delete Batch",S("Failed: "+e.message,"error")})})})}(e[0].data)}).catch(function(e){Y("Error","<p>Failed to load batch: "+e.message+"</p>")})}var Pt=[],Rt=[],Ut=null,Gt=null;function jt(e,t){var n="<h4>Plato Readings</h4>";return e.length>0?(n+=function(e,t){if(!e||e.length<2)return"";var n=400,a=150,o=30,i=t?new Date(t):new Date(e[0].timestamp),r=e.map(function(e){var t=new Date(e.timestamp);return{day:Math.round((t-i)/864e5),plato:Number(e.degrees_plato)}}),s=Math.max.apply(null,r.map(function(e){return e.day}))||1,d=Math.max.apply(null,r.map(function(e){return e.plato})),c=Math.min.apply(null,r.map(function(e){return e.plato}));d===c&&(d+=1,c=Math.max(0,c-1));var l=d-c,u=r.map(function(e){return o+e.day/s*(n-2*o)+","+(a-o-(e.plato-c)/l*(a-2*o))}).join(" "),m=r.map(function(e){return'<circle cx="'+(o+e.day/s*(n-2*o))+'" cy="'+(a-o-(e.plato-c)/l*(a-2*o))+'" r="3" fill="#5b7f3b"/>'}).join(""),p='<svg viewBox="0 0 '+n+" "+a+'" class="batch-plato-svg">';return p+='<line x1="'+o+'" y1="'+(a-o)+'" x2="'+(n-o)+'" y2="'+(a-o)+'" stroke="#ccc" stroke-width="1"/>',p+='<line x1="'+o+'" y1="'+o+'" x2="'+o+'" y2="'+(a-o)+'" stroke="#ccc" stroke-width="1"/>',p+='<text x="'+o+'" y="'+(a-5)+'" font-size="10" fill="#999">Day 0</text>',p+='<text x="'+(n-o)+'" y="'+(a-5)+'" font-size="10" fill="#999" text-anchor="end">Day '+s+"</text>",p+='<text x="5" y="'+(o+4)+'" font-size="10" fill="#999">'+d.toFixed(1)+"</text>",p+='<text x="5" y="'+(a-o)+'" font-size="10" fill="#999">'+c.toFixed(1)+"</text>",p+='<polyline points="'+u+'" fill="none" stroke="#5b7f3b" stroke-width="2"/>',p+=m,p+="</svg>"}(e,t),n+='<table class="admin-table batch-plato-table"><thead><tr><th>Date</th><th>&deg;P</th><th>Temp</th><th>pH</th><th>Notes</th><th style="width:60px;">Actions</th></tr></thead><tbody>',e.slice().reverse().forEach(function(e){n+='<tr data-reading-id="'+vt(e.reading_id)+'">',n+="<td>"+String(e.timestamp||"").substring(0,10)+"</td>",n+="<td>"+vt(e.degrees_plato)+"</td>",n+="<td>"+vt(null!=e.temperature&&""!==e.temperature?e.temperature:"")+"</td>",n+="<td>"+vt(null!=e.ph&&""!==e.ph?e.ph:"")+"</td>",n+="<td>"+vt(e.notes||"")+"</td>",n+='<td class="plato-actions">',n+='<button type="button" class="plato-edit-btn" title="Edit">&#9998;</button>',n+='<button type="button" class="plato-delete-btn" title="Delete">&times;</button>',n+="</td>",n+="</tr>"}),n+="</tbody></table>"):n+='<p class="admin-order-info">No readings recorded yet.</p>',n+='<div class="batch-plato-add" style="display:flex;gap:0.35rem;flex-wrap:wrap;align-items:center;">',n+='<input type="date" id="plato-date" class="admin-inline-input" style="width:130px;">',n+='<input type="number" id="plato-value" step="0.1" min="0" max="40" placeholder="&deg;P" class="admin-inline-input" style="width:70px;">',n+='<input type="number" id="plato-temp" step="0.1" placeholder="Temp &deg;C" class="admin-inline-input" style="width:90px;">',n+='<input type="number" id="plato-ph" step="0.01" min="0" max="14" placeholder="pH" class="admin-inline-input" style="width:60px;">',n+='<input type="text" id="plato-notes" placeholder="Notes" class="admin-inline-input">',n+='<button type="button" class="btn admin-btn-sm" id="plato-add-row-btn">Add Row</button>',n+="</div>",n+='<div id="plato-staging-wrap">'+zt()+"</div>"}function zt(){if(0===Pt.length)return"";var e='<table class="admin-table batch-plato-table batch-plato-staging"><thead><tr><th>Date</th><th>&deg;P</th><th>Temp</th><th>pH</th><th>Notes</th><th style="width:36px;"></th></tr></thead><tbody>';return Pt.forEach(function(t,n){e+="<tr>",e+="<td>"+vt(t.timestamp)+"</td>",e+="<td>"+vt(t.degrees_plato)+"</td>",e+="<td>"+vt(void 0!==t.temperature?t.temperature:"")+"</td>",e+="<td>"+vt(void 0!==t.ph?t.ph:"")+"</td>",e+="<td>"+vt(t.notes||"")+"</td>",e+='<td><button type="button" class="plato-staging-remove" data-idx="'+n+'" title="Remove">&times;</button></td>',e+="</tr>"}),e+="</tbody></table>",e+='<button type="button" class="btn admin-btn-sm" id="plato-submit-all-btn">Submit All ('+Pt.length+")</button>"}function Vt(){var e=document.getElementById("plato-section");e&&(e.innerHTML=jt(Rt,Ut),Kt(Gt))}function Kt(e){var t=document.getElementById("plato-date");t&&(t.value=kt());var n=document.getElementById("plato-add-row-btn");n&&n.addEventListener("click",function(){var t=parseFloat(document.getElementById("plato-value").value);if(isNaN(t)||t<0||t>40)S("Enter a valid Plato value (0-40)","error");else{var n=document.getElementById("plato-date").value;if(n){var a=document.getElementById("plato-temp").value,o=document.getElementById("plato-ph").value;if(""!==o&&(isNaN(parseFloat(o))||parseFloat(o)<0||parseFloat(o)>14))S("pH must be between 0 and 14","error");else{var i={degrees_plato:t,timestamp:n,notes:document.getElementById("plato-notes").value};""!==a&&(i.temperature=parseFloat(a)),""!==o&&(i.ph=parseFloat(o)),Pt.push(i);var r=document.getElementById("plato-staging-wrap");r&&(r.innerHTML=zt()),Wt(e),document.getElementById("plato-value").value="",document.getElementById("plato-temp").value="",document.getElementById("plato-ph").value="",document.getElementById("plato-notes").value=""}}else S("Enter a date","error")}}),Wt(e),document.querySelectorAll(".plato-edit-btn").forEach(function(t){t.addEventListener("click",function(){var n=t.closest("tr"),a=n.getAttribute("data-reading-id");!function(e,t,n){var a=e.querySelectorAll("td"),o=a[0].textContent.trim(),i=a[1].textContent.trim(),r=a[2].textContent.trim(),s=a[3].textContent.trim(),d=a[4].textContent.trim();a[0].innerHTML='<input type="date" class="admin-inline-input" value="'+vt(o)+'" style="width:120px;">',a[1].innerHTML='<input type="number" class="admin-inline-input" step="0.1" min="0" max="40" value="'+vt(i)+'" style="width:60px;">',a[2].innerHTML='<input type="number" class="admin-inline-input" step="0.1" value="'+vt(r)+'" style="width:70px;">',a[3].innerHTML='<input type="number" class="admin-inline-input" step="0.01" min="0" max="14" value="'+vt(s)+'" style="width:50px;">',a[4].innerHTML='<input type="text" class="admin-inline-input" value="'+vt(d)+'">',a[5].innerHTML='<button type="button" class="btn admin-btn-sm plato-save-edit" style="font-size:0.75rem;padding:2px 6px;">Save</button> <button type="button" class="btn-secondary admin-btn-sm plato-cancel-edit" style="font-size:0.75rem;padding:2px 6px;">Cancel</button>',a[5].querySelector(".plato-cancel-edit").addEventListener("click",function(){Vt()}),a[5].querySelector(".plato-save-edit").addEventListener("click",function(){var e=parseFloat(a[1].querySelector("input").value);if(isNaN(e)||e<0||e>40)S("Plato must be 0-40","error");else{var o=a[3].querySelector("input").value;if(""!==o&&(isNaN(parseFloat(o))||parseFloat(o)<0||parseFloat(o)>14))S("pH must be 0-14","error");else{var i={timestamp:a[0].querySelector("input").value,degrees_plato:e,temperature:""!==a[2].querySelector("input").value?parseFloat(a[2].querySelector("input").value):"",ph:""!==o?parseFloat(o):"",notes:a[4].querySelector("input").value};R("update_plato_reading",{reading_id:t,batch_id:n,updates:i}).then(function(){S("Reading updated","success");for(var e=0;e<Rt.length;e++)if(Rt[e].reading_id===t){Rt[e].timestamp=i.timestamp,Rt[e].degrees_plato=i.degrees_plato,Rt[e].temperature=i.temperature,Rt[e].ph=i.ph,Rt[e].notes=i.notes;break}Vt()}).catch(function(e){S("Failed: "+e.message,"error")})}}})}(n,a,e)})}),document.querySelectorAll(".plato-delete-btn").forEach(function(t){t.addEventListener("click",function(){var n=t.closest("tr").getAttribute("data-reading-id");confirm("Delete this reading?")&&R("delete_plato_reading",{reading_id:n,batch_id:e}).then(function(){S("Reading deleted","success"),Rt=Rt.filter(function(e){return e.reading_id!==n}),Vt()}).catch(function(e){S("Failed: "+e.message,"error")})})})}function Wt(e){document.querySelectorAll(".plato-staging-remove").forEach(function(t){t.addEventListener("click",function(){var n=parseInt(t.getAttribute("data-idx"),10);Pt.splice(n,1);var a=document.getElementById("plato-staging-wrap");a&&(a.innerHTML=zt()),Wt(e)})});var t=document.getElementById("plato-submit-all-btn");t&&t.addEventListener("click",function(){if(0!==Pt.length){t.disabled=!0,t.textContent="Submitting...";var n=Pt.slice();R("bulk_add_plato_readings",{batch_id:e,readings:n}).then(function(e){S(n.length+" reading"+(1!==n.length?"s":"")+" recorded","success");var t=e&&e.results||[];n.forEach(function(e,n){var a=t[n]&&t[n].reading_id||"pending-"+Date.now()+"-"+n;Rt.push({reading_id:a,degrees_plato:e.degrees_plato,timestamp:e.timestamp,temperature:e.temperature,ph:e.ph,notes:e.notes||""})}),Pt=[],Vt()}).catch(function(e){S("Failed: "+e.message,"error"),t.disabled=!1,t.textContent="Submit All ("+Pt.length+")"})}else S("No readings to submit","error")})}function $t(){0===Ct.length?Ht(function(){an()}):an()}var Zt=null,Jt=null;function Qt(e){P("get_vessels").then(function(t){Zt=t.data&&t.data.vessels||[],e&&e()}).catch(function(){Zt=[],e&&e()})}function Yt(e){var t=[String(e.vessel_id||"")];return e.type&&t.push(e.type),e.capacity_liters&&t.push(e.capacity_liters+"L"),e.material&&t.push(e.material),t.join(" — ")}function Xt(e,t,n,a){var o;e.addEventListener("focus",function(){e.value.trim()||en("",t,n,e,a)}),e.addEventListener("input",function(){clearTimeout(o),o=setTimeout(function(){en(e.value.trim().toLowerCase(),t,n,e,a)},150)}),e.addEventListener("keydown",function(t){"Backspace"===t.key&&""===e.value&&(n.value="")})}function en(e,t,n,a,o){if(Zt){var i=Zt.filter(function(t){var n=String(t.vessel_id||""),a=String(t.status||"").toLowerCase();return(!a||"available"===a||"empty"===a||n===o)&&(!e||-1!==(n+" "+(t.type||"")+" "+(t.capacity_liters||"")+" "+(t.material||"")+" "+(t.location||"")).toLowerCase().indexOf(e))});if(0===i.length)return t.innerHTML='<div class="admin-kit-search-option" style="color:var(--ink-tertiary);">No available vessels found</div>',void(t.style.display="");var r="";i.forEach(function(e){var t=String(e.vessel_id||""),n=Yt(e),a=e.location?' <span class="batch-cust-email-hint">'+e.location+"</span>":"";r+='<div class="admin-kit-search-option" data-vid="'+t+'">'+n+a+(t===o?' <span class="batch-cust-email-hint">(current)</span>':"")+"</div>"}),t.innerHTML=r,t.style.display="",t.querySelectorAll(".admin-kit-search-option").forEach(function(e){e.addEventListener("mousedown",function(o){o.preventDefault();var i=e.getAttribute("data-vid");if(i){n.value=i;var r=Zt.find(function(e){return String(e.vessel_id)===i});a.value=r?Yt(r):i,t.style.display="none"}})})}else t.style.display="none"}function tn(e){e.setAttribute("maxlength","1"),e.addEventListener("input",function(){e.value=e.value.replace(/[^a-zA-Z]/g,"").toUpperCase()}),e.addEventListener("blur",function(){e.value=e.value.replace(/[^a-zA-Z]/g,"").toUpperCase()})}function nn(e){e.setAttribute("maxlength","2"),e.addEventListener("input",function(){e.value=e.value.replace(/[^0-9]/g,"")}),e.addEventListener("blur",function(){var t=parseInt(e.value,10);isNaN(t)||t<1?e.value="":(t>36&&(e.value="36",t=36),e.value=t<10?"0"+t:String(t))})}function an(){Zt?on():Qt(function(){on()})}function on(){var e='<div class="batch-create-form">';e+='<div class="form-group"><label>Product</label>',e+='<div class="admin-kit-search-wrap" id="batch-product-search-wrap">',e+='<input type="text" id="batch-product-search" class="admin-kit-search-input" placeholder="Search by name or SKU..." autocomplete="off">',e+='<div class="admin-kit-search-dropdown" id="batch-product-dropdown" style="display:none;"></div>',e+='<input type="hidden" id="batch-product-sku" value="">',e+='<input type="hidden" id="batch-product-name" value="">',e+="</div></div>",e+='<div class="form-group"><label>Customer</label>',e+='<div class="admin-kit-search-wrap" id="batch-customer-search-wrap">',e+='<input type="text" id="batch-customer-search" class="admin-kit-search-input" placeholder="Search Zoho contacts or type new name..." autocomplete="off">',e+='<div class="admin-kit-search-dropdown" id="batch-customer-dropdown" style="display:none;"></div>',e+='<input type="hidden" id="batch-customer-id" value="">',e+='<input type="hidden" id="batch-customer-name" value="">',e+='<input type="hidden" id="batch-customer-email-val" value="">',e+="</div></div>",e+='<div id="batch-customer-info" class="batch-customer-info" style="display:none;"></div>',e+='<div class="form-group"><label>Start Date</label><input type="date" id="batch-start-date" class="admin-input" value="'+kt()+'"></div>',e+='<div class="form-group"><label>Fermentation Schedule</label><select id="batch-schedule-select" class="admin-select"><option value="">Select a template...</option>',Ct.forEach(function(t){e+='<option value="'+t.schedule_id+'">'+t.name+(t.category?" ("+t.category+")":"")+"</option>"}),e+="</select></div>",e+='<div id="batch-schedule-preview" class="batch-schedule-preview"></div>',e+='<div class="form-group form-group-row">',e+='<div style="flex:2;"><label>Vessel</label>',e+='<div class="admin-kit-search-wrap" id="batch-vessel-search-wrap">',e+='<input type="text" id="batch-vessel-search" class="admin-kit-search-input" placeholder="Search vessels..." autocomplete="off">',e+='<div class="admin-kit-search-dropdown" id="batch-vessel-dropdown" style="display:none;"></div>',e+='<input type="hidden" id="batch-vessel" value="">',e+="</div></div>",e+='<div><label>Shelf</label><input type="text" id="batch-shelf" class="admin-input" placeholder="A"></div>',e+='<div><label>Bin</label><input type="text" id="batch-bin" class="admin-input" placeholder="01"></div>',e+="</div>",e+='<div class="form-group"><label>Notes</label><textarea id="batch-create-notes" class="admin-input" rows="2"></textarea></div>',e+='<button type="button" class="btn" id="batch-submit-create">Create Batch</button>',Y("New Fermentation Batch",e+="</div>");var t,n="undefined"!=typeof SHEETS_CONFIG&&SHEETS_CONFIG.MIDDLEWARE_URL?SHEETS_CONFIG.MIDDLEWARE_URL:"",a=document.getElementById("batch-product-search"),o=document.getElementById("batch-product-dropdown");!Jt&&n&&fetch(n+"/api/products").then(function(e){return e.json()}).then(function(e){Jt=e.items||[]}).catch(function(){Jt=[]}),a.addEventListener("input",function(){clearTimeout(t),t=setTimeout(function(){var e=a.value.toLowerCase();e.length<2?o.style.display="none":function(e,t){if(0===e.length)return o.innerHTML='<div class="admin-kit-search-option" style="color:var(--ink-tertiary);">No products match "'+t+'"</div>',void(o.style.display="");var n="";e.forEach(function(e){var t=e.sku||"",a=e.name||"";n+='<div class="admin-kit-search-option" data-sku="'+t+'" data-name="'+a+'">'+t+" — "+a+"</div>"}),o.innerHTML=n,o.style.display="",o.querySelectorAll(".admin-kit-search-option").forEach(function(e){e.addEventListener("mousedown",function(t){t.preventDefault(),document.getElementById("batch-product-sku").value=e.getAttribute("data-sku"),document.getElementById("batch-product-name").value=e.getAttribute("data-name"),a.value=e.getAttribute("data-sku")+" — "+e.getAttribute("data-name"),o.style.display="none"})})}((Jt||[]).filter(function(t){return-1!==((t.name||"")+" "+(t.sku||"")).toLowerCase().indexOf(e)}).slice(0,10),e)},200)});var i,r=document.getElementById("batch-customer-search"),s=document.getElementById("batch-customer-dropdown"),d=document.getElementById("batch-customer-info");function c(e,t,n){if(document.getElementById("batch-customer-name").value=e,document.getElementById("batch-customer-email-val").value=t||"",document.getElementById("batch-customer-id").value=n||"",r.value=e,s.style.display="none",t||n){var a='<span class="batch-customer-tag">'+e+"</span>";t&&(a+='<span class="batch-customer-email">'+t+"</span>"),n&&(a+='<span class="batch-customer-zoho">Zoho: '+n+"</span>"),a+='<button type="button" class="btn-secondary admin-btn-sm batch-customer-clear">&times; Clear</button>',d.innerHTML=a,d.style.display="",d.querySelector(".batch-customer-clear").addEventListener("click",function(){document.getElementById("batch-customer-name").value="",document.getElementById("batch-customer-email-val").value="",document.getElementById("batch-customer-id").value="",r.value="",d.style.display="none",r.focus()})}else d.style.display="none"}r.addEventListener("input",function(){clearTimeout(i),i=setTimeout(function(){var e=r.value.trim();if(!(e.length<2))return n?void fetch(n+"/api/contacts?search="+encodeURIComponent(e)).then(function(e){return e.json()}).then(function(t){var n=t.contacts||[],a="";n.slice(0,8).forEach(function(e){var t=e.contact_name||"",n=e.email||"",o=e.contact_id||"";a+='<div class="admin-kit-search-option batch-cust-option" data-name="'+t.replace(/"/g,"&quot;")+'" data-email="'+n.replace(/"/g,"&quot;")+'" data-id="'+o+'">',a+="<strong>"+t+"</strong>",n&&(a+=' <span class="batch-cust-email-hint">'+n+"</span>"),a+="</div>"}),a+='<div class="admin-kit-search-option batch-cust-new" data-name="'+e.replace(/"/g,"&quot;")+'">+ New customer: "'+e+'"</div>',s.innerHTML=a,s.style.display="",s.querySelectorAll(".batch-cust-option").forEach(function(e){e.addEventListener("mousedown",function(t){t.preventDefault(),c(e.getAttribute("data-name"),e.getAttribute("data-email"),e.getAttribute("data-id"))})}),s.querySelector(".batch-cust-new").addEventListener("mousedown",function(t){t.preventDefault(),c(e,"","")})}).catch(function(){s.innerHTML='<div class="admin-kit-search-option batch-cust-new" data-name="'+e.replace(/"/g,"&quot;")+'">Use "'+e+'" as new customer</div>',s.style.display="",s.querySelector(".batch-cust-new").addEventListener("mousedown",function(t){t.preventDefault(),c(e,"","")})}):(s.innerHTML='<div class="admin-kit-search-option batch-cust-new" data-name="'+e.replace(/"/g,"&quot;")+'">Use "'+e+'" as new customer</div>',s.style.display="",void s.querySelector(".batch-cust-new").addEventListener("mousedown",function(t){t.preventDefault(),c(e,"","")}));s.style.display="none"},300)});var l=document.getElementById("batch-vessel-search"),u=document.getElementById("batch-vessel-dropdown"),m=document.getElementById("batch-vessel");Xt(l,u,m,""),tn(document.getElementById("batch-shelf")),nn(document.getElementById("batch-bin")),te("click",function(e){s.contains(e.target)||e.target===r||(s.style.display="none"),o.contains(e.target)||e.target===a||(o.style.display="none"),u.contains(e.target)||e.target===l||(u.style.display="none")}),document.getElementById("batch-schedule-select").addEventListener("change",function(){var e=this.value,t=document.getElementById("batch-schedule-preview"),n=Ct.find(function(t){return t.schedule_id===e});if(n){var a=n.steps_parsed||[];if(!a.length&&n.steps)try{a=JSON.parse(n.steps)}catch(e){}var o='<div class="schedule-preview-steps">';a.forEach(function(e){var t=e.is_packaging?"TBD":"Day "+e.day_offset,n="";e.is_transfer&&(n+=' <span class="batch-task-badge batch-task-badge--transfer">Transfer</span>'),e.is_packaging&&(n+=' <span class="batch-task-badge batch-task-badge--pkg">Packaging</span>'),o+='<div class="schedule-preview-step"><strong>'+t+":</strong> "+e.title+n+(e.description?" — "+e.description:"")+"</div>"}),o+="</div>",t.innerHTML=o}else t.innerHTML=""}),document.getElementById("batch-submit-create").addEventListener("click",function(){var e=document.getElementById("batch-product-sku").value,t=document.getElementById("batch-product-name").value,a=document.getElementById("batch-customer-name").value||r.value.trim(),o=document.getElementById("batch-customer-email-val").value,i=document.getElementById("batch-customer-id").value,s=document.getElementById("batch-schedule-select").value,d=document.getElementById("batch-start-date").value;if(e)if(a)if(s)if(d){var c=document.getElementById("batch-submit-create");c.disabled=!0,c.textContent="Creating...",!i&&n&&o?fetch(n+"/api/contacts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:a,email:o})}).then(function(e){return e.json()}).then(function(e){e.contact_id?(document.getElementById("batch-customer-id").value=e.contact_id,l(e.contact_id)):l("")}).catch(function(){l("")}):l(i||!n||o?i:"")}else S("Enter a start date","error");else S("Select a schedule","error");else S("Enter customer name","error");else S("Select a product","error");function l(n){R("create_batch",{product_sku:e,product_name:t,customer_id:n||i,customer_name:a,customer_email:o,start_date:d,schedule_id:s,vessel_id:document.getElementById("batch-vessel").value,shelf_id:document.getElementById("batch-shelf").value,bin_id:document.getElementById("batch-bin").value,notes:document.getElementById("batch-create-notes").value}).then(function(e){S("Batch "+e.batch_id+" created with "+e.tasks_created+" tasks","success"),X(),Zt=null,Ot(),Dt()}).catch(function(e){c.disabled=!1,c.textContent="Create Batch",S("Failed: "+e.message,"error")})}})}function rn(){var e=document.getElementById("schedules-list"),t=document.getElementById("schedules-empty");if(e){if(0===Ct.length)return e.innerHTML="",void(t&&(t.style.display=""));t&&(t.style.display="none");var n="";Ct.forEach(function(e){var t=e.steps_parsed||[];if(!t.length&&e.steps)try{t=JSON.parse(e.steps)}catch(e){}n+='<div class="schedule-card">',n+='<div class="schedule-card-header">',n+="<strong>"+(e.name||"Untitled")+"</strong>",n+='<span class="schedule-card-actions">',n+='<button type="button" class="btn-secondary admin-btn-sm sched-edit-btn" data-sched-id="'+e.schedule_id+'">Edit</button>',n+='<button type="button" class="btn-secondary admin-btn-sm admin-btn-danger sched-delete-btn" data-sched-id="'+e.schedule_id+'">Delete</button>',n+="</span>",n+="</div>",e.category&&(n+='<div class="schedule-card-meta">Category: '+e.category+"</div>"),n+='<div class="schedule-card-meta">'+t.length+" steps</div>",n+='<div class="schedule-card-steps">',t.forEach(function(e){var t=e.is_packaging?"TBD":"Day "+e.day_offset,a="";e.is_transfer&&(a+=' <span class="batch-task-badge batch-task-badge--transfer">Transfer</span>'),e.is_packaging&&(a+=' <span class="batch-task-badge batch-task-badge--pkg">Packaging</span>'),n+='<div class="schedule-step-line"><span class="schedule-step-day">'+t+"</span> "+e.title+a+"</div>"}),n+="</div></div>"}),e.innerHTML=n,e.querySelectorAll(".sched-edit-btn").forEach(function(e){e.addEventListener("click",function(){!function(e){var t=Ct.find(function(t){return t.schedule_id===e});if(!t)return void S("Schedule not found","error");dn(t)}(e.getAttribute("data-sched-id"))})}),e.querySelectorAll(".sched-delete-btn").forEach(function(e){e.addEventListener("click",function(){var t=e.getAttribute("data-sched-id");w("Delete this schedule template?",function(){R("delete_ferm_schedule",{schedule_id:t}).then(function(){S("Schedule deleted","success"),Ht()}).catch(function(e){S("Failed: "+e.message,"error")})})})})}}function sn(){dn(null)}function dn(e){var t=!!e,n=[],a="Bottling / Packaging",o="";if(e){var i=e.steps_parsed||[];if(!i.length&&e.steps)try{i=JSON.parse(e.steps)}catch(e){}i.forEach(function(e){e.is_packaging?(a=e.title||a,o=e.description||o):n.push(e)})}0===n.length&&(n=[{step_number:1,day_offset:0,title:"",description:""}]);var r='<div class="schedule-form">';r+='<div class="form-group"><label>Template Name</label><input type="text" id="sched-name" class="admin-input" value="'+(e&&e.name||"")+'"></div>',r+='<div class="form-group"><label>Description</label><textarea id="sched-desc" class="admin-input" rows="2">'+(e&&e.description||"")+"</textarea></div>",r+='<div class="form-group"><label>Category</label><select id="sched-category" class="admin-select">',r+='<option value="">None</option>',["wine","beer","cider","seltzer"].forEach(function(t){r+='<option value="'+t+'"'+(e&&e.category===t?" selected":"")+">"+t.charAt(0).toUpperCase()+t.slice(1)+"</option>"}),r+="</select></div>",r+="<h4>Fermentation Steps</h4>",r+='<p class="sched-form-hint">Add each step with its day offset from the start date. Steps are sorted by day automatically. Check "Transfer" if the step involves moving to a new vessel.</p>',r+='<div class="sched-steps-header"><span class="sched-col-day">Day</span><span class="sched-col-title">Title</span><span class="sched-col-desc">Description</span><span class="sched-col-transfer">Transfer</span><span class="sched-col-actions"></span></div>',r+='<div id="sched-steps-container"></div>',r+='<button type="button" class="btn-secondary admin-btn-sm" id="sched-add-step">+ Add Step</button>',r+='<h4>Packaging Step <span class="sched-pkg-note">(always last, date TBD until all other steps are done)</span></h4>',r+='<div class="sched-pkg-row">',r+='<input type="text" id="sched-pkg-title" class="admin-inline-input" value="'+a+'" placeholder="Title" style="flex:1;">',r+='<input type="text" id="sched-pkg-desc" class="admin-inline-input" value="'+o+'" placeholder="Description (optional)" style="flex:1;">',r+="</div>",r+="<br>",r+='<button type="button" class="btn" id="sched-submit">'+(t?"Update Template":"Create Template")+"</button>",Y((t?"Edit":"New")+" Schedule Template",r+="</div>");var s=document.getElementById("sched-steps-container");function d(){var e="";Tt.forEach(function(t,n){e+='<div class="sched-step-row" data-idx="'+n+'">',e+='<input type="number" class="admin-inline-input sched-step-day" value="'+t.day_offset+'" placeholder="Day" min="0" style="width:60px;">',e+='<input type="text" class="admin-inline-input sched-step-title" value="'+(t.title||"")+'" placeholder="Step title" style="flex:1;">',e+='<input type="text" class="admin-inline-input sched-step-desc" value="'+(t.description||"")+'" placeholder="Description (optional)" style="flex:1;">',e+='<label class="sched-transfer-check"><input type="checkbox" class="sched-step-transfer"'+(t.is_transfer?" checked":"")+"></label>",e+='<button type="button" class="btn-secondary admin-btn-sm admin-btn-danger sched-step-remove" title="Remove step">&times;</button>',e+="</div>"}),s.innerHTML=e,s.querySelectorAll(".sched-step-row").forEach(function(e){var t=parseInt(e.getAttribute("data-idx"),10);e.querySelector(".sched-step-day").addEventListener("change",function(){Tt[t].day_offset=parseInt(this.value,10)||0}),e.querySelector(".sched-step-title").addEventListener("change",function(){Tt[t].title=this.value}),e.querySelector(".sched-step-desc").addEventListener("change",function(){Tt[t].description=this.value}),e.querySelector(".sched-step-transfer").addEventListener("change",function(){Tt[t].is_transfer=this.checked}),e.querySelector(".sched-step-remove").addEventListener("click",function(){Tt.length<=1?S("Need at least 1 fermentation step","error"):(Tt.splice(t,1),d())})})}Tt=n.slice(),d(),document.getElementById("sched-add-step").addEventListener("click",function(){var e=0;Tt.forEach(function(t){t.day_offset>e&&(e=t.day_offset)}),Tt.push({step_number:0,day_offset:e+7,title:"",description:""}),d()}),document.getElementById("sched-submit").addEventListener("click",function(){var n=document.getElementById("sched-name").value;if(n){s.querySelectorAll(".sched-step-row").forEach(function(e){var t=parseInt(e.getAttribute("data-idx"),10);Tt[t].day_offset=parseInt(e.querySelector(".sched-step-day").value,10)||0,Tt[t].title=e.querySelector(".sched-step-title").value,Tt[t].description=e.querySelector(".sched-step-desc").value,Tt[t].is_transfer=e.querySelector(".sched-step-transfer").checked});var a=!1;if(Tt.forEach(function(e){e.title.trim()||(a=!0)}),a)S("Every step needs a title","error");else{var o=Tt.slice().sort(function(e,t){return e.day_offset-t.day_offset}).map(function(e,t){return{step_number:t+1,day_offset:e.day_offset,title:e.title,description:e.description,is_packaging:!1,is_transfer:!!e.is_transfer}});o.push({step_number:o.length+1,day_offset:-1,title:document.getElementById("sched-pkg-title").value||"Bottling / Packaging",description:document.getElementById("sched-pkg-desc").value||"",is_packaging:!0});var i={name:n,description:document.getElementById("sched-desc").value,category:document.getElementById("sched-category").value,steps:o},r=t?"update_ferm_schedule":"create_ferm_schedule";t&&(i.schedule_id=e.schedule_id);var d=document.getElementById("sched-submit");d.disabled=!0,d.textContent="Saving...",R(r,i).then(function(n){if(S("Schedule "+(t?"updated":"created"),"success"),X(),Ht(),t){var a=It.filter(function(t){var n=(t.status||"").toLowerCase();return String(t.schedule_id)===String(e.schedule_id)&&("primary"===n||"secondary"===n)});a.length>0&&w("Apply template changes to "+a.length+" active batch"+(1===a.length?"":"es")+"? Completed tasks will not be changed.",function(){R("propagate_ferm_schedule",{schedule_id:e.schedule_id,steps:o}).then(function(e){var t="Propagated to "+e.batches_updated+" batch"+(1===e.batches_updated?"":"es");e.tasks_updated&&(t+=", "+e.tasks_updated+" updated"),e.tasks_created&&(t+=", "+e.tasks_created+" added"),e.tasks_removed&&(t+=", "+e.tasks_removed+" removed"),S(t,"success"),Ot()}).catch(function(e){S("Propagation failed: "+e.message,"error")})})}}).catch(function(e){d.disabled=!1,d.textContent=t?"Update Template":"Create Template",S("Failed: "+e.message,"error")})}}else S("Enter a template name","error")})}function cn(e,t){if(void 0!==e&&void 0!==t){new Date(e,t,1);var n=new Date(e,t+1,0),a=function(e){return e<10?"0"+e:""+e},o=e+"-"+a(t+1)+"-01",i=e+"-"+a(t+1)+"-"+a(n.getDate()),r=document.getElementById("cal-month-label");r&&(r.textContent=["January","February","March","April","May","June","July","August","September","October","November","December"][t]+" "+e),P("get_tasks_calendar",{start_date:o,end_date:i}).then(function(n){At=Date.now();var a=n.data&&n.data.tasks||[],o={};a.forEach(function(e){e.due_date&&(o[e.due_date]||(o[e.due_date]=[]),o[e.due_date].push(e))}),function(e,t,n){var a=document.getElementById("batch-calendar-grid");if(!a)return;var o=kt(),i="";["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].forEach(function(e){i+='<div class="batch-cal-header">'+e+"</div>"});for(var r=new Date(e,t,1),s=new Date(e,t+1,0),d=r.getDay(),c=0;c<d;c++)i+='<div class="batch-cal-day batch-cal-day--other-month"></div>';for(var l=function(e){return e<10?"0"+e:""+e},u=1;u<=s.getDate();u++){var m=e+"-"+l(t+1)+"-"+l(u),p=m===o,f=n[m]||[],h="batch-cal-day";p&&(h+=" batch-cal-day--today"),i+='<div class="'+h+'" data-date="'+m+'">',i+='<div class="batch-cal-day-num">'+u+"</div>";var v=0;f.forEach(function(e){if(!(v>=3)){var t="batch-cal-task";e.completed?t+=" batch-cal-task--done":e.due_date<o?t+=" batch-cal-task--overdue":t+=" batch-cal-task--pending",i+='<div class="'+t+'">'+vt(e.title)+"</div>",v++}}),f.length>3&&(i+='<div class="batch-cal-task-count">+'+(f.length-3)+" more</div>"),i+="</div>"}a.innerHTML=i,a.querySelectorAll(".batch-cal-day[data-date]").forEach(function(e){e.addEventListener("click",function(){a.querySelectorAll(".batch-cal-day--selected").forEach(function(e){e.classList.remove("batch-cal-day--selected")}),e.classList.add("batch-cal-day--selected");var t=e.getAttribute("data-date");!function(e,t){var n=document.getElementById("batch-calendar-day-detail");if(!n)return;if(0===t.length)return void(n.innerHTML='<p class="admin-order-info">No tasks on '+e+"</p>");var a=kt(),o="<h3>"+e+" — "+t.length+" task"+(1!==t.length?"s":"")+"</h3>";t.forEach(function(e){var t=e.completed?" batch-cal-detail--done":"",n=!e.completed&&e.due_date&&e.due_date<a?" batch-cal-detail--overdue":"";o+='<div class="batch-cal-detail-task'+t+n+'">',o+='<label><input type="checkbox" '+(e.completed?"checked":"")+' data-task-id="'+e.task_id+'" data-batch-id="'+e.batch_id+'"> ',o+="<strong>"+vt(e.title)+"</strong></label>",o+=" — "+vt(e.batch_id)+" ("+vt(e.product_name||"")+")",o+=" — "+vt(e.vessel_id||"")+"/"+vt(e.shelf_id||""),o+="</div>"}),o+='<div id="cal-save-bar" style="display:none;padding:0.5rem 0;text-align:right;"><button type="button" class="btn admin-btn-sm" id="cal-save-btn">Save Tasks</button></div>',n.innerHTML=o;var i={};function r(){var e=document.getElementById("cal-save-bar"),t=document.getElementById("cal-save-btn"),n=Object.keys(i).length;e&&(e.style.display=n>0?"":"none"),t&&(t.textContent="Save Tasks ("+n+")")}n.querySelectorAll('input[type="checkbox"]').forEach(function(e){var t=e.checked;e.addEventListener("change",function(){var n=e.getAttribute("data-task-id");e.checked===t?delete i[n]:i[n]=e.checked;var a=e.closest(".batch-cal-detail-task");a&&a.classList.toggle("batch-cal-detail--done",e.checked),r()})});var s=document.getElementById("cal-save-btn");s&&s.addEventListener("click",function(){var e=Object.keys(i).map(function(e){return{task_id:e,updates:{completed:i[e]}}});s.disabled=!0,s.textContent="Saving...",R("bulk_update_batch_tasks",{tasks:e}).then(function(){S(e.length+" task"+(1!==e.length?"s":"")+" updated","success"),cn(_t,St)}).catch(function(e){S("Failed: "+e.message,"error"),s.disabled=!1,r()})})}(t,n[t]||[])})})}(e,t,o)}).catch(function(e){S("Failed to load calendar: "+e.message,"error")})}}function ln(){P("get_tasks_upcoming",{limit:50}).then(function(e){Nt=Date.now(),function(e){var t=document.getElementById("upcoming-tasks-list"),n=document.getElementById("upcoming-empty");if(!t)return;if(0===e.length)return t.innerHTML="",void(n&&(n.style.display=""));n&&(n.style.display="none");var a=kt(),o=kt(1),i=kt(7),r={overdue:{label:"Overdue",tasks:[]},today:{label:"Today",tasks:[]},tomorrow:{label:"Tomorrow",tasks:[]},thisWeek:{label:"This Week",tasks:[]},later:{label:"Later",tasks:[]},tbd:{label:"TBD (Packaging)",tasks:[]}};e.forEach(function(e){e.due_date?e.due_date<a?r.overdue.tasks.push(e):e.due_date===a?r.today.tasks.push(e):e.due_date===o?r.tomorrow.tasks.push(e):e.due_date<=i?r.thisWeek.tasks.push(e):r.later.tasks.push(e):r.tbd.tasks.push(e)});var s='<div id="upcoming-save-bar-top" style="display:none;padding:0.5rem 0;text-align:right;"><button type="button" class="btn admin-btn-sm" id="upcoming-save-btn-top">Save Tasks</button></div>';["overdue","today","tomorrow","thisWeek","later","tbd"].forEach(function(e){var t=r[e];0!==t.tasks.length&&(s+='<div class="upcoming-group">',s+='<h3 class="upcoming-group-label'+("overdue"===e?" upcoming-group-label--overdue":"")+'">'+t.label+" ("+t.tasks.length+")</h3>",t.tasks.forEach(function(e){var t="TRUE"===String(e.is_transfer).toUpperCase(),n=[e.shelf_id,e.bin_id,e.vessel_id].filter(Boolean).join(" - ");s+='<div class="upcoming-task-row">',s+='<label><input type="checkbox" data-task-id="'+vt(e.task_id)+'" data-batch-id="'+vt(e.batch_id)+'" data-is-transfer="'+(t?"1":"")+'" data-title="'+vt(e.title)+'" data-product="'+vt(e.product_name||"")+'" data-loc="'+vt(n)+'"> ',s+="<strong>"+vt(e.title)+"</strong></label>",s+='<a href="#" class="upcoming-task-meta upcoming-batch-link" data-batch-id="'+vt(e.batch_id)+'">'+vt(e.batch_id)+" — "+vt(e.product_name||"")+"</a>",s+='<span class="upcoming-task-loc">'+[e.shelf_id,e.bin_id,e.vessel_id].filter(Boolean).join(" - ")+"</span>",e.due_date&&(s+='<span class="upcoming-task-date">'+String(e.due_date).substring(0,10)+"</span>"),s+="</div>"}),s+="</div>")}),s+='<div id="upcoming-save-bar" style="display:none;padding:0.5rem 0;text-align:right;"><button type="button" class="btn admin-btn-sm" id="upcoming-save-btn">Save Tasks</button></div>',t.innerHTML=s;var d={};function c(){var e=Object.keys(d).length,t="Save Tasks ("+e+")",n=e>0,a=document.getElementById("upcoming-save-bar"),o=document.getElementById("upcoming-save-btn");a&&(a.style.display=n?"":"none"),o&&(o.textContent=t);var i=document.getElementById("upcoming-save-bar-top"),r=document.getElementById("upcoming-save-btn-top");i&&(i.style.display=n?"":"none"),r&&(r.textContent=t)}function l(){var e=Object.keys(d).map(function(e){return d[e]}),t=e.filter(function(e){return e.is_transfer}),n='<div class="upcoming-confirm-list">';e.forEach(function(e){var t=e.task_id.replace(/[^a-z0-9]/gi,"_");n+='<div class="upcoming-confirm-item'+(e.is_transfer?" upcoming-confirm-item--transfer":"")+'">',n+='<div class="upcoming-confirm-task-name"><strong>'+vt(e.title)+"</strong>",e.is_transfer&&(n+=' <span class="batch-task-badge batch-task-badge--transfer">Transfer</span>'),n+="</div>",n+='<div class="upcoming-confirm-task-meta">'+vt(e.batch_id)+(e.product?" — "+vt(e.product):"")+(e.loc?" · "+vt(e.loc):"")+"</div>",e.is_transfer&&(n+='<div class="form-group-row upcoming-transfer-fields">',n+='<div style="flex:2"><label style="font-size:11px;display:block;margin-bottom:2px;">Transfer to Vessel</label>',n+='<div class="admin-kit-search-wrap" id="xfer-vessel-wrap-'+t+'">',n+='<input type="text" id="xfer-vessel-search-'+t+'" class="admin-inline-input" placeholder="Search vessels…" autocomplete="off">',n+='<div class="admin-kit-search-dropdown" id="xfer-vessel-dropdown-'+t+'" style="display:none;"></div>',n+='<input type="hidden" id="xfer-vessel-'+t+'" value=""></div></div>',n+='<div><label style="font-size:11px;display:block;margin-bottom:2px;">Shelf</label><input type="text" id="xfer-shelf-'+t+'" class="admin-inline-input" placeholder="A"></div>',n+='<div><label style="font-size:11px;display:block;margin-bottom:2px;">Bin</label><input type="text" id="xfer-bin-'+t+'" class="admin-inline-input" placeholder="01"></div>',n+="</div>"),n+="</div>"}),n+="</div>",n+='<div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end;">',n+='<button type="button" class="btn" id="upcoming-confirm-save-btn">Mark Complete</button>',n+='<button type="button" class="btn-secondary" id="upcoming-confirm-cancel-btn">Cancel</button>',n+="</div>",Y("Confirm "+e.length+" task"+(1!==e.length?"s":"")+" complete",n),t.forEach(function(e){var t=e.task_id.replace(/[^a-z0-9]/gi,"_"),n=document.getElementById("xfer-vessel-search-"+t),a=document.getElementById("xfer-vessel-dropdown-"+t),o=document.getElementById("xfer-vessel-"+t);n&&a&&o&&Xt(n,a,o,"");var i=document.getElementById("xfer-shelf-"+t),r=document.getElementById("xfer-bin-"+t);i&&tn(i),r&&nn(r)});var a=document.getElementById("upcoming-confirm-cancel-btn");a&&a.addEventListener("click",X);var o=document.getElementById("upcoming-confirm-save-btn");o&&o.addEventListener("click",function(){o.disabled=!0,o.textContent="Saving…";var n=e.map(function(e){var t={task_id:e.task_id,updates:{completed:!0}};if(e.is_transfer){var n=e.task_id.replace(/[^a-z0-9]/gi,"_"),a=(document.getElementById("xfer-vessel-"+n)||{}).value||"",o=(document.getElementById("xfer-shelf-"+n)||{}).value||"",i=(document.getElementById("xfer-bin-"+n)||{}).value||"";a&&(t.transfer_location={vessel_id:a,shelf_id:o,bin_id:i})}return R("update_batch_task",t)});Promise.all(n).then(function(){X(),S(e.length+" task"+(1!==e.length?"s":"")+" updated","success"),t.length>0&&(Zt=null),ln()}).catch(function(e){o.disabled=!1,o.textContent="Mark Complete",S("Failed: "+e.message,"error")})})}t.querySelectorAll('input[type="checkbox"]').forEach(function(e){e.addEventListener("change",function(){var t=e.getAttribute("data-task-id");e.checked?d[t]={task_id:t,batch_id:e.getAttribute("data-batch-id"),is_transfer:"1"===e.getAttribute("data-is-transfer"),title:e.getAttribute("data-title"),product:e.getAttribute("data-product"),loc:e.getAttribute("data-loc")}:delete d[t];var n=e.closest(".upcoming-task-row");n&&n.classList.toggle("upcoming-task-row--pending",e.checked),c()})});var u=document.getElementById("upcoming-save-btn");u&&u.addEventListener("click",l);var m=document.getElementById("upcoming-save-btn-top");m&&m.addEventListener("click",l);t.querySelectorAll(".upcoming-batch-link").forEach(function(e){e.addEventListener("click",function(t){t.preventDefault(),Ft(e.getAttribute("data-batch-id"))})})}(e.data&&e.data.tasks||[])}).catch(function(e){S("Failed to load tasks: "+e.message,"error")})}function un(e,t){var n=window.location.origin+"/batch.html?id="+encodeURIComponent(e)+"&token="+encodeURIComponent(t),a=qrcode(0,"M");return a.addData(n),a.make(),a}function mn(e,t,n){if("undefined"!=typeof qrcode){var a=un(e,t).createSvgTag(8),o=window.open("","_blank");o.document.write("<html><head><title>Batch "+e+'</title><style>body{font-family:sans-serif;text-align:center;padding:20px;margin:0;}.label{border:2px solid #333;padding:15px;display:inline-block;}.qr{margin:10px auto;}.info{margin:4px 0;font-size:14px;}.batch-id{font-size:18px;font-weight:bold;margin-bottom:8px;}@media print{.label{border:none;}}</style></head><body><div class="label"><div class="batch-id">'+e+'</div><div class="qr">'+a+'</div><div class="info"><strong>'+vt(n.product_name||"")+'</strong></div><div class="info">'+vt(n.customer_name||"")+'</div><div class="info">Started: '+vt(n.start_date||"")+'</div><div class="info">Shelf: '+vt(n.shelf_id||"?")+" | Bin: "+vt(n.bin_id||"?")+" | Vessel: "+vt(n.vessel_id||"?")+"</div></div></body></html>"),o.document.close(),setTimeout(function(){o.print()},250)}}var pn="@page{size:4in 6in;margin:0;}body{margin:0;font-family:Arial,Helvetica,sans-serif;}.label{width:4in;height:6in;padding:0.2in 0.25in;box-sizing:border-box;display:flex;flex-direction:column;overflow:hidden;}.top-row{display:flex;align-items:center;justify-content:space-between;padding-bottom:5px;border-bottom:1.5px solid #000;margin-bottom:6px;}.logo-stack{display:flex;align-items:center;gap:8px;}.logo-icon{height:48px;}.logo-wordmark{height:20px;}.qr-box{width:72px;height:72px;display:flex;align-items:center;justify-content:center;}.qr-box svg{width:72px;height:72px;}.qr-empty{width:72px;height:72px;border:1.5px solid #000;}.batch-id{font-size:15px;font-weight:bold;text-align:center;margin:2px 0 1px;letter-spacing:1px;}.product-name{font-size:11px;text-align:center;font-weight:600;margin-bottom:5px;}.info-grid{display:grid;grid-template-columns:auto 1fr;gap:1px 8px;font-size:9.5px;line-height:1.5;margin-bottom:4px;}.info-grid .lbl{font-weight:bold;text-align:right;white-space:nowrap;}.write-line{border-bottom:1px solid #000;min-width:100px;display:inline-block;height:12px;}.section-title{font-size:8.5px;font-weight:bold;text-transform:uppercase;letter-spacing:0.5px;margin:4px 0 2px;border-bottom:0.5px solid #ccc;padding-bottom:1px;}.schedule-wrap{min-height:108px;margin-bottom:4px;}.schedule-table{width:100%;border-collapse:collapse;font-size:8.5px;line-height:1.4;}.schedule-table td{padding:1px 4px 1px 0;vertical-align:top;}.schedule-table td:first-child{white-space:nowrap;font-weight:600;width:52px;}.schedule-table td:last-child{color:#555;font-size:8px;text-align:right;white-space:nowrap;}.notes-box{border:1px solid #999;border-radius:2px;flex:1;min-height:40px;margin:0 0 6px;position:relative;}.notes-box-label{position:absolute;top:-1px;left:4px;font-size:7px;font-weight:bold;color:#000;text-transform:uppercase;background:#fff;padding:0 2px;}.agreement{flex-shrink:0;border-top:1px solid #999;padding-top:3px;}.agreement-title{font-size:7px;font-weight:bold;text-align:center;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:2px;}.agreement-text{font-size:6.5px;line-height:1.35;text-align:justify;color:#333;margin-bottom:4px;}.sig-area{display:flex;gap:6px;align-items:flex-end;}.sig-block{flex:1;}.sig-block .sig-line{border-bottom:1px solid #000;height:14px;}.sig-block .sig-label{font-size:6px;text-align:center;margin-top:1px;color:#555;}.sig-block.sm{flex:0.4;}.email-row{margin-bottom:4px;}.email-row .sig-line{border-bottom:1px solid #000;height:12px;}.email-row .sig-label{font-size:6px;margin-top:1px;color:#555;}",fn="By signing, I request assistance and guidance, as required, in preparing my wine must for fermentation. I acknowledge that by default, Steins &amp; Vines will add a natural shell fish derivative, Chitosan, for the purpose of clearing. I consent to my name, telephone number, address and email (if supplied) being kept in a database with the understanding that this information will not be sold or exchanged. I acknowledge that the wine made for me by Steins &amp; Vines is for my personal use only. I acknowledge that Steins &amp; Vines has transferred ownership of my wine and all ingredients to me.";function hn(e){var t=e.batch||{},n=e.tasks||[],a=e.qrSvg||"",o=e.blank||!1,i=window.location.origin,r=i+"/images/label-icon.png",s=i+"/images/label-wordmark.png",d='<!DOCTYPE html><html><head><meta charset="UTF-8">';d+="<title>"+(o?"Blank Batch Form":"Batch "+vt(t.batch_id||""))+"</title>",d+="<style>"+pn+'</style></head><body><div class="label">',d+='<div class="top-row"><div class="logo-stack">',d+='<img class="logo-icon" src="'+r+'" alt="">',d+='<img class="logo-wordmark" src="'+s+'" alt="">',d+="</div>",a?d+='<div class="qr-box">'+a+"</div>":o||(d+='<div class="qr-empty"></div>'),d+="</div>",d+='<div class="batch-id">'+(o?'Batch ID: <span class="write-line" style="min-width:140px;"></span>':vt(t.batch_id||""))+"</div>",d+='<div class="product-name">'+(o?'Kit: <span class="write-line" style="min-width:180px;"></span>':vt(t.product_name||t.product_sku||""))+"</div>",d+='<div class="info-grid">',d+='<span class="lbl">Customer:</span><span class="val">'+(o?'<span class="write-line"></span>':vt(t.customer_name||""))+"</span>",d+='<span class="lbl">Email:</span><span class="val">'+(o?'<span class="write-line"></span>':vt(t.customer_email||""))+"</span>",d+='<span class="lbl">Phone:</span><span class="val">'+(o?'<span class="write-line"></span>':vt(t.customer_phone||""))+"</span>",d+='<span class="lbl">Start Date:</span><span class="val">'+(o?'<span class="write-line"></span>':vt(String(t.start_date||"").substring(0,10)))+"</span>";var c=o?'<span class="write-line"></span>':vt([t.shelf_id,t.bin_id,t.vessel_id].filter(Boolean).join(" - ")||"—");if(d+='<span class="lbl">Primary Location:</span><span class="val">'+c+"</span>",d+='<span class="lbl">Transfer 1:</span><span class="val"><span class="write-line"></span></span>',d+='<span class="lbl">Transfer 2:</span><span class="val"><span class="write-line"></span></span>',d+='<span class="lbl">Transfer 3:</span><span class="val"><span class="write-line"></span></span>',d+="</div>",d+='<div class="section-title">Schedule</div>',d+='<div class="schedule-wrap"><table class="schedule-table">',!o&&n.length>0){var l=t.start_date?new Date(String(t.start_date).substring(0,10)).getTime():0;n.forEach(function(e){var t="—",n="";if(e.due_date){var a=String(e.due_date).substring(0,10);if(n=a,l){var o=Math.round((new Date(a).getTime()-l)/864e5);t="Day "+(o<1?1:o)}}else t="TBD";1!==e.step_number&&"1"!==e.step_number||(t="Day 1"),d+="<tr><td>"+vt(t)+"</td>",d+="<td>"+vt(e.title||"Step "+e.step_number)+"</td>",d+="<td>"+vt(n)+"</td></tr>"})}else{d+='<tr><td style="font-weight:bold;font-size:7.5px;padding-bottom:2px;">Day</td>',d+='<td style="font-weight:bold;font-size:7.5px;padding-bottom:2px;">Step</td>',d+='<td style="font-weight:bold;font-size:7.5px;padding-bottom:2px;text-align:right;">Date</td></tr>';for(var u=0;u<8;u++)d+='<tr><td style="border-bottom:0.5px solid #ccc;">____</td>',d+='<td style="border-bottom:0.5px solid #ccc;">&nbsp;</td>',d+='<td style="border-bottom:0.5px solid #ccc;">&nbsp;</td></tr>'}return d+="</table></div>",d+='<div class="notes-box"><span class="notes-box-label">Notes</span></div>',d+='<div class="agreement">',d+='<div class="agreement-title">Customer Agreement</div>',d+='<div class="agreement-text">'+fn+"</div>",d+='<div class="sig-area">',d+='<div class="sig-block"><div class="sig-line"></div><div class="sig-label">Signature</div></div>',d+='<div class="sig-block sm"><div class="sig-line"></div><div class="sig-label">Date</div></div>',d+="</div></div>",d+="</div></body></html>"}function vn(){var e=document.getElementById("batch-pipeline-stages");if(e&&Lt){var t=Lt,n={primary:t.primaryCount||0,secondary:t.secondaryCount||0,complete:t.completeCount||0};if(0!==n.primary+n.secondary+n.complete){var a={primary:"Primary",secondary:"Secondary",complete:"Complete"},o="";["primary","secondary","complete"].forEach(function(e){n[e]>0&&(o+='<div class="pipeline-stage pipeline-stage--'+e+'" style="flex:'+n[e]+';" data-filter="'+e+'">',o+='<span class="pipeline-stage-count">'+n[e]+"</span>",o+='<span class="pipeline-stage-name">'+a[e]+"</span>",o+="</div>")}),e.innerHTML=o,e.querySelectorAll(".pipeline-stage").forEach(function(e){e.addEventListener("click",function(){document.querySelector('[data-tab="batches"]').click();var t=e.getAttribute("data-filter"),n=document.getElementById("batch-status-filter");n&&(n.value=t,Ot())})})}else e.innerHTML='<div class="pipeline-empty">No batches yet</div>'}else e&&(e.innerHTML='<div class="pipeline-empty">No batch data</div>')}function gn(e){if(e){var t=document.getElementById("attention-list");if(t){var n=[];e.tasksDueToday>0&&n.push({text:e.tasksDueToday+" batch task"+(1!==e.tasksDueToday?"s":"")+" due today",dot:"warning",tab:"batches"}),e.overdueTasks>0&&n.push({text:e.overdueTasks+" overdue batch task"+(1!==e.overdueTasks?"s":""),dot:"danger",tab:"batches"}),e.readyForPackaging>0&&n.push({text:e.readyForPackaging+" batch"+(1!==e.readyForPackaging?"es":"")+" ready for packaging",dot:"success",tab:"batches"}),0!==n.length&&n.forEach(function(e){var n=document.createElement("div");n.className="attention-item",n.setAttribute("data-tab",e.tab),n.innerHTML='<span class="attention-dot attention-dot--'+e.dot+'"></span>'+e.text,n.addEventListener("click",function(){document.querySelector('[data-tab="'+e.tab+'"]').click()}),t.appendChild(n)})}}}function bn(){var e;(e=document.querySelectorAll(".batch-sub-tab")).forEach(function(t){t.addEventListener("click",function(){e.forEach(function(e){e.classList.remove("active")}),t.classList.add("active"),document.querySelectorAll(".batch-view").forEach(function(e){e.classList.remove("active")});var n=document.getElementById("batch-view-"+t.getAttribute("data-batch-view"));n&&n.classList.add("active");var a=t.getAttribute("data-batch-view"),o=Date.now();"calendar"===a&&o-At>3e4&&cn(_t,St),"upcoming"===a&&o-Nt>3e4&&ln(),"schedules"===a&&Ht()})}),function(){var e=new Date;_t=e.getFullYear(),St=e.getMonth();var t=document.getElementById("cal-prev-month"),n=document.getElementById("cal-next-month");t&&t.addEventListener("click",function(){--St<0&&(St=11,_t--),cn(_t,St)}),n&&n.addEventListener("click",function(){++St>11&&(St=0,_t++),cn(_t,St)})}();var t=document.getElementById("create-batch-btn");t&&t.addEventListener("click",$t);var n=document.getElementById("print-blank-label-btn");n&&n.addEventListener("click",function(){!function(){var e=hn({blank:!0}),t=window.open("","_blank");t.document.write(e),t.document.close();var n=t.document.querySelectorAll("img"),a=0,o=n.length;function i(){++a>=o&&setTimeout(function(){t.print()},100)}0!==o?n.forEach(function(e){e.complete?i():(e.onload=i,e.onerror=i)}):setTimeout(function(){t.print()},250)}()});var a,o=document.getElementById("create-schedule-btn");o&&o.addEventListener("click",sn),(a=document.getElementById("batches-table"))&&a.querySelectorAll("th.sortable").forEach(function(e){e.addEventListener("click",function(){var t=e.getAttribute("data-sort-key");wt===t?xt="asc"===xt?"desc":"asc":(wt=t,xt="asc"),Mt()})});var i=document.getElementById("batch-status-filter");i&&i.addEventListener("change",function(){Ot()});var r,s=document.getElementById("batch-search");s&&s.addEventListener("input",function(){clearTimeout(r),r=setTimeout(Mt,300)});var d=document.getElementById("upcoming-refresh");d&&d.addEventListener("click",ln)}var yn=!1,En=!1,kn=W;function _n(){yn||En||(En=!0,yn=!0,P("get_batch_init",{status:document.getElementById("batch-status-filter")?document.getElementById("batch-status-filter").value:"active"}).then(function(e){var t=e.data||{},n=t.batches||{};It=n.batches||[],Mt(),Ct=t.schedules&&t.schedules.schedules||[],rn(),Lt=t.summary||null,vn(),gn(Lt)}).catch(function(e){S("Failed to load batch data: "+e.message,"error")}))}W=function(){kn(),SHEETS_CONFIG.ADMIN_API_URL&&Dt()};var Sn=J;J=function(){Sn(),document.querySelectorAll(".admin-tab-btn").forEach(function(e){"batches"===e.getAttribute("data-tab")&&(e.addEventListener("click",_n),e.addEventListener("mouseenter",_n))})},document.addEventListener("DOMContentLoaded",function(){bn()});var In=[],wn={},xn=!1,Cn=!1,Ln=null,Tn=!1,Bn=null;function An(){return"undefined"!=typeof SHEETS_CONFIG&&SHEETS_CONFIG.MIDDLEWARE_URL?SHEETS_CONFIG.MIDDLEWARE_URL:""}function Nn(e){return"$"+(parseFloat(e)||0).toFixed(2)}function On(){return 0===Object.keys(wn).length}function Hn(){var e=0,t=0;return Object.keys(wn).forEach(function(n){var a=wn[n],o=a.qty,i=parseFloat(a.item.rate)||0;e+=i*o,t+=function(e,t){var n=parseFloat(e.rate)||0,a=parseFloat(e.tax_percentage)||0;return parseFloat((n*t*a/100).toFixed(2))}(a.item,o)}),{subtotal:parseFloat(e.toFixed(2)),tax:parseFloat(t.toFixed(2)),total:parseFloat((e+t).toFixed(2))}}function Dn(e){["browse","customer","payment","receipt","error"].forEach(function(t){var n=document.getElementById("kiosk-view-"+t);n&&(n.style.display=t===e?"":"none")})}function Mn(e,t){Tn=e;var n=document.getElementById("kiosk-terminal-dot"),a=document.getElementById("kiosk-terminal-label");n&&a&&(n.className="kiosk-terminal-dot"+(e?" kiosk-terminal-dot--ready":-1!==t.indexOf("not configured")?" kiosk-terminal-dot--error":" kiosk-terminal-dot--warn"),a.textContent=t)}function qn(e){if(!Cn)if(!xn||e){var t,n=An();if(n)Cn=!0,(t=document.getElementById("kiosk-product-grid"))&&(t.innerHTML='<p class="kiosk-loading">Loading products...</p>'),fetch(n+"/api/kiosk/products").then(function(e){return e.json()}).then(function(e){In=e.items||[],xn=!0,Cn=!1,function(){var e=document.getElementById("kiosk-category-filter");if(!e)return;var t={};In.forEach(function(e){var n=e.category_name||"";n&&(t[n]=!0)});e.options.length;for(;e.options.length>1;)e.remove(1);Object.keys(t).sort().forEach(function(t){var n=document.createElement("option");n.value=t,n.textContent=t,e.appendChild(n)})}(),Fn()}).catch(function(e){Cn=!1;var t=document.getElementById("kiosk-product-grid");t&&(t.innerHTML='<p class="kiosk-loading">Failed to load products: '+e.message+"</p>")});else(t=document.getElementById("kiosk-product-grid"))&&(t.innerHTML='<p class="kiosk-loading">Middleware URL not configured.</p>')}else Fn()}function Fn(){var e=document.getElementById("kiosk-product-grid");if(e){var t=(document.getElementById("kiosk-search")||{}).value||"";t=t.toLowerCase().trim();var n=(document.getElementById("kiosk-category-filter")||{}).value||"",a=(An(),In.filter(function(e){if(n&&(e.category_name||"").toLowerCase()!==n.toLowerCase())return!1;if(t&&-1===((e.name||"")+" "+(e.sku||"")+" "+(e.category_name||"")).toLowerCase().indexOf(t))return!1;return!0}));if(0!==a.length){var o="";a.forEach(function(e){var t,n=wn[e.item_id],a=n?n.qty:0,i=parseFloat(e.stock_on_hand)||0,r=i<=0,s=!r&&i<=5,d="kiosk-product-card"+(r?" kiosk-product-card--out-of-stock":"");t=e.image_name&&e.sku?'<img class="kiosk-product-img" src="images/products/'+encodeURIComponent(e.sku)+'.png" alt="" onerror="this.style.display=\'none\';this.nextElementSibling.style.display=\'flex\';"><div class="kiosk-product-img-placeholder" style="display:none;">&#127817;</div>':'<div class="kiosk-product-img-placeholder">&#127817;</div>';var c=r?"Out of stock":s?"Low stock ("+Math.round(i)+")":"In stock",l=r?"kiosk-product-stock--out":s?"kiosk-product-stock--low":"";o+='<div class="'+d+'" data-item-id="'+e.item_id+'">',a>0&&(o+='<div class="kiosk-card-in-cart">'+a+"</div>"),o+=t,o+='<div class="kiosk-product-body">',o+='<div class="kiosk-product-name">'+(e.name||"")+"</div>",e.sku&&(o+='<div class="kiosk-product-sku">'+e.sku+"</div>"),o+='<div class="kiosk-product-price">'+Nn(e.rate)+"</div>",o+='<div class="kiosk-product-stock '+l+'">'+c+"</div>",o+="</div>",o+="</div>"}),e.innerHTML=o,e.querySelectorAll(".kiosk-product-card:not(.kiosk-product-card--out-of-stock)").forEach(function(e){e.addEventListener("click",function(){var t=e.getAttribute("data-item-id"),n=In.filter(function(e){return e.item_id===t})[0];n&&function(e){var t=e.item_id;wn[t]?wn[t].qty+=1:wn[t]={item:e,qty:1};Rn(),Fn()}(n)})})}else e.innerHTML='<p class="kiosk-loading">No products match your search.</p>'}}function Pn(){wn={},Rn(),Fn()}function Rn(){var e=document.getElementById("kiosk-cart-items"),t=document.getElementById("kiosk-cart-totals"),n=document.getElementById("kiosk-checkout-btn"),a=document.getElementById("kiosk-checkout-total");if(e){var o=Object.keys(wn);if(0===o.length)return e.innerHTML='<p class="kiosk-cart-empty">No items in cart</p>',t&&(t.style.display="none"),n&&(n.disabled=!0),void(a&&(a.textContent="$0.00"));var i="";o.forEach(function(e){var t=wn[e],n=t.item,a=t.qty,o=(parseFloat(n.rate)||0)*a;i+='<div class="kiosk-cart-line">',i+='<div class="kiosk-cart-line-name" title="'+(n.name||"")+'">'+(n.name||"")+"</div>",i+='<div class="kiosk-cart-qty">',i+='<button class="kiosk-qty-btn" data-action="dec" data-id="'+e+'">-</button>',i+='<span class="kiosk-qty-val">'+a+"</span>",i+='<button class="kiosk-qty-btn" data-action="inc" data-id="'+e+'">+</button>',i+="</div>",i+='<div class="kiosk-cart-line-total">'+Nn(o)+"</div>",i+="</div>"}),e.innerHTML=i,e.querySelectorAll(".kiosk-qty-btn").forEach(function(e){e.addEventListener("click",function(){var t=e.getAttribute("data-id"),n=e.getAttribute("data-action");if(wn[t]){var a,o,i=wn[t].qty+("inc"===n?1:-1);a=t,(o=i)<=0?delete wn[a]:wn[a]&&(wn[a].qty=o),Rn(),Fn()}})});var r=Hn(),s=document.getElementById("kiosk-subtotal"),d=document.getElementById("kiosk-tax"),c=document.getElementById("kiosk-total");s&&(s.textContent=Nn(r.subtotal)),d&&(d.textContent=Nn(r.tax)),c&&(c.textContent=Nn(r.total)),t&&(t.style.display=""),n&&(n.disabled=!1),a&&(a.textContent=Nn(r.total))}}function Un(){On()||(Tn?(Bn=null,function(){Dn("customer");var e=Object.keys(wn).some(function(e){return"kit"===(wn[e].item.product_type||"").toLowerCase()}),t=document.getElementById("kiosk-customer-proceed"),n=document.getElementById("kiosk-customer-skip"),a=document.getElementById("kiosk-customer-back"),o=document.getElementById("kiosk-customer-search"),i=document.getElementById("kiosk-customer-results"),r=document.getElementById("kiosk-customer-selected"),s=document.getElementById("kiosk-new-customer-toggle"),d=document.getElementById("kiosk-new-customer-form"),c=document.getElementById("kiosk-new-customer-save");o&&(o.value="");i&&(i.innerHTML="");r&&(r.style.display="none",r.innerHTML="");d&&(d.style.display="none");t&&(t.disabled=!0);n&&(n.style.display=e?"none":"");function l(){t&&(t.disabled=!Bn)}function u(e){if(Bn=e,o&&(o.value=""),i&&(i.innerHTML=""),r){r.style.display="",r.innerHTML="<span>"+(e.name||"")+(e.email?" &mdash; "+e.email:"")+'</span><button type="button" style="background:none;border:none;cursor:pointer;font-size:1rem;padding:0 0.25rem;" id="kiosk-clear-customer">&times;</button>';var t=document.getElementById("kiosk-clear-customer");t&&(t.onclick=function(){Bn=null,r.style.display="none",r.innerHTML="",l()})}d&&(d.style.display="none"),l()}a&&(a.onclick=function(){Dn("browse")});n&&(n.onclick=function(){Gn()});t&&(t.onclick=function(){Bn&&Gn()});s&&(s.onclick=function(){d&&(d.style.display="none"===d.style.display?"":"none")});c&&(c.onclick=function(){var e=document.getElementById("kiosk-new-name"),t=document.getElementById("kiosk-new-email"),n=document.getElementById("kiosk-new-phone"),a=e?e.value.trim():"",o=t?t.value.trim():"",i=n?n.value.trim():"";if(a&&o){c.disabled=!0;var r=An();fetch(r+"/api/contacts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:a,email:o,phone:i})}).then(function(e){return e.json().then(function(t){return{status:e.status,data:t}})}).then(function(i){c.disabled=!1,i.data&&i.data.contact_id?(e&&(e.value=""),t&&(t.value=""),n&&(n.value=""),u({contact_id:i.data.contact_id,name:a,email:o})):S(i.data.error||"Could not create customer","error")}).catch(function(){c.disabled=!1,S("Could not create customer","error")})}else S("Name and email are required","error")});var m=null;o&&(o.addEventListener("input",function(){clearTimeout(m);var e=o.value.trim();e?m=setTimeout(function(){var t=An();fetch(t+"/api/contacts?search="+encodeURIComponent(e)).then(function(e){return e.json()}).then(function(e){if(i){var t=(e.contacts||[]).slice(0,8);if(t.length){var n="";t.forEach(function(e){n+='<div class="kiosk-customer-result-row" data-id="'+(e.contact_id||"")+'"><strong>'+(e.contact_name||e.name||"")+"</strong>"+(e.email?' <span style="color:#666;">'+e.email+"</span>":"")+"</div>"}),i.innerHTML=n,Array.prototype.forEach.call(i.querySelectorAll(".kiosk-customer-result-row"),function(e){e.onclick=function(){var n=Array.prototype.indexOf.call(i.querySelectorAll(".kiosk-customer-result-row"),e),a=t[n];u({contact_id:a.contact_id||"",name:a.contact_name||a.name||"",email:a.email||""})}})}else i.innerHTML='<div style="padding:0.4rem 0.6rem;color:#888;font-size:0.88rem;">No results</div>'}}).catch(function(){i&&(i.innerHTML='<div style="padding:0.4rem 0.6rem;color:#888;font-size:0.88rem;">Search failed</div>')})},300):i&&(i.innerHTML="")}),o.addEventListener("focus",function(){var e=o;setTimeout(function(){e.scrollIntoView&&e.scrollIntoView({behavior:"smooth",block:"nearest"})},350)}));["kiosk-new-name","kiosk-new-email","kiosk-new-phone"].forEach(function(e){var t=document.getElementById(e);t&&t.addEventListener("focus",function(){var e=t;setTimeout(function(){e.scrollIntoView&&e.scrollIntoView({behavior:"smooth",block:"nearest"})},350)})})}()):S("POS terminal is not ready. Check terminal status below.","error"))}function Gn(){var e=Hn(),t=An();if(t){var n=Object.keys(wn).map(function(e){var t=wn[e];return{item_id:t.item.item_id,name:t.item.name||"",quantity:t.qty,rate:parseFloat(t.item.rate)||0,product_type:t.item.product_type||""}});Dn("payment");var a=document.getElementById("kiosk-payment-amount"),o=document.getElementById("kiosk-terminal-msg"),i=document.getElementById("kiosk-spinner"),r=document.getElementById("kiosk-payment-items"),s=document.getElementById("kiosk-cancel-payment");if(a&&(a.textContent=Nn(e.total)),o&&(o.textContent="Tap, insert, or swipe card on terminal..."),i&&(i.style.display=""),r){var d="";n.forEach(function(e){d+='<div class="kiosk-payment-item-row">',d+="<span>"+(e.name||"")+" x"+(e.quantity||1)+"</span>",d+="<span>"+Nn((e.rate||0)*(e.quantity||1))+"</span>",d+="</div>"}),e.tax>0&&(d+='<div class="kiosk-payment-item-row"><span>Tax</span><span>'+Nn(e.tax)+"</span></div>"),r.innerHTML=d}var c=!1;s&&(s.disabled=!1,s.onclick=function(){c=!0,Dn("browse"),o&&(o.textContent="Cancelled.")});var l="KIOSK-"+Date.now();fetch(t+"/api/kiosk/sale",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({items:n,tax_total:e.tax,reference_number:l,contact_id:Bn?Bn.contact_id:""})}).then(function(e){return e.json().then(function(t){return{status:e.status,data:t}})}).then(function(t){if(!c)if(i&&(i.style.display="none"),201===t.status&&t.data.ok){t.data;var a=(new Date).toISOString().slice(0,10),o=n.filter(function(e){return"kit"===(e.product_type||"").toLowerCase()}),r=[];if(o.forEach(function(e){for(var t=0;t<(e.quantity||1);t++)r.push(R("create_batch",{product_name:e.name,product_sku:e.item_id||"",customer_name:Bn?Bn.name:"Walk-In",customer_email:Bn&&Bn.email||"",start_date:a,vessel_id:"",schedule_id:""}))}),0===r.length)return jn(t.data,e,n,[]),void Pn();Promise.all(r.map(function(e){return e.catch(function(e){return console.error("[kiosk] batch creation failed:",e),null})})).then(function(a){var o=a.filter(function(e){return e&&e.batch_id});o.length<r.length&&S("Some batch records could not be created","warn"),jn(t.data,e,n,o),Pn()})}else 402===t.status?zn("Payment Declined",t.data.error||"Card was declined. Please try a different payment method.",!0):t.data&&t.data.payment_voided?zn("Sale Could Not Complete",t.data.error||"Payment was taken but could not be recorded. Payment has been voided.",!1):zn("Sale Error",t.data.error||"An error occurred. Please try again.",!0)}).catch(function(){c||(i&&(i.style.display="none"),zn("Connection Error","Could not reach the payment server. Please try again.",!0))})}else S("Middleware URL not configured","error")}function jn(e,t,n,a){Dn("receipt"),a=a||[];var o=document.getElementById("kiosk-receipt-body");if(o){var i="";n.forEach(function(e){i+='<div class="kiosk-receipt-row">',i+="<span>"+(e.name||"")+" x"+(e.quantity||1)+"</span>",i+="<span>"+Nn((e.rate||0)*(e.quantity||1))+"</span>",i+="</div>"}),t.tax>0&&(i+='<div class="kiosk-receipt-row"><span>Tax</span><span>'+Nn(t.tax)+"</span></div>"),i+='<div class="kiosk-receipt-row" style="font-weight:700;font-size:1.05rem;">',i+="<strong>Total</strong><strong>"+Nn(e.total||t.total)+"</strong>",i+="</div>",e.invoice_number&&(i+='<div class="kiosk-receipt-row"><span>Invoice</span><span>'+e.invoice_number+"</span></div>"),e.transaction_id&&(i+='<div class="kiosk-receipt-row"><span>Transaction</span><span style="font-size:0.8rem;font-family:monospace;">'+e.transaction_id+"</span></div>"),e.auth_code&&(i+='<div class="kiosk-receipt-row"><span>Auth Code</span><span>'+e.auth_code+"</span></div>"),e.date&&(i+='<div class="kiosk-receipt-row"><span>Date</span><span>'+e.date+"</span></div>"),a.length>0&&(i+='<div class="kiosk-receipt-batches">',i+='<div class="kiosk-receipt-section-title">Batches Created</div>',a.forEach(function(e,t){i+='<div class="kiosk-receipt-batch-row">',i+="<span>"+(e.batch_id||"")+"</span>",i+='<button type="button" class="btn admin-btn-sm kiosk-save-label-btn" data-batch-idx="'+t+'">Save Label</button>',i+="</div>"}),i+="</div>"),o.innerHTML=i,a.length>0&&Array.prototype.forEach.call(o.querySelectorAll(".kiosk-save-label-btn"),function(e){e.onclick=function(){var t=parseInt(e.getAttribute("data-batch-idx"),10),n=a[t];if(n){var o=(new Date).toISOString().slice(0,10),i=un(n.batch_id,n.access_token),r=hn({batch:{batch_id:n.batch_id,customer_name:Bn?Bn.name:"Walk-In",customer_email:Bn&&Bn.email||"",start_date:n.start_date||o},tasks:[],qrSvg:i}),s=window.open("","_blank");s&&(s.document.write(r),s.document.close(),setTimeout(function(){s.print()},250))}}});var r=document.getElementById("kiosk-new-sale-btn");r&&(r.onclick=function(){Bn=null,Dn("browse")})}}function zn(e,t,n){Dn("error");var a=document.getElementById("kiosk-error-title"),o=document.getElementById("kiosk-error-msg"),i=document.getElementById("kiosk-retry-btn"),r=document.getElementById("kiosk-back-btn");a&&(a.textContent=e),o&&(o.textContent=t),i&&(i.style.display=n?"":"none",i.onclick=function(){Dn("browse"),Un()}),r&&(r.onclick=function(){Dn("browse")})}var Vn=J;J=function(){Vn(),document.querySelectorAll(".admin-tab-btn").forEach(function(e){e.addEventListener("click",function(){var t="kiosk"===e.getAttribute("data-tab");0;var n,a=document.getElementById("kiosk-terminal-bar");a&&(t?a.classList.add("visible"):a.classList.remove("visible")),!t||xn||Cn||(qn(),(n=An())?fetch(n+"/api/pos/status").then(function(e){return e.json()}).then(function(e){e.enabled?Mn(!0,"Terminal ready ("+(e.terminal_type||"UPA")+")"):Mn(!1,"Terminal not enabled — check GP_TERMINAL_ENABLED env var")}).catch(function(){Mn(!1,"Terminal: middleware unreachable")}):Mn(!1,"Terminal: middleware not configured"))})})},document.addEventListener("DOMContentLoaded",function(){!function(){var e=document.getElementById("kiosk-search");e&&e.addEventListener("input",function(){clearTimeout(Ln),Ln=setTimeout(Fn,200)});var t=document.getElementById("kiosk-category-filter");t&&t.addEventListener("change",Fn);var n=document.getElementById("kiosk-products-refresh");n&&n.addEventListener("click",function(){xn=!1,qn(!0)});var a=document.getElementById("kiosk-cart-clear");a&&a.addEventListener("click",function(){On()||Pn()});var o=document.getElementById("kiosk-checkout-btn");o&&o.addEventListener("click",Un)}()})}();