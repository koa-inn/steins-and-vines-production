function loadProducts() {
  var allProducts = [];
  var userHasSorted = false;
  var activeFilters = { type: [], brand: [], subcategory: [], time: [], body: [], oak: [], sweetness: [] };
  var saleFilterActive = false;

  var middlewareUrl = (typeof SHEETS_CONFIG !== 'undefined' && SHEETS_CONFIG.MIDDLEWARE_URL)
    ? SHEETS_CONFIG.MIDDLEWARE_URL : '';

  function loadFromCSV() {
    var csvUrl = (typeof SHEETS_CONFIG !== 'undefined' && SHEETS_CONFIG.PUBLISHED_CSV_URL)
      ? SHEETS_CONFIG.PUBLISHED_CSV_URL : null;

    var CSV_CACHE_KEY = 'sv-products-csv';
    var CSV_CACHE_TS_KEY = 'sv-products-csv-ts';
    var CSV_CACHE_TTL = 60 * 60 * 1000;

    function getCachedCSV() {
      try {
        var csv = localStorage.getItem(CSV_CACHE_KEY);
        var ts = parseInt(localStorage.getItem(CSV_CACHE_TS_KEY), 10) || 0;
        if (csv) return { csv: csv, fresh: (Date.now() - ts) < CSV_CACHE_TTL };
      } catch (e) {}
      return null;
    }

    function setCachedCSV(csv) {
      try {
        localStorage.setItem(CSV_CACHE_KEY, csv);
        localStorage.setItem(CSV_CACHE_TS_KEY, String(Date.now()));
      } catch (e) {}
    }

    var cached = getCachedCSV();
    var csvPromise;

    if (cached) {
      csvPromise = Promise.resolve(cached.csv);
      if (!cached.fresh) {
        var refreshUrl = csvUrl || 'content/products.csv';
        fetchCSV(refreshUrl).then(setCachedCSV).catch(function () {});
      }
    } else {
      csvPromise = csvUrl
        ? fetchCSV(csvUrl).catch(function () { return fetchCSV('content/products.csv'); })
        : fetchCSV('content/products.csv');
      csvPromise.then(setCachedCSV);
    }

    return csvPromise.then(function (csv) {
      var lines = csv.trim().split('\n');
      var headers = lines[0].split(',');
      var items = [];

      for (var i = 1; i < lines.length; i++) {
        var values = parseCSVLine(lines[i]);
        if (values.length < headers.length) continue;
        var obj = {};
        for (var j = 0; j < headers.length; j++) {
          obj[headers[j].trim()] = values[j].trim();
        }
        if (!obj.name && !obj.sku) continue;
        if (obj.hide && obj.hide.toLowerCase() === 'true') continue;
        items.push(obj);
      }
      return items;
    });
  }

  var MW_CACHE_KEY = 'sv-products-mw';
  var MW_CACHE_TS_KEY = 'sv-products-mw-ts';
  var MW_CACHE_TTL = 10 * 60 * 1000;

  function getCachedMW() {
    try {
      var data = localStorage.getItem(MW_CACHE_KEY);
      var ts = parseInt(localStorage.getItem(MW_CACHE_TS_KEY), 10) || 0;
      if (data) return { data: JSON.parse(data), fresh: (Date.now() - ts) < MW_CACHE_TTL };
    } catch (e) {}
    return null;
  }

  function setCachedMW(items) {
    try {
      localStorage.setItem(MW_CACHE_KEY, JSON.stringify(items));
      localStorage.setItem(MW_CACHE_TS_KEY, String(Date.now()));
    } catch (e) {}
  }

  var KIT_CATEGORIES = ['wine', 'beer', 'cider', 'seltzer'];

  function fetchFromMiddleware() {
    return fetch(middlewareUrl + '/api/products')
      .then(function (r) {
        if (!r.ok) throw new Error('Middleware returned ' + r.status);
        return r.json();
      })
      .then(function (data) {
        var items = data.items || [];
        return items.map(function (z) {
          // Start with standard Zoho fields
          var obj = {
            name: z.name || '',
            sku: z.sku || '',
            brand: z.brand || '',
            stock: z.stock_on_hand != null ? String(z.stock_on_hand) : '0',
            description: z.description || '',
            discount: z.discount != null ? String(z.discount) : '0',
            _zoho_category: z.category_name || ''
          };
          // Flatten custom fields (label → snake_case key)
          if (z.custom_fields && z.custom_fields.length) {
            z.custom_fields.forEach(function (cf) {
              var key = (cf.label || '').toLowerCase().replace(/\s+/g, '_');
              if (key && cf.value !== undefined && cf.value !== null) {
                obj[key] = String(cf.value);
              }
            });
          }
          // Derive kit-only and ferment-in-store prices from rate
          if (z.rate != null) {
            var rateNum = parseFloat(z.rate);
            if (!obj.retail_kit) {
              obj.retail_kit = '$' + rateNum.toFixed(2);
            }
            if (!obj.retail_instore) {
              obj.retail_instore = '$' + (rateNum + 50).toFixed(2);
            }
          }
          return obj;
        }).filter(function (obj) {
          // Exclude items with Type = Ingredient or Service
          var t = (obj.type || '').toLowerCase();
          if (t === 'ingredient' || t === 'service') return false;
          // Only keep kit categories (wine, beer, cider, seltzer)
          // Fall back to obj.type when category_name is absent from Zoho
          var cat = (obj.category || obj._zoho_category || obj.type || '').toLowerCase();
          if (!cat) return false;
          return KIT_CATEGORIES.some(function (kc) { return cat.indexOf(kc) !== -1; });
        });
      });
  }

  function loadFromMiddleware() {
    var cached = getCachedMW();

    if (cached) {
      var promise = Promise.resolve(cached.data);
      if (!cached.fresh) {
        fetchFromMiddleware().then(setCachedMW).catch(function () {});
      }
      return promise;
    }

    return fetchFromMiddleware().then(function (items) {
      setCachedMW(items);
      return items;
    });
  }

  // Show skeleton loading on first load
  var catalog = document.getElementById('product-catalog');
  if (catalog) {
    showCatalogSkeletons(catalog, 6);
  }

  var dataPromise = middlewareUrl
    ? loadFromMiddleware().catch(function () { return loadFromCSV(); })
    : loadFromCSV();

  dataPromise
    .then(function (items) {
      // Filter out non-kit items that may have leaked from middleware
      items = items.filter(function (obj) {
        var t = (obj.type || '').toLowerCase();
        if (t === 'ingredient' || t === 'service') return false;
        // Fall back to obj.type when category_name is absent from Zoho
        var cat = (obj.category || obj._zoho_category || obj.type || '').toLowerCase();
        if (!cat) return false;
        return KIT_CATEGORIES.some(function (kc) { return cat.indexOf(kc) !== -1; });
      });
      items.forEach(function (obj) {
        obj._item_type = 'kit';
        if ((obj.favorite || '').toLowerCase() === 'true') {
          obj._favRand = Math.random();
        }
        allProducts.push(obj);
      });

      buildFilterRow('filter-type', 'type', 'Type:');
      buildFilterRow('filter-brand', 'brand', 'Brand:');
      buildFilterRow('filter-subcategory', 'subcategory', 'Style:');
      buildFilterRow('filter-time', 'time', 'Production Time:');
      buildFilterRow('filter-body', 'body', 'Body:');
      buildFilterRow('filter-oak', 'oak', 'Oak:');
      buildFilterRow('filter-sweetness', 'sweetness', 'Sweetness:');
      buildSaleFilter();
      applyFilters();

      // Refresh button — clears middleware cache and reloads products (only once)
      if (!document.querySelector('#catalog-controls-kits .catalog-refresh-btn')) {
        var refreshBtn = document.createElement('button');
        refreshBtn.className = 'catalog-refresh-btn';
        refreshBtn.type = 'button';
        refreshBtn.title = 'Refresh products';
        refreshBtn.setAttribute('aria-label', 'Refresh products');
        refreshBtn.innerHTML = '&#8635;';
        refreshBtn.addEventListener('click', function () {
          try {
            localStorage.removeItem(MW_CACHE_KEY);
            localStorage.removeItem(MW_CACHE_TS_KEY);
          } catch(e) {}
          loadProducts();
        });
        var kitsViewToggle = document.querySelector('#catalog-controls-kits .catalog-view-toggle');
        if (kitsViewToggle) { kitsViewToggle.parentNode.insertBefore(refreshBtn, kitsViewToggle.nextSibling); }
      }

      // Check for SKU parameter and scroll to product (from homepage featured)
      var urlParams = new URLSearchParams(window.location.search);
      var targetSku = urlParams.get('sku');
      if (targetSku) {
        var scrollAttempts = 0;
        function tryScrollToProduct() {
          var targetCard = document.querySelector('[data-sku="' + targetSku + '"]');
          if (targetCard) {
            targetCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            targetCard.classList.add('highlight');
            setTimeout(function () { targetCard.classList.remove('highlight'); }, 2000);
          } else if (scrollAttempts < 10) {
            scrollAttempts++;
            setTimeout(tryScrollToProduct, 100);
          }
        }
        setTimeout(tryScrollToProduct, 50);
      }

      // Expose so tab switcher can re-trigger kits rendering
      applyKitsFilters = applyFilters;

      var searchInput = document.getElementById('catalog-search');
      if (searchInput) {
        var searchTimer;
        searchInput.addEventListener('input', function () {
          clearTimeout(searchTimer);
          searchTimer = setTimeout(applyFilters, 180);
        });
      }

      var sortSelect = document.getElementById('catalog-sort');
      if (sortSelect) {
        sortSelect.addEventListener('change', function () {
          userHasSorted = true;
          applyFilters();
        });
      }

      var toggleBtn = document.getElementById('catalog-toggle');
      var collapsible = document.getElementById('catalog-collapsible');
      if (toggleBtn && collapsible) {
        toggleBtn.addEventListener('click', function () {
          var expanded = toggleBtn.getAttribute('aria-expanded') === 'true';
          toggleBtn.setAttribute('aria-expanded', String(!expanded));
          collapsible.classList.toggle('open');
        });
      }
    })
    .catch(function () {
      // Silently fail — noscript fallback is in the HTML
    });

  function buildFilterRow(containerId, field, label) {
    var container = document.getElementById(containerId);
    if (!container) return;

    var labelSpan = document.createElement('span');
    labelSpan.className = 'catalog-filter-label';
    labelSpan.textContent = label;
    container.appendChild(labelSpan);

    var uniqueValues = [];
    allProducts.forEach(function (r) {
      var val = r[field] || '';
      if (val && uniqueValues.indexOf(val) === -1) {
        uniqueValues.push(val);
      }
    });

    if (field === 'time') {
      uniqueValues.sort(function (a, b) {
        var numA = parseFloat(a) || 0;
        var numB = parseFloat(b) || 0;
        return numA - numB;
      });
    } else if (field === 'subcategory') {
      var styleOrder = ['red', 'white', 'rosé', 'rose', 'fruit', 'specialty'];
      uniqueValues.sort(function (a, b) {
        var aIdx = styleOrder.indexOf(a.toLowerCase());
        var bIdx = styleOrder.indexOf(b.toLowerCase());
        if (aIdx === -1) aIdx = styleOrder.length;
        if (bIdx === -1) bIdx = styleOrder.length;
        return aIdx - bIdx;
      });
    } else if (field === 'body') {
      var bodyOrder = ['light', 'light-medium', 'medium', 'medium-full', 'full'];
      uniqueValues.sort(function (a, b) {
        var aIdx = bodyOrder.indexOf(a.toLowerCase());
        var bIdx = bodyOrder.indexOf(b.toLowerCase());
        if (aIdx === -1) aIdx = bodyOrder.length;
        if (bIdx === -1) bIdx = bodyOrder.length;
        return aIdx - bIdx;
      });
    } else if (field === 'sweetness') {
      var sweetOrder = ['dry', 'off-dry', 'semi-sweet', 'sweet'];
      uniqueValues.sort(function (a, b) {
        var aIdx = sweetOrder.indexOf(a.toLowerCase());
        var bIdx = sweetOrder.indexOf(b.toLowerCase());
        if (aIdx === -1) aIdx = sweetOrder.length;
        if (bIdx === -1) bIdx = sweetOrder.length;
        return aIdx - bIdx;
      });
    } else {
      uniqueValues.sort();
    }

    if (uniqueValues.length === 0) {
      container.classList.add('hidden');
      return;
    }

    var allBtn = createFilterButton('All', containerId, field);
    allBtn.classList.add('active');
    container.appendChild(allBtn);

    uniqueValues.forEach(function (val) {
      var count = allProducts.filter(function (p) { return p[field] === val; }).length;
      container.appendChild(createFilterButton(val, containerId, field, count));
    });
  }

  function buildSaleFilter() {
    var hasSaleProducts = allProducts.some(function (p) {
      return parseFloat(p.discount) > 0;
    });
    var container = document.getElementById('filter-sale');
    if (!container || !hasSaleProducts) {
      if (container) container.classList.add('hidden');
      return;
    }
    var labelSpan = document.createElement('span');
    labelSpan.className = 'catalog-filter-label';
    labelSpan.textContent = 'Sale:';
    container.appendChild(labelSpan);

    var btn = document.createElement('button');
    btn.className = 'catalog-filter-btn';
    btn.type = 'button';
    btn.textContent = 'On Sale';
    btn.addEventListener('click', function () {
      saleFilterActive = !saleFilterActive;
      btn.classList.toggle('active', saleFilterActive);
      applyFilters();
    });
    container.appendChild(btn);
  }

  function createFilterButton(label, containerId, field, count) {
    var btn = document.createElement('button');
    btn.className = 'catalog-filter-btn';
    btn.type = 'button';
    btn.setAttribute('data-field', field);
    btn.setAttribute('data-value', label);
    var labelNode = document.createTextNode(label);
    btn.appendChild(labelNode);
    if (count !== undefined && label !== 'All') {
      var countBadge = document.createElement('span');
      countBadge.className = 'filter-btn-count';
      countBadge.textContent = String(count);
      btn.appendChild(countBadge);
    }
    btn.addEventListener('click', function () {
      if (label === 'All') {
        activeFilters[field] = [];
      } else {
        var idx = activeFilters[field].indexOf(label);
        if (idx !== -1) {
          activeFilters[field].splice(idx, 1);
        } else {
          activeFilters[field].push(label);
        }
      }
      var container = document.getElementById(containerId);
      var buttons = container.querySelectorAll('.catalog-filter-btn');
      buttons.forEach(function (b) { b.classList.remove('active'); });
      if (activeFilters[field].length === 0) {
        container.querySelector('[data-value="All"]').classList.add('active');
      } else {
        buttons.forEach(function (b) {
          if (activeFilters[field].indexOf(b.getAttribute('data-value')) !== -1) {
            b.classList.add('active');
          }
        });
      }
      applyFilters();
      updateFilterAvailability();
    });
    return btn;
  }

  function matchesFilters(product, excludeField) {
    var fields = ['type', 'brand', 'subcategory', 'time', 'body', 'oak', 'sweetness'];
    for (var i = 0; i < fields.length; i++) {
      var f = fields[i];
      if (f === excludeField) continue;
      if (activeFilters[f].length > 0 && activeFilters[f].indexOf(product[f]) === -1) return false;
    }
    return true;
  }

  function updateFilterAvailability() {
    var fields = ['type', 'brand', 'subcategory', 'time', 'body', 'oak', 'sweetness'];
    fields.forEach(function (field) {
      var containerId = 'filter-' + (field === 'subcategory' ? 'subcategory' : field);
      var container = document.getElementById(containerId);
      if (!container) return;
      var buttons = container.querySelectorAll('.catalog-filter-btn');
      buttons.forEach(function (btn) {
        var val = btn.getAttribute('data-value');
        if (val === 'All') return;
        var hasResults = allProducts.some(function (p) {
          return p[field] === val && matchesFilters(p, field);
        });
        if (hasResults) {
          btn.classList.remove('disabled');
          btn.disabled = false;
        } else {
          btn.classList.add('disabled');
          btn.disabled = true;
          btn.classList.remove('active');
          var idx = activeFilters[field].indexOf(val);
          if (idx !== -1) activeFilters[field].splice(idx, 1);
        }
      });
    });
  }

  function parsePrice(product) {
    var val = product.retail_instore || product.retail_kit || '0';
    return parseFloat(val.replace('$', '')) || 0;
  }

  function parseTimeValue(str) {
    var match = (str || '').match(/(\d+)/);
    return match ? parseInt(match[1], 10) : 0;
  }

  function applyFilters() {
    var searchInput = document.getElementById('catalog-search');
    var query = searchInput ? searchInput.value.toLowerCase() : '';

    var filtered = allProducts.filter(function (r) {
      if (activeFilters.type.length > 0 && activeFilters.type.indexOf(r.type) === -1) return false;
      if (activeFilters.brand.length > 0 && activeFilters.brand.indexOf(r.brand) === -1) return false;
      if (activeFilters.subcategory.length > 0 && activeFilters.subcategory.indexOf(r.subcategory) === -1) return false;
      if (activeFilters.time.length > 0 && activeFilters.time.indexOf(r.time) === -1) return false;
      if (activeFilters.body.length > 0 && activeFilters.body.indexOf(r.body) === -1) return false;
      if (activeFilters.oak.length > 0 && activeFilters.oak.indexOf(r.oak) === -1) return false;
      if (activeFilters.sweetness.length > 0 && activeFilters.sweetness.indexOf(r.sweetness) === -1) return false;
      if (saleFilterActive && !(parseFloat(r.discount) > 0)) return false;
      if (!query) return true;
      var name = (r.name || '').toLowerCase();
      var sub = (r.subcategory || '').toLowerCase();
      var notes = (r.tasting_notes || '').toLowerCase();
      var brand = (r.brand || '').toLowerCase();
      return name.indexOf(query) !== -1 || sub.indexOf(query) !== -1 || notes.indexOf(query) !== -1 || brand.indexOf(query) !== -1;
    });

    var sortSelect = document.getElementById('catalog-sort');
    var sortVal = sortSelect ? sortSelect.value : 'name-asc';

    filtered.sort(function (a, b) {
      if (!userHasSorted) {
        var favA = (a.favorite || '').toLowerCase() === 'true' ? 0 : 1;
        var favB = (b.favorite || '').toLowerCase() === 'true' ? 0 : 1;
        if (favA !== favB) return favA - favB;
        if (favA === 0 && favB === 0) return (a._favRand || 0) - (b._favRand || 0);
      }

      switch (sortVal) {
        case 'name-asc':
          return (a.name || '').localeCompare(b.name || '');
        case 'name-desc':
          return (b.name || '').localeCompare(a.name || '');
        case 'brand-asc':
          return (a.brand || '').localeCompare(b.brand || '');
        case 'brand-desc':
          return (b.brand || '').localeCompare(a.brand || '');
        case 'style-asc':
          return (a.subcategory || '').localeCompare(b.subcategory || '');
        case 'style-desc':
          return (b.subcategory || '').localeCompare(a.subcategory || '');
        case 'price-asc':
          return parsePrice(a) - parsePrice(b);
        case 'price-desc':
          return parsePrice(b) - parsePrice(a);
        case 'time-asc':
          return parseTimeValue(a.time) - parseTimeValue(b.time);
        case 'time-desc':
          return parseTimeValue(b.time) - parseTimeValue(a.time);
        case 'reserved-desc':
          return getReservedQty(b.name + '|' + b.brand) - getReservedQty(a.name + '|' + a.brand);
        case 'reserved-asc':
          return getReservedQty(a.name + '|' + a.brand) - getReservedQty(b.name + '|' + b.brand);
        default:
          return 0;
      }
    });

    renderCatalog(filtered);
    updateFilterSummary();
    var statusEl = document.getElementById('filter-status');
    if (statusEl) statusEl.textContent = 'Showing ' + filtered.length + ' result' + (filtered.length !== 1 ? 's' : '');
  }

  var filterLabels = { type: 'Type', brand: 'Brand', subcategory: 'Style', time: 'Time', body: 'Body', oak: 'Oak', sweetness: 'Sweetness' };

  function updateFilterSummary() {
    var summary = document.getElementById('filter-summary');
    if (!summary) return;
    summary.innerHTML = '';
    var hasAny = false;
    var fields = Object.keys(activeFilters);
    fields.forEach(function (field) {
      activeFilters[field].forEach(function (val) {
        hasAny = true;
        var chip = document.createElement('button');
        chip.className = 'filter-chip';
        chip.type = 'button';
        var chipLabel = document.createTextNode((filterLabels[field] || field) + ': ' + val + ' ');
        var chipX = document.createElement('span');
        chipX.className = 'chip-x';
        chipX.textContent = '\u00d7';
        chip.appendChild(chipLabel);
        chip.appendChild(chipX);
        chip.addEventListener('click', function () {
          var idx = activeFilters[field].indexOf(val);
          if (idx !== -1) activeFilters[field].splice(idx, 1);
          // Sync the filter button UI
          var containerId = 'filter-' + field;
          var container = document.getElementById(containerId);
          if (container) {
            var buttons = container.querySelectorAll('.catalog-filter-btn');
            buttons.forEach(function (b) {
              if (b.getAttribute('data-value') === val) b.classList.remove('active');
              if (b.getAttribute('data-value') === 'All' && activeFilters[field].length === 0) b.classList.add('active');
            });
          }
          applyFilters();
          updateFilterAvailability();
        });
        summary.appendChild(chip);
      });
    });
    if (saleFilterActive) {
      hasAny = true;
      var saleChip = document.createElement('button');
      saleChip.className = 'filter-chip';
      saleChip.type = 'button';
      saleChip.innerHTML = 'On Sale <span class="chip-x">&times;</span>';
      saleChip.addEventListener('click', function () {
        saleFilterActive = false;
        var saleBtn = document.querySelector('#filter-sale .catalog-filter-btn');
        if (saleBtn) saleBtn.classList.remove('active');
        applyFilters();
      });
      summary.appendChild(saleChip);
    }
    if (hasAny) {
      var clearBtn = document.createElement('button');
      clearBtn.className = 'filter-chip filter-chip--clear';
      clearBtn.type = 'button';
      clearBtn.textContent = 'Clear all';
      clearBtn.addEventListener('click', function () {
        Object.keys(activeFilters).forEach(function (f) { activeFilters[f] = []; });
        saleFilterActive = false;
        // Reset all filter button UIs
        document.querySelectorAll('.catalog-filter-btn').forEach(function (b) {
          if (b.getAttribute('data-value') === 'All') {
            b.classList.add('active');
          } else {
            b.classList.remove('active');
          }
        });
        var saleBtn = document.querySelector('#filter-sale .catalog-filter-btn');
        if (saleBtn) saleBtn.classList.remove('active');
        applyFilters();
        updateFilterAvailability();
      });
      summary.appendChild(clearBtn);
    }
    summary.classList.toggle('hidden', !hasAny);
  }

  function renderCatalog(rows) {
    var catalog = document.getElementById('product-catalog');
    if (!catalog) return;

    // Remove existing sections, dividers, skeletons, and no-results message
    var sections = catalog.querySelectorAll('.catalog-section, .catalog-no-results, .catalog-divider, .catalog-skeleton-grid');
    sections.forEach(function (el) { el.parentNode.removeChild(el); });

    if (rows.length === 0) {
      var msg = document.createElement('p');
      msg.className = 'catalog-no-results';
      msg.textContent = 'No products found.';
      catalog.appendChild(msg);
      return;
    }

    function getAvailable(r) {
      if (r.available !== undefined && r.available !== '') return parseInt(r.available, 10) || 0;
      return parseInt(r.stock, 10) || 0;
    }
    var inStock = rows.filter(function (r) { return getAvailable(r) > 0; });
    var orderIn = rows.filter(function (r) { return getAvailable(r) <= 0; });

    renderSection(catalog, 'Currently available', inStock);

    if (inStock.length > 0 && orderIn.length > 0) {
      var divider = document.createElement('div');
      divider.className = 'section-icon catalog-divider';
      var icon = document.createElement('img');
      icon.src = 'images/Icon_green.svg';
      icon.alt = '';
      icon.setAttribute('aria-hidden', 'true');
      divider.appendChild(icon);
      catalog.appendChild(divider);
    }

    renderSection(catalog, 'Available to order', orderIn, 'catalog-section--order');
    equalizeCardHeights();
  }

  function buildWineCard(product) {
    var tint = getTintClass(product);
    var card = document.createElement('div');
    card.className = 'label-wine' + (tint ? ' ' + tint : '');
    if (product.sku) card.setAttribute('data-sku', product.sku);

    var discount = parseFloat(product.discount) || 0;
    if (discount > 0) {
      var badge = document.createElement('span');
      badge.className = 'discount-badge';
      badge.textContent = Math.round(discount) + '% OFF';
      card.appendChild(badge);
    }

    var body = document.createElement('div');
    body.className = 'label-body';

    var brand = document.createElement('div');
    brand.className = 'brand';
    brand.textContent = product.brand || '';
    body.appendChild(brand);

    var ornament = document.createElement('div');
    ornament.className = 'ornament';
    body.appendChild(ornament);

    var wineName = document.createElement('div');
    wineName.className = 'wine-name';
    wineName.textContent = product.name || '';
    body.appendChild(wineName);

    if (product.subcategory) {
      var sub = document.createElement('div');
      sub.className = 'subcategory';
      sub.textContent = product.subcategory;
      body.appendChild(sub);
    }

    var wBatchSize = (product['batch_size_(l)'] || product.batch_size_liters || '').trim();
    if (product.time || wBatchSize) {
      var timeRow = document.createElement('div');
      timeRow.className = 'time';
      var timeParts = [];
      if (product.time) timeParts.push(product.time);
      if (wBatchSize) timeParts.push(wBatchSize + 'L');
      timeRow.textContent = timeParts.join(' \u00b7 ');
      body.appendChild(timeRow);
    }

    if (product.abv) {
      var abv = document.createElement('div');
      abv.className = 'abv';
      abv.textContent = product.abv + (product.abv.toLowerCase().indexOf('abv') === -1 ? ' ABV' : '');
      body.appendChild(abv);
    }

    if (product.tasting_notes || product.sku || product.body || product.oak || product.sweetness) {
      body.appendChild(buildLabelNotesToggle(product));
    }

    var spacer = document.createElement('div');
    spacer.className = 'notes-spacer';
    body.appendChild(spacer);

    card.appendChild(body);

    var instore = (product.retail_instore || '').trim();
    var kit = (product.retail_kit || '').trim();
    if (instore || kit) {
      card.appendChild(buildLabelPriceFooter(product));
    }

    var reserveWrap = document.createElement('div');
    reserveWrap.className = 'reserve-link';
    var productKey = product.name + '|' + product.brand;
    renderReserveControl(reserveWrap, product, productKey);
    card.appendChild(reserveWrap);

    return card;
  }

  function buildBeerCard(product) {
    var tint = getTintClass(product);
    var card = document.createElement('div');
    card.className = 'label-beer' + (tint ? ' ' + tint : '');
    if (product.sku) card.setAttribute('data-sku', product.sku);

    var discount = parseFloat(product.discount) || 0;
    if (discount > 0) {
      var badge = document.createElement('span');
      badge.className = 'discount-badge';
      badge.textContent = Math.round(discount) + '% OFF';
      card.appendChild(badge);
    }

    var body = document.createElement('div');
    body.className = 'label-body';

    var logo = document.createElement('div');
    logo.className = 'sv-logo';
    logo.innerHTML = SV_LOGO_SVG;
    body.appendChild(logo);

    var brand = document.createElement('div');
    brand.className = 'brand';
    brand.textContent = product.brand || '';
    body.appendChild(brand);

    var goldRule = document.createElement('div');
    goldRule.className = 'gold-rule';
    body.appendChild(goldRule);

    var beerName = document.createElement('div');
    beerName.className = 'beer-name';
    beerName.textContent = product.name || '';
    body.appendChild(beerName);

    if (product.subcategory) {
      var sub = document.createElement('div');
      sub.className = 'subcategory';
      sub.textContent = product.subcategory;
      body.appendChild(sub);
    }

    var bBatchSize = (product['batch_size_(l)'] || product.batch_size_liters || '').trim();
    if (product.time || bBatchSize) {
      var timeRow = document.createElement('div');
      timeRow.className = 'time';
      var timeParts = [];
      if (product.time) timeParts.push(product.time);
      if (bBatchSize) timeParts.push(bBatchSize + 'L');
      timeRow.textContent = timeParts.join(' \u00b7 ');
      body.appendChild(timeRow);
    }

    if (product.abv) {
      var abv = document.createElement('div');
      abv.className = 'abv';
      abv.textContent = product.abv + (product.abv.toLowerCase().indexOf('abv') === -1 ? ' ABV' : '');
      body.appendChild(abv);
    }

    if (product.tasting_notes || product.sku) {
      body.appendChild(buildLabelNotesToggle(product));
    }

    var spacer = document.createElement('div');
    spacer.className = 'notes-spacer';
    body.appendChild(spacer);

    card.appendChild(body);

    var instore = (product.retail_instore || '').trim();
    var kit = (product.retail_kit || '').trim();
    if (instore || kit) {
      card.appendChild(buildLabelPriceFooter(product));
    }

    var reserveWrap = document.createElement('div');
    reserveWrap.className = 'reserve-link';
    var productKey = product.name + '|' + product.brand;
    renderReserveControl(reserveWrap, product, productKey);
    card.appendChild(reserveWrap);

    return card;
  }

  function buildDefaultCard(product) {
    var card = document.createElement('div');
    card.className = 'product-card';
    if (product.sku) {
      card.setAttribute('data-sku', product.sku);
    }

    var header = document.createElement('div');
    header.className = 'product-card-header';

    var cardBrand = document.createElement('p');
    cardBrand.className = 'product-brand';
    cardBrand.textContent = product.brand;
    header.appendChild(cardBrand);

    var cardName = document.createElement('h4');
    cardName.textContent = product.name;
    header.appendChild(cardName);

    card.appendChild(header);

    var batchSize = (product['batch_size_(l)'] || product.batch_size_liters || '').trim();
    if (product.subcategory || product.time || batchSize) {
      var detailRow = document.createElement('div');
      detailRow.className = 'product-detail-row';
      var details = [];
      if (product.subcategory) details.push(product.subcategory);
      if (product.time) details.push(product.time);
      if (batchSize) details.push(batchSize + 'L');
      for (var d = 0; d < details.length; d++) {
        if (d > 0) {
          var sep = document.createElement('span');
          sep.className = 'detail-sep';
          sep.textContent = '\u00b7';
          detailRow.appendChild(sep);
        }
        var detailSpan = document.createElement('span');
        detailSpan.textContent = details[d];
        detailRow.appendChild(detailSpan);
      }
      card.appendChild(detailRow);
    }

    if (product.tasting_notes) {
      var notesWrap = document.createElement('div');
      notesWrap.className = 'product-notes';

      var notesToggle = document.createElement('button');
      notesToggle.type = 'button';
      notesToggle.className = 'product-notes-toggle';
      notesToggle.setAttribute('aria-expanded', 'false');
      notesToggle.innerHTML = 'More Information <span class="product-notes-chevron">&#9660;</span>';

      var notesBody = document.createElement('div');
      notesBody.className = 'product-notes-body';

      if (product.sku) {
        var imageCol = document.createElement('div');
        imageCol.className = 'product-notes-image';
        var img = document.createElement('img');
        setResponsiveImg(img, product.sku);
        img.alt = product.name || 'Product image';
        img.loading = 'lazy';
        img.onerror = function() { this.parentElement.remove(); };
        imageCol.appendChild(img);
        notesBody.appendChild(imageCol);
      }

      var textCol = document.createElement('div');
      textCol.className = 'product-notes-text';
      var notesP = document.createElement('p');
      notesP.textContent = product.tasting_notes;
      textCol.appendChild(notesP);
      notesBody.appendChild(textCol);

      notesToggle.addEventListener('click', function (wrap, toggle, prod) {
        return function () {
          var isOpen = wrap.classList.toggle('open');
          toggle.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
          if (isOpen) {
            trackEvent('detail', prod.sku || '', prod.name || '');
          }
        };
      }(notesWrap, notesToggle, product));

      notesWrap.appendChild(notesToggle);
      notesWrap.appendChild(notesBody);
      card.appendChild(notesWrap);
    }

    var discount = parseFloat(product.discount) || 0;

    if (discount > 0) {
      var badge = document.createElement('span');
      badge.className = 'product-discount-badge';
      badge.textContent = Math.round(discount) + '% OFF';
      card.appendChild(badge);
    }

    var pricingFrom = (product.pricing_from || '').trim().toUpperCase() === 'TRUE';
    var plusSign = pricingFrom ? '+' : '';
    var instore = (product.retail_instore || '').trim();
    var kit = (product.retail_kit || '').trim();
    if (instore || kit) {
      var priceRow = document.createElement('div');
      priceRow.className = 'product-prices';
      if (instore) {
        var instoreBox = document.createElement('div');
        instoreBox.className = 'product-price-box';
        if (discount > 0) {
          var instoreNum = parseFloat(instore.replace(/[^0-9.]/g, ''));
          var instoreSale = formatCurrency(instoreNum * (1 - discount / 100));
          instoreBox.innerHTML = '<span class="product-price-label">Ferment in store</span><span class="product-price-original">' + formatCurrency(instore) + '</span><span class="product-price-value">' + instoreSale + plusSign + '</span>';
        } else {
          instoreBox.innerHTML = '<span class="product-price-label">Ferment in store</span><span class="product-price-value">' + formatCurrency(instore) + plusSign + '</span>';
        }
        priceRow.appendChild(instoreBox);
      }
      if (kit) {
        var kitBox = document.createElement('div');
        kitBox.className = 'product-price-box';
        if (discount > 0) {
          var kitNum = parseFloat(kit.replace(/[^0-9.]/g, ''));
          var kitSale = formatCurrency(kitNum * (1 - discount / 100));
          kitBox.innerHTML = '<span class="product-price-label">Kit only</span><span class="product-price-original">' + formatCurrency(kit) + '</span><span class="product-price-value">' + kitSale + plusSign + '</span>';
        } else {
          kitBox.innerHTML = '<span class="product-price-label">Kit only</span><span class="product-price-value">' + formatCurrency(kit) + plusSign + '</span>';
        }
        priceRow.appendChild(kitBox);
      }
      card.appendChild(priceRow);
    }

    var reserveWrap = document.createElement('div');
    reserveWrap.className = 'product-reserve-wrap';
    var productKey = product.name + '|' + product.brand;
    renderReserveControl(reserveWrap, product, productKey);
    card.appendChild(reserveWrap);

    return card;
  }

  function renderSection(catalog, title, items, extraClass) {
    if (items.length === 0) return;

    var wrapper = document.createElement('div');
    wrapper.className = 'catalog-section' + (extraClass ? ' ' + extraClass : '');

    var sectionHeader = document.createElement('div');
    sectionHeader.className = 'catalog-section-header';

    var sectionHeading = document.createElement('h2');
    sectionHeading.className = 'catalog-section-title';
    sectionHeading.textContent = title;
    sectionHeader.appendChild(sectionHeading);

    if (extraClass === 'catalog-section--order') {
      var note = document.createElement('p');
      note.className = 'process-note';
      note.textContent = 'Allow up to 2 weeks for items to be ordered in.';
      sectionHeader.appendChild(note);
    }

    wrapper.appendChild(sectionHeader);

    // Group by type, ordered by number of products (largest first)
    var groups = {};
    var groupOrder = [];
    items.forEach(function (r) {
      if (!groups[r.type]) {
        groups[r.type] = [];
        groupOrder.push(r.type);
      }
      groups[r.type].push(r);
    });
    groupOrder.sort(function (a, b) { return groups[b].length - groups[a].length; });

    if (catalogViewMode === 'table') {
      groupOrder.forEach(function (type) {
        var group = document.createElement('div');
        group.className = 'product-group';

        var heading = document.createElement('h3');
        heading.className = 'product-group-title';
        heading.textContent = type;
        group.appendChild(heading);

        var table = document.createElement('table');
        table.className = 'catalog-table';
        var thead = document.createElement('thead');
        var sortSelect = document.getElementById('catalog-sort');
        var currentSort = sortSelect ? sortSelect.value : 'name-asc';
        var typeItems = groups[type];
        var kitsCols = [
          { label: 'Name', sort: 'name', field: 'name' },
          { label: 'Brand', sort: 'brand', field: 'brand' },
          { label: 'Style', sort: 'style', field: 'subcategory' },
          { label: 'Time', sort: 'time', field: 'time' },
          { label: 'In-Store Price', sort: 'price', field: 'retail_instore' },
          { label: 'Kit Price', sort: 'price', field: 'retail_kit' },
          { label: '', sort: 'reserved', field: null }
        ];
        // Determine which columns have data in this group
        var visibleCols = kitsCols.filter(function (col) {
          if (!col.field) return true; // always show (Name, Reserve)
          if (col.field === 'name') return true; // always show Name
          return typeItems.some(function (p) { return (p[col.field] || '').trim() !== ''; });
        });
        var visibleFields = {};
        visibleCols.forEach(function (col) { visibleFields[col.field || col.label] = true; });

        var theadTr = document.createElement('tr');
        visibleCols.forEach(function (col) {
          var th = document.createElement('th');
          th.textContent = col.label;
          if (col.field === 'retail_instore' || col.field === 'retail_kit') th.style.textAlign = 'right';
          if (col.sort) {
            th.setAttribute('data-sort', col.sort);
            var arrow = document.createElement('span');
            arrow.className = 'sort-arrow';
            var sortBase = currentSort.replace(/-asc$|-desc$/, '');
            if (sortBase === col.sort) {
              th.classList.add('sort-active');
              arrow.textContent = currentSort.indexOf('-desc') !== -1 ? '\u25BC' : '\u25B2';
            } else {
              arrow.textContent = '\u25B2';
            }
            th.appendChild(arrow);
            th.addEventListener('click', (function (sortKey) {
              return function () {
                var sel = document.getElementById('catalog-sort');
                if (!sel) return;
                var cur = sel.value;
                var base = cur.replace(/-asc$|-desc$/, '');
                if (base === sortKey) {
                  sel.value = sortKey + (cur.indexOf('-asc') !== -1 ? '-desc' : '-asc');
                } else {
                  sel.value = sortKey + '-asc';
                }
                userHasSorted = true;
                applyFilters();
              };
            })(col.sort));
          }
          theadTr.appendChild(th);
        });
        thead.appendChild(theadTr);
        table.appendChild(thead);

        var tbody = document.createElement('tbody');
        typeItems.forEach(function (product) {
          var tr = document.createElement('tr');
          var tint = getTintClass(product);
          if (tint) tr.className = tint;
          var discount = parseFloat(product.discount) || 0;
          var pricingFrom = (product.pricing_from || '').trim().toUpperCase() === 'TRUE';
          var plusSign = pricingFrom ? '+' : '';

          // Name + badge
          var tdName = document.createElement('td');
          tdName.setAttribute('data-label', 'Name');
          var nameSpan = document.createElement('span');
          nameSpan.className = 'table-name';
          nameSpan.textContent = product.name || '';
          tdName.appendChild(nameSpan);
          if (discount > 0) {
            var badge = document.createElement('span');
            badge.className = 'discount-badge-sm';
            badge.textContent = Math.round(discount) + '% OFF';
            tdName.appendChild(badge);
          }
          tr.appendChild(tdName);

          // Brand
          if (visibleFields['brand']) {
            var tdBrand = document.createElement('td');
            tdBrand.setAttribute('data-label', 'Brand');
            tdBrand.textContent = product.brand || '';
            tr.appendChild(tdBrand);
          }

          // Style (subcategory)
          if (visibleFields['subcategory']) {
            var tdStyle = document.createElement('td');
            tdStyle.setAttribute('data-label', 'Style');
            tdStyle.textContent = product.subcategory || '';
            tr.appendChild(tdStyle);
          }

          // Time
          if (visibleFields['time']) {
            var tdTime = document.createElement('td');
            tdTime.setAttribute('data-label', 'Time');
            tdTime.textContent = product.time || '';
            tr.appendChild(tdTime);
          }

          // In-Store price
          if (visibleFields['retail_instore']) {
            var tdInstore = document.createElement('td');
            tdInstore.setAttribute('data-label', 'In-Store');
            var instore = (product.retail_instore || '').trim();
            if (instore) {
              tdInstore.className = 'table-prices';
              if (discount > 0) {
                var instoreNum = parseFloat(instore.replace(/[^0-9.]/g, ''));
                var instoreSale = formatCurrency(instoreNum * (1 - discount / 100));
                tdInstore.innerHTML = '<span class="table-price-original">' + formatCurrency(instore) + '</span><span class="table-price-sale">' + instoreSale + plusSign + '</span>';
              } else {
                tdInstore.textContent = formatCurrency(instore) + plusSign;
              }
            }
            tr.appendChild(tdInstore);
          }

          // Kit price
          if (visibleFields['retail_kit']) {
            var tdKit = document.createElement('td');
            tdKit.setAttribute('data-label', 'Kit');
            var kit = (product.retail_kit || '').trim();
            if (kit) {
              tdKit.className = 'table-prices';
              if (discount > 0) {
                var kitNum = parseFloat(kit.replace(/[^0-9.]/g, ''));
                var kitSale = formatCurrency(kitNum * (1 - discount / 100));
                tdKit.innerHTML = '<span class="table-price-original">' + formatCurrency(kit) + '</span><span class="table-price-sale">' + kitSale + plusSign + '</span>';
              } else {
                tdKit.textContent = formatCurrency(kit) + plusSign;
              }
            }
            tr.appendChild(tdKit);
          }

          // Add to Cart
          var tdReserve = document.createElement('td');
          tdReserve.setAttribute('data-label', '');
          var productKey = product.name + '|' + product.brand;
          renderReserveControl(tdReserve, product, productKey);
          tr.appendChild(tdReserve);

          // Mobile summary cells (hidden on desktop, shown on mobile via CSS)
          var metaParts = [];
          if (visibleFields['brand'] && (product.brand || '').trim()) metaParts.push(product.brand.trim());
          if (visibleFields['subcategory'] && (product.subcategory || '').trim()) metaParts.push(product.subcategory.trim());
          if (visibleFields['time'] && (product.time || '').trim()) metaParts.push(product.time.trim());
          var tdMobileMeta = document.createElement('td');
          tdMobileMeta.className = 'table-mobile-meta';
          if (metaParts.length) tdMobileMeta.textContent = metaParts.join(' \u00B7 ');
          tr.appendChild(tdMobileMeta);

          var priceHtmlParts = [];
          var mInstore = (product.retail_instore || '').trim();
          var mKit = (product.retail_kit || '').trim();
          if (mInstore) {
            var mInstoreNum = parseFloat(mInstore.replace(/[^0-9.]/g, ''));
            if (discount > 0 && mInstoreNum) {
              var mInstoreSale = formatCurrency(mInstoreNum * (1 - discount / 100));
              priceHtmlParts.push('<span class="mp-label">In-store</span> <span class="table-price-original">' + formatCurrency(mInstore) + '</span> <span class="table-price-sale">' + mInstoreSale + plusSign + '</span>');
            } else {
              priceHtmlParts.push('<span class="mp-label">In-store</span> ' + formatCurrency(mInstore) + plusSign);
            }
          }
          if (mKit) {
            var mKitNum = parseFloat(mKit.replace(/[^0-9.]/g, ''));
            if (discount > 0 && mKitNum) {
              var mKitSale = formatCurrency(mKitNum * (1 - discount / 100));
              priceHtmlParts.push('<span class="mp-label">Kit</span> <span class="table-price-original">' + formatCurrency(mKit) + '</span> <span class="table-price-sale">' + mKitSale + plusSign + '</span>');
            } else {
              priceHtmlParts.push('<span class="mp-label">Kit</span> ' + formatCurrency(mKit) + plusSign);
            }
          }
          var tdMobilePrices = document.createElement('td');
          tdMobilePrices.className = 'table-mobile-prices';
          if (priceHtmlParts.length) tdMobilePrices.innerHTML = priceHtmlParts.join(' <span class="mp-sep">\u00B7</span> ');
          tr.appendChild(tdMobilePrices);

          // Add expand chevron to name cell
          var chevron = document.createElement('span');
          chevron.className = 'table-expand-chevron';
          chevron.innerHTML = '&#9660;';
          tdName.insertBefore(chevron, tdName.firstChild);

          // Build detail row
          var detailTr = document.createElement('tr');
          detailTr.className = 'table-detail-row';
          var detailTd = document.createElement('td');
          detailTd.setAttribute('colspan', String(visibleCols.length + 2));
          detailTd.className = 'table-detail-cell';

          var detailContent = document.createElement('div');
          detailContent.className = 'table-detail-content';

          if (product.sku) {
            var detailImg = document.createElement('div');
            detailImg.className = 'table-detail-image';
            var img = document.createElement('img');
            setResponsiveImg(img, product.sku);
            img.alt = product.name || 'Product image';
            img.loading = 'lazy';
            img.onerror = function() { this.parentElement.remove(); };
            detailImg.appendChild(img);
            detailContent.appendChild(detailImg);
          }

          var detailText = document.createElement('div');
          detailText.className = 'table-detail-text';

          if (product.tasting_notes) {
            var notesP = document.createElement('p');
            notesP.className = 'table-detail-notes';
            notesP.textContent = product.tasting_notes;
            detailText.appendChild(notesP);
          }

          if (product.description && !product.tasting_notes) {
            var descP = document.createElement('p');
            descP.className = 'table-detail-notes';
            descP.textContent = product.description;
            detailText.appendChild(descP);
          }

          var detailTraitBody = (product.body || '').trim();
          var detailTraitOak = (product.oak || '').trim();
          var detailTraitSweet = (product.sweetness || '').trim();
          if (detailTraitBody || detailTraitOak || detailTraitSweet) {
            var traitParts = [];
            if (detailTraitBody) traitParts.push('<strong>Body:</strong> ' + escapeHTML(detailTraitBody));
            if (detailTraitOak) traitParts.push('<strong>Oak:</strong> ' + escapeHTML(detailTraitOak));
            if (detailTraitSweet) traitParts.push('<strong>Sweetness:</strong> ' + escapeHTML(detailTraitSweet));
            var traitsP = document.createElement('p');
            traitsP.className = 'table-detail-traits';
            traitsP.innerHTML = traitParts.join(' \u00B7 ');
            detailText.appendChild(traitsP);
          }

          var detailMeta = [];
          if (product.abv) detailMeta.push(product.abv + (product.abv.toLowerCase().indexOf('abv') === -1 ? ' ABV' : ''));
          var detailBatch = (product['batch_size_(l)'] || product.batch_size_liters || '').trim();
          if (detailBatch) detailMeta.push(detailBatch + 'L batch');
          if (detailMeta.length) {
            var metaP = document.createElement('p');
            metaP.className = 'table-detail-meta';
            metaP.textContent = detailMeta.join(' \u00B7 ');
            detailText.appendChild(metaP);
          }

          detailContent.appendChild(detailText);
          detailTd.appendChild(detailContent);
          detailTr.appendChild(detailTd);

          // Only add detail row if there's content
          if (detailContent.children.length > 0 && detailText.children.length > 0) {
            tbody.appendChild(tr);
            tbody.appendChild(detailTr);

            // Click to toggle
            (function(mainRow, detail, chev) {
              var skipClick = false;
              mainRow.addEventListener('mousedown', function(e) {
                if (e.target.closest('.product-reserve-wrap')) skipClick = true;
              });
              mainRow.style.cursor = 'pointer';
              mainRow.addEventListener('click', function(e) {
                if (skipClick) { skipClick = false; return; }
                if (e.target.closest('.product-reserve-wrap')) return;
                var isOpen = detail.classList.toggle('open');
                chev.classList.toggle('open', isOpen);
                mainRow.classList.toggle('expanded', isOpen);
                if (isOpen) {
                  trackEvent('detail', product.sku || '', product.name || '');
                }
              });
            })(tr, detailTr, chevron);
          } else {
            tbody.appendChild(tr);
          }
        });
        table.appendChild(tbody);
        group.appendChild(table);
        wrapper.appendChild(group);
      });
    } else {
      groupOrder.forEach(function (type) {
        var group = document.createElement('div');
        group.className = 'product-group';

        var heading = document.createElement('h3');
        heading.className = 'product-group-title';
        heading.textContent = type;
        group.appendChild(heading);

        var grid = document.createElement('div');
        grid.className = 'product-grid';

        groups[type].forEach(function (product) {
          var productType = (product.type || '').toLowerCase();
          var card;
          if (productType.indexOf('wine') !== -1) {
            card = buildWineCard(product);
          } else if (productType.indexOf('beer') !== -1) {
            card = buildBeerCard(product);
          } else {
            card = buildDefaultCard(product);
          }
          grid.appendChild(card);
        });

        group.appendChild(grid);
        wrapper.appendChild(group);
      });
    }

    catalog.appendChild(wrapper);
  }
}
