!function(){"use strict";var t="",e="",n="";function a(){if(n="undefined"!=typeof SHEETS_CONFIG&&SHEETS_CONFIG.ADMIN_API_URL||""){var a=new URLSearchParams(window.location.search);t=a.get("id")||"",e=a.get("token")||"",t&&e?(o(),setInterval(function(){o()},6e4)):d()}else d("Configuration error")}function o(){var a=n+"?action=get_batch_public&batch_id="+encodeURIComponent(t)+"&token="+encodeURIComponent(e);fetch(a).then(function(t){return t.json()}).then(function(a){a.ok?function(a){var c=a.batch,d=a.tasks||[],r=a.plato_readings||[],i=a.vessel_history||[];document.getElementById("batch-loading").style.display="none",document.getElementById("batch-content").style.display="";var l={primary:"primary",secondary:"secondary",complete:"complete",disabled:"disabled"},u={primary:"Primary Fermentation",secondary:"Secondary Fermentation",complete:"Complete",disabled:"Disabled"},h=String(c.status||"").toLowerCase(),m=document.getElementById("batch-status-badge");m.textContent=u[h]||h,m.className="batch-hero-status batch-hero-status--"+(l[h]||"gray"),document.getElementById("batch-title").textContent=c.batch_id,document.getElementById("batch-product").textContent=c.product_name||"",document.getElementById("batch-customer").textContent=c.customer_name||"",document.getElementById("batch-start-date").textContent=c.start_date?"Started: "+c.start_date:"",document.getElementById("batch-vessel").textContent=c.vessel_id||"—",document.getElementById("batch-shelf").textContent=c.shelf_id||"—",document.getElementById("batch-bin").textContent=c.bin_id||"—",function(a){var c=document.getElementById("batch-tasks-list");if(!a.length)return void(c.innerHTML='<p class="batch-empty">No tasks scheduled.</p>');var d=(new Date).toISOString().substring(0,10),r="";a.forEach(function(t){var e="TRUE"===String(t.completed).toUpperCase(),n="TRUE"===String(t.is_packaging).toUpperCase(),a=t.due_date||(n?"TBD":"—"),o="batch-task";e&&(o+=" batch-task--done"),!e&&t.due_date&&t.due_date<d&&(o+=" batch-task--overdue"),r+='<div class="'+o+'">',r+='<label class="batch-task-label">',r+='<input type="checkbox" class="batch-task-checkbox" data-task-id="'+t.task_id+'" '+(e?"checked":"")+">",r+='<span class="batch-task-title">'+(t.title||"Step "+t.step_number)+"</span>",r+="</label>",r+='<span class="batch-task-due">'+a+"</span>",t.description&&(r+='<p class="batch-task-desc">'+t.description+"</p>"),r+="</div>"}),c.innerHTML=r,c.querySelectorAll(".batch-task-checkbox").forEach(function(a){a.addEventListener("change",function(){var c,d,r;c=a.getAttribute("data-task-id"),d=a.checked,r={action:"update_batch_task",batch_token:e,batch_id:t,task_id:c,updates:{completed:d}},fetch(n,{method:"POST",headers:{"Content-Type":"text/plain"},body:JSON.stringify(r)}).then(function(t){return t.json()}).then(function(t){t.ok?(s("Task "+(d?"completed":"unchecked"),"success"),o()):s("Failed: "+(t.message||t.error),"error")}).catch(function(t){s("Failed: "+t.message,"error")})})})}(d),function(t,e){var n=document.getElementById("batch-plato-chart"),a=document.getElementById("batch-plato-list");if(!t||0===t.length)return n.innerHTML="",void(a.innerHTML='<p class="batch-empty">No readings yet.</p>');t.length>=2?n.innerHTML=function(t,e){var n=400,a=150,o=30,c=e?new Date(e):new Date(t[0].timestamp),s=t.map(function(t){var e=new Date(t.timestamp);return{day:Math.round((e-c)/864e5),plato:Number(t.degrees_plato)}}),d=Math.max.apply(null,s.map(function(t){return t.day}))||1,r=Math.max.apply(null,s.map(function(t){return t.plato}))||1,i=Math.min.apply(null,s.map(function(t){return t.plato})),l=r-i||1,u=s.map(function(t){return o+t.day/d*(n-2*o)+","+(a-o-(t.plato-i)/l*(a-2*o))}).join(" "),h=s.map(function(t){return'<circle cx="'+(o+t.day/d*(n-2*o))+'" cy="'+(a-o-(t.plato-i)/l*(a-2*o))+'" r="3" fill="#5b7f3b"/>'}).join(""),m='<svg viewBox="0 0 '+n+" "+a+'" class="batch-plato-svg">';return m+='<line x1="'+o+'" y1="'+(a-o)+'" x2="'+(n-o)+'" y2="'+(a-o)+'" stroke="#ccc"/>',m+='<line x1="'+o+'" y1="'+o+'" x2="'+o+'" y2="'+(a-o)+'" stroke="#ccc"/>',m+='<text x="'+o+'" y="'+(a-5)+'" font-size="10" fill="#999">Day 0</text>',m+='<text x="'+(n-o)+'" y="'+(a-5)+'" font-size="10" fill="#999" text-anchor="end">Day '+d+"</text>",m+='<text x="5" y="'+(o+4)+'" font-size="10" fill="#999">'+r.toFixed(1)+"</text>",m+='<text x="5" y="'+(a-o)+'" font-size="10" fill="#999">'+i.toFixed(1)+"</text>",m+='<polyline points="'+u+'" fill="none" stroke="#5b7f3b" stroke-width="2"/>',m+=h,m+="</svg>"}(t,e):n.innerHTML="";var o='<table class="batch-readings-table"><thead><tr><th>Date</th><th>&deg;P</th><th>Notes</th></tr></thead><tbody>';t.slice().reverse().forEach(function(t){o+="<tr><td>"+(t.timestamp||"").substring(0,10)+"</td><td>"+t.degrees_plato+"</td><td>"+(t.notes||"")+"</td></tr>"}),o+="</tbody></table>",a.innerHTML=o}(r,c.start_date),c.notes&&(document.getElementById("batch-notes-card").style.display="",document.getElementById("batch-notes").textContent=c.notes);i.length>0&&(document.getElementById("batch-history-card").style.display="",function(t){var e=document.getElementById("batch-vessel-history"),n="";t.forEach(function(t){n+='<div class="batch-vh-entry">',n+="<strong>"+(t.transferred_at||"").substring(0,10)+"</strong> ",n+="V:"+(t.vessel_id||"?")+" S:"+(t.shelf_id||"?")+" B:"+(t.bin_id||"?"),t.notes&&(n+=" — "+t.notes),n+="</div>"}),e.innerHTML=n}(i))}(a.data):d(a.message)}).catch(function(t){d(t.message)})}var c=null;function s(t,e){var n=document.getElementById("batch-toast-container");if(n){var a=document.createElement("div");a.className="batch-toast batch-toast--"+(e||"info"),a.textContent=t,n.appendChild(a),setTimeout(function(){a.classList.add("removing"),setTimeout(function(){a.parentNode&&a.parentNode.removeChild(a)},200)},3e3)}}function d(t){document.getElementById("batch-loading").style.display="none";var e=document.getElementById("batch-error");e.style.display="",t&&(e.querySelector("p").textContent=t)}document.addEventListener("DOMContentLoaded",function(){a(),(c=document.getElementById("plato-add-btn"))&&c.addEventListener("click",function(){var a=parseFloat(document.getElementById("plato-value").value);if(isNaN(a)||a<0||a>40)s("Enter a valid Plato value (0-40)","error");else{var c={action:"add_plato_reading",batch_token:e,batch_id:t,degrees_plato:a,notes:document.getElementById("plato-notes").value};fetch(n,{method:"POST",headers:{"Content-Type":"text/plain"},body:JSON.stringify(c)}).then(function(t){return t.json()}).then(function(t){t.ok?(s("Reading recorded","success"),document.getElementById("plato-value").value="",document.getElementById("plato-notes").value="",o()):s("Failed: "+(t.message||t.error),"error")}).catch(function(t){s("Failed: "+t.message,"error")})}})})}();